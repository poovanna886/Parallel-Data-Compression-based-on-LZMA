Ubuntu Server Guide
Copyright © 2012 Contributors to the document
Abstract
Welcome to the ! It contains information on how to install and configure various server
applications on your Ubuntu system to fit your needs. It is a step-by-step, task-oriented guide foring
and customizing your system.
Credits and License
This is maintained bydocumentation team (https://wiki.ubuntu.com/DTeam). A list of cis
below.de available under the Creative Commons ShareAlike 3.0 License (CC-BY-SA).
You are free to modify, extend, and improvesource codterms of this license. All derivative works
must be releasedation is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty
of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE AS DESCRIBED IN THE DISCLAIMER.
A copy of the license ishere:License
1
.
are:
• Members of Project
2Server Team
3
•Ubuntu Wiki
4
• Othercan be founrevision historserverguide
5
 and ubuntu-docs
6
 bzr brancheon Launchpad.
1
http://creativecommons.org/licenses/by-sa/3.0/
2
https://lnet/~ubuntu-core-doc
3server
4helpcommunity/
5code.6iii
Table of Contents
1. Introduction . 1
1. Support 2
2. Installa.. 3
1. Preparing to Install 4ing from CD6
3. Upgrading 9
4. Advanced 10
5. Kernel Crash Dump 17
3. Package Managemen 20 21
2. dpk...... 22
3. Apt-Ge 23
4. Aptitude 25
5. Automatic Updates 27
6. Configur 29
7. Referenc 31
4. Network.... 32
1 33
2. TCP/IP 42
3. Dynamic HostProtocol (DHCP) 46
4. Time Synchronisation with NT 49
5. DM-Multipath51
1. Device Mapper  52
2. Devi 55
3. Setting upOverview 58
4. TheFil 62Administration and Troubleshoot 74
6. Remote  79
1. OpenSSH Server 80
2. Pupp. 83
3. Zentya 86
7. Network Authentic 90
1. OpenLDAP 91
2. Samba and LDA 117
3. Kerbero 123
4 131
8. Domain Name Service (DNS 138
1. 139
2. 140
3. 146iv
4. 150
9. Security.... 151
1. User 152
2. Console 158
3. Firew59
4. AppArmo........ 166
5. Certific 170
6. eCryptf. 175
10. Monitor 177
1.  178
2. Nagi... 179
3. Muni 183
11. Web Server85
1. HTTPD - Apache2 186
2. PHP5 - Scripting Languag 194
3. Squid - Proxy 196
4. Ruby on Rail 198
5. Apache Tomca 200
12. Databas...... 204
1. MySQL205
2. Postgre 210
13. LAMP A 212213
2. Moin Mo 214
3. MediaWiki 216
4. phpMyAdm 218
14. File. 220
1. FT 221
2.File System (NF 225
3. iSCSI Initiat 227
4. CUPS - Print. 230
15. Email Ser33
1. Postfix 234
2. Exim4 241
3. Doveco........ 244
4. Mailma 246
5. Mail Filte 252
16. Chat... 25960
2. IRC.... 261
3. Jabber Instant Messaging 263
17. Version Control System 265v
1. Bazaa...... 266
2. Subvers 267
3. CVS 272274
18. Windows 275
1. 276
2. Samba 277
3. Samba.. 280
4. Securing aand 282
5. Samba as a Domaile 287
6. Samba Active Directory Integ 291
19. Backup...... 293
1. Shell Script 294
2. Archive Rot298
3. Bacula301
20. Virtualiz. 306
1. libvi 307
2. JeOS and vmbuild... 312
3. Ubuntu Cloud 321
4. LXC 328
21. Clus51
1. DRB52
22. VPN....... 355
1. Open 356
23. Other Useful 368
1. pam_mot..... 369
2. etckeep. 371
3. Byobu73375
A. Append... 376
1. Reporting Bugs inEdit 377vi
List of Tables
2.1. Recommended Minimum Requiremen 4
5.1. Priority Checker Con 52
5.2.mpon53
5.3. Defaul 66
5.4Attribu.... 69
5.5. Device .... 71
5.6. Useful mCommand Option 77
17.1. Access Method 268
20.1. Container comman 3411
Chapter 1.
Here you can find i .  andThis guide assumes you have a basic understanding of. Some idetails
are covered in Chapter 2,[p. 3], but if you need detailed instructions installing
Ubuntu please refer tGuide
1
.
A HTML version of the manualonline atwebsite
2
.
112.10/-guide
2
1. Support
There are a couple of different ways thatis supported, commercial support
and  support. The main (and development funding)from
Canonical Ltd. They supply reasonably priced support contracts on a per desktop or per server basis.
For moresee the Services
3
 page.
Communityis also provided by dedicated individuals, and companies, that wish to make
Ubuntu the bestion possible isthrough multiple mailing lists, IRC
channels, forums, blogs, wikis, etc. The large amount ofcan be overwhelming,
but a good search engine query can usually provide an answer to your questions. See
Support
4
 page f.
3
http://www.canonical.com/services/ssupport32.
This chapter provides a quick overview of Ubuntu 12.10 Server Edition. detailed
i, 
4
1. 
This section explainsaspects to consider before starting the .
1.1. Syste
 supports three (3) major architectures: Intel x86, AMD64 and ARM. The
table below lists rhardware specifications. Depending on, you might manage
with less than this. However, most users risk being frustrated if they ignore these suggestions.
Table 
Hard Drive Space
Install Type CPU RAM
Base System All Tasks Installed
Server (Standard) 1 gigahertz 512 megabytes 1 gigabyte 1.75sMinimal) 300 megahertz 256700.4Thecommon base for all sorts of server minimalist
design providing a platform for the desired services, such as file/printweb hosting, email
tc.
1.2. Server and Desktop Differencesfewces betweenandDesktopIt
should be noted that both editions use the same apt repositories, making it just as easy t
 on theEdition as it is on t.
Thetwoare the lack of an X window environment i
nd the process.
1.2.1. Kernel:
Ubuntu10.10 and prior, actually hadkernelssdesktop.
Ubuntu no longer has separate --generic kernel flavors. These have been merged into a
single  to help reduce the maintenance burden over the life of the release.
When running a 64-bitUbuntu on 64-bit processors you are not limited by
memory addressing space.
To see all kernel cooptionslook through /boot/config-3.5.0-server. Also,
Linux Kernel in a Nutshell
2
 is a great resource on the options .
2kroah.com/lkn/5
1.3. Backing Up
• Before installingyou should make sure all data on the system is backed up.
See19,[p. 293] for backup options.
If this is not the first time an operating system has been installed on your computer, it is likely you
will need to re-partition your disk to make room for Ubuntu.
Any time you , be prepared to lose everything on the disk should you
make a mistake or something goes wrong duringing. The programs used iation are
quite reliable, most have seen years of use, but they also perform destructive actions.6
ing from CD
The basic steps Edition from CD are the same as those forany
from CD. Unlike the, thedoes not include a
graphical installation program. uses a console menu based process instead.
• First, download and burn the appropriate ISO file from the  Ubuntu web site
3
.
• Boot the systemCD-ROM drive.
• At the boot prompt youasked to select a language.
• From the main boot menu there are some additional. You
ca a basic, check the CD-ROM for defectssystem's RAM, boot
from first hard disk, or rescue a broken system. The rest of twill c
Serve.
• Ther asks for which it should use. Afterwards,your
location.
• Next, tcess begins by asking for your keyboard layout. You can asker
to attempt auto-detecting it, or you can select it manually from a listthen discovers your , andes the network settings using
DHCP. If you do notuse DHCP at the next screen choose "Go Back", and you have the
option to "Configuremanually"ethe hostname and Time Zone.
•thfrom severchard drive you
are askeddisk to. You may get confirmmpts before rewriting the
table or seLVM ddiskIf you choose LVM,
the size of the root logical volume. For advanced disksee Section 4, “Advanced
” [p. 10].
• The Ubuntu base th.
• A new user is set up; this user will have root access through the sudo utility.
• After the usescompleted encrypt your home directory.
• The next step in thecess is to decide how you want to update the re are
three options:
• No automatic updates: this requires an aor to log into the machine andinstall
updates.
• Install security updatesally: this wil the unattended-upgrades package, which
without the intervention of.s see
Section 5, “” [p. 27].
• Manag with Landscape: is a paid service prto help
manage your Ubuntu machine
4
 site for details.download/server/download
4projects/landscape7
• You now install, or not several package tasks. S2.1, “Package
Tasks” [p. 7] Also, there is anlaunch aptitude to choose specific
packages isptitude” [p. 25].
• Finally, the last stepbooting is to set the clock to UTC.
If at any point duringyou are not satisfied by the default setting, use the "Go
Back" functionrompt to be brought to a detallation menu that will allow
you to modifs.
At sometheyou mayread the help screenthe
io do this, press F1.
Once again,ed inssee the Guide
5
.
2.1. Package Tasks
During the option from the
CD. The are grouptype ofthey provide.
• DNS server: Selects the BIND and its d.
• LAMPa ready-made Linux/Apache/MySQL/PHP server.
• MailThis task selects a variety ofuseful for a general purpose m system.
•needed for an.
•database: client and serverfor the.
• Printts up your system to be a p.
• serverSamba file server, which is especially
suitable in networks with bothand Linux systems.
• Tomcat JavaInstalls and needed dependencies.
• Virtual Machine host: Includs needed to run KVM virtual
• Manually select: Executes allowing you to individ.
Installing t groups is accomplished using the tasksel One of the important
d between Ubuntu (or Debian) and other GNU/Linux distribution is that, when installed, a
package is alsod to reasonable defaults, eventmpting you for required
i. Likewiseing a task,s are not onlybut
toa fully integrated service.
Once the iprocess has finished you can view a list of tasks by entering the
following from a terminal prompt:
tasksel --list-tasks
58
The output will list tasks from otherds such as Kubuntu and
Edubuntu. Note thatalso invoke command by itself, which will bring up
a menu of the dtasks.
Ywhichinstalled with each task--task-option.
For example, to listthe DNtask enter the dns-serverof the command should list:
bind9-doc 
bind9utils 
bind9
If you did otasks di, but f you decide to
make your new as well, simply insert CD and from a
terminal:
sudo tasksel install 9
3. several ways to upgrade from one Ubuntu release to another. This section gives an overview
of the recommendedmethod.
3.1. do-release-upgrade
Twayais toutility. Part of the update-manager-core it does not have any  and is
by default.
Debian based systems can also be upgraded by using apt-get dist-upgrade.using do isbecause it has the ability to handle systemation changes
sometimes neededreleases.
Tto a newer release, enter:
It is also possible to useto a dveUbuntu. To
 this-d switch -d
release is notfor pre10
4. 
4.1. Software RAID
Redundant Array of Independent Disks "RAID" is a method of using disks to providet balances of increasing data reliability and/orinput/output performance, depending
on the RAID level being used. RAID is implemented in either software (where the 
knows about both drives and actively maintains both of them) or harda special controller
makes the OS think there's only one drive andthe drives 'invisibly').
The RAIDincluded with current versions of Linux (and Ubuntu) is based on the 'mdadm'
driver and works very well, better even than many so-called 'hardware' RAIDs
will guide you through iusing two RAID1 partitions on two physical
hard drives, one for / and another for swap.
4.1.1. Partitioning
Follow the isteps until you get to the disks step, then:
1. Select Manual as the method.
2the rive, and agree to "Create a new emptytable on this device?".
Repeat this step for each drive you wish to be pRAID array.
3"FREE SPACE" on drive then select".
4. Next, select the S. Thiswill be the swap, and a general
rule size is twice that of RAM. Enter size, then choose Primary, then
Beginning.
A size ofe RAM capacity may not always be
desirable, e on systems with lasCalculatingsize for servers is highly on how the going to be used.
5Use as:" line at the top. By default this is "Ext4 journaling file system", change that to
"physi for RAID" then "Done se6. For the /o select "Free Space7. Use the rest of the free space on thechoose Continue, then Primary.
8. As with the", changing it to 
. Also "Bootable flag:" line toe value to "on". Th"Done
9. Repeat steps three through eight for the other disk and.
4.1.2. RAID 
With thesetup the arrays are ready to beed:11
1. Back in the main " Disks" page""yes" to write the changes to disk.
3. ChooseMD device".
4. For thisselect "RAID1", but if you are using a setup choose the 
type (RAID0 RAID1 RAID5).
In order to use RAID5 you need at least three drives. Using RAID0 or RAID1 only two
drives are required.
5.number of active devices "2", or the  you have,array.
Thontinue".
6. Next,spar0" , tC7whichto use. Generally they will be sda1, sdb1, sdc1, etc. The numbers will
usually match and theletters correspond to.
For the choose sda1 and sdb" to go to the next step.
8.sevenchoosing sda2 and sdb2.
9. Once done select "Finish".
4.1.3. Formatting
There should now be aand RAID devices.s to format and set the
mount poinreat the as a local ,mount
accordingly."#1" under the "RAID1 device #0".
2. swap area", th3.14.
5the "M" and choose "/ - the root. Change any of the other
options as , thinally,ing and write".
to place on a RAID array, the installer will then ask if you would like
to boot in a degraded state.4.1.4, “Degraded RAID” [p. 11] for further details.
Tation processcontinue normally.
4.1.4. in the lcomputer a disk failure event may occur. When this happens, using
, the willarray into what is known as2
If the array has become, due to the chance of data corruption, will boot to initramfs after thirty seconds. itramfs has booted there is a fifteen
second prompt giving you the go ahead and boot the system, or attempt manual recover.
Booting to theprompt may orbe the desired behavior,if the machine is
in a remote location. array can  several ways:
• The dpkg-reconfigure utilitused to the defaultand process
youqueried about settings related to . Such as monitoring, email alerts,
etc. To mdadmfollowing:
sudomdadmmdadmchange the /etc/-tools/conf.d/mdadm
cofile. The filedvantage of being able to pre-'s
and manually edited:
BOOT_DEGRADED=true
Theation file can be overridden  Kernel argument.
• Using a will alltoas well:
• When the server is booting press Shift to open the Grub menu.
• Press e to edit yourmmand optionsthe down arrow to highlight the kernel line.
• Add "bootdegraded=true" (without the quotes) to the end of thePress Ctrl+x he system.systemyou can either repair the array see .1.5, “RAID
Maintenance” [p. 12, or copy  data to anotherdue to major
hardware failure.
4.1.5. RAID 
The mdadmview the status of an array, add remove disks, etc:
• To  enter:
sudo mdadm -D /dev/md0
The -D tells mdadm to display detailed iabout the device. Replac
. disk inE /dev/sda13
The output if very similar to t-D command, adjust isk.
• If s and needs to be removed from-remov
Changandto the  and disk.
• Similarly, to add a new disk-addSa disk can change to a faulty state even though there is nothing physically wrong with
the drive. It is usually worthwhile to remove  from the array then re-add it. This will cause to re-sync rray. Ifwill not , it is a good indication ofThe /proc/mdstat file also contains usefulsystem's:
cat
Personalities : [linear] [] [raid0] [raid1] [raid6] [raid5] [raid4] [raid10] 
md0 : active raid1 sda1[0] sdb1[1]
      10016384 blocks [2/2] [UU]
      
unused devices: <none>
The  command is great for watching the syncing drive:
watch -n1 rc to stop the watch command.o need to replacedrive, adrive has been replaced and synced, grub will need
to be installed. To install grub on the new drive,grub-installarray device name.
4.1.6. Resources
The topic ofs is a complex one plethora of ways RAID .
Please see tlinks for more:
• Ubuntu Wiki Articles on RAID
6
.
6community#raid4
• HOWTO
7
• Managing RAID on Linux
8
4.2. Logical Volume Manager (LVM)
ger, or LVM, allows as to create ls out of one or
hard disks. LVM volumesreated on both RAIDs and
standardresiding on a single disk. Valso be extended, giving greater flexibility
to systems as rchange.
4.2.1.
A side effect of LVM's power and is adegree of complication. Before diving into
the LVM iprocess, it is best to get familiar with some terms.
• Phys(PV): , disk or formatted as
LVM PV.
• Volume Group (VG): is made or morevolumes. A VG can can by
adding more PVs. A VG is like adisk drive, from which one or moreare
carved.
•(LV): is ain a non-LVM system. A LV iswith the
desired  (EXT3, XFS, JFS, etc), it is then for mounting and data storage.
4.2.ation
As an example this section covers installing Edition with /srv mounted on a LVM
volume. initial install only one will be pa
(VG). Another PVadded afterto demonstrate how a VG.
There are severation options for LVM, "Guided - use the entire disk and setup LVM" also allow you to assign a portion of the space toentire
encrypted LVM", ortup the LVM. At this time the only way toe a system with both LVM and , , is toManual
approach.
1. 2. At the Manual". and on the nyes" toa n
on this devicecreate/boot, swap, and s with whichever filesystem you prefer.
5.LVM /srv, create a new. Then change "Use as" to 
LVM" then ".
7faqs.org/docs/Linux-HOWTO/Software-RAID-HOWTO.html
8
http://oreilly.com/catalog/978156592730815
6. Now select " at the top, and choose "Ye
changes to disk.
7"LVMation action",Create volume group". Enter a
name for the VG such as vg01, or somethdescriptive. After entering a namthed8. Back at the screen,r". S
newly created, and enter a new LV, forsrv since that is the
intended mooose a size, which may be the fullbecause it can always
 later.Finish" and you should be bmain" screen.
9. Now add ato the new LVMunder "LVM VG vg01, LV srv", or
whatever name chosen, the choose Use as. Setup aas normal selecting /srv
as thethe".
10.sing and  Then confirm the changes and
continue rest of the iome useful utilities to view iLVM:
• pvdisplay: showss.
• vgs.
• ls.
4.2.3. Extendings
Continuing with srv as an LVM volume adding a second
creating a, adding it to the (VG), ethe
srv and finally. Thisassumesadded to
the system. In t, thisnamed /dev/sdb and we wills a
(you could choose to createuse them as ds)
Myou don't already have an existingbefore issuing the commands below.
Ylose some data if you issue thoson a non-empty disk.
1. First, create the , in a terminal execute:
sudo pvcreate
 
2. Now extend the
sudo vgextend vg013. Use to find out the freextents - Free PE / size (the size you can allocate). We
will assume a free size of 511 PE (equivalent to 2GB with a PE4MB) 
whole . Use your own PE and/or16
TheVolume (LV) can nowmethods,only see how to
use the PE toLV:
sudo lvextend /dev/vg01/srv -l +511
The -l option allows the LV tousing PE. The -L
extended using Meg, Gig, Tera, etc bytes.
4. Even though you are supposed to be able to expand an ext3 or ext4without
unit first, it may be a good practice to unmount it anyway and check the, so
that mess up the day you want to reduce a (in that case first
is compulsory).s are for an EXT3 or EXT. Ifusing another
there may be other
sudo umount /srv
sudo e2fsck -f
The -f option of e2fsck forces checking even if the system seems clean.
5.resize:
sudo resize2fs6. Now mount theits size.
mount/srv && df -h /srv
4.2.4.• See theLVM
9
.
LVM HOWTO
10
 .
•good article isDisk Space with LVM
11
 on O'Reilly's linuxdevcenter.com site.
• on fdisk see the fdisk man page
12
.
9lvm
10
http://tldp.org/HOWTO/LVM-HOWTO/index.html
11/pub/a/linux/2006/04/27/managing-disk-space-with-lvm.html
1manpagesmanpages/quantal/en/man8/fdisk.8.html7
5.
5.1. Introduction
Arefers to a contents of volatile memory (RAM) that is copied
to disk whenever the executkernel is disrupted. events can cause a kernel
disruption :
• Kernel Panic
• Non Maskable Interrupts (NMI)
•Check Exceptions (MCE)
• Ha
• Manual intervention
For some of those events (panic, NMI) the kernel will react automatically and trigger the crash dump
mechanism through kexec. In other situations a m is required in order to capture the
memory. Whenever one of the abovoccurto root cause
to prevent it from happening again. The cause can be determined by inspectipied memory
contents.
5.2 Mechanism
When panic occurs,relies on the kexec o quickly reboot a new
instanckepre-reserved section of memory that had been allocated when the system
booted (see below). This permits the existing memory area to remain untouchsafely
copy its to storage.
5.3. The utility is installed following command:
sudo apt-get install linux-crashdump
A reboot is then needed.
5.4.No further cohavedumpenabled.
5.5. Verification
To confirm thatis enabled, there are a few things to verify.onfirm
crashkernel boot parameter is present (note:linesplit into two to fit
the format of this document8cmdline
BOOT_IMAGE=/vmlinuz-3.2.0-17-server root=/dev/mapper/PreciseS-root ro
 =384M-2G:64M,2G-:128M
Thehas the syntax:
<range1>:<size1>[,<range2>:<size2>,...][@offset]
    range=start-[end] 'start' is inclusive and 'end' is exclusive.
So fokernelfound in /proc/cmdline we would have above value means:
• if the RAM is smaller than 384M, then don't reserve anything (this is the "rescue" case)size is between 386M and 2G (), then64Mlarger than 2G128M
Second, verify thas the request areakdump kernel by doing:
dmesg | grep -i crash
...
[    0.000000] Reserving 64MBat 800MB for(System RAM: 1023MB)
5.6. Tes will cause a system reboot. In certain, this
can cause data loss is under heavy load. Iftest the,
msystem is idle or under very light load.
VSysRQis enabled by looking at the value of the /proc/sys/kernel/sysrq
:If a0 is returned the feature is disabled. Enable it :
sudo sysctl -w kernel.sysrq=1
Once this is done, you must become root, as just using sudo will not be sufficient. As the root
user, you will have to issue the command echo c >rq-triggerare using a network9
connectionlose contacsystem. This is why it is better to do the test while being
connected to the system console. This has the amaking the kernel dump process visible.
A typical test output should look like the:
sudo -s
[sudo] password for ubuntu: 
#
[   31.659002] SysRq : Trigger a crash749] BUG: unable to handlNULL pointer dereference at(null)62668] IP: [<ffffffff8139f166>] sysrq_handle_crash+0x16/0x20PGD 3bfb9067 PUD 368a7067 PMD 0 Oops: 0002 [#1] SMPCPU 1 
....
The rest of the output is truncated, but yoseerebooting and somewhere in the log,seline :
Begin: Saving vmcore from...
Once completed,will reboot to its normal operational mode. You will then find Kernel
fil/var/crash directory :
ls 
linux-image-3.0.0-12-server.0.crash
5.7.is a vast topic that requires good knowledge of the linux kernel.find
more ion the topic here :
• Kdocumentation
13
.
•  tool
14
• Analyzing Crash
15
 (Based on Fedora, it still gives a good walkthrough of
analysis)
1kernel.org/doc/kdump/kdump.txt
1people.redhat.com/~anderson/
15dedoimedo.com/computers/crash-analyze.html203. 
Ubuntu features a comprehensive package management system for installing, upgrading, configuring,
and removing software. In addition to providing access to an organized base of over 35,000for your Ubuntu computer, thfacilities alsodependency
resolution capabnd update checking.
Several tools are interacting with Ubuntu's, from simple
command-line utilities easily automated by system a, to a simple graphical
interface which is easy to use by those new to Ubuntu.21
 is derived same system used by the Debian GNU/
. Tfiles contain all of the necessary files, meta-data, and instructions to
implement a particular functionality orap on.
Debianfiles typically have the extension '.deb', and usually exist in repositorare
collections of packages found on various media, such as CD-ROM discs, or onlines are
normally in a pre-compiled binary format; thus installation is quick, andno compiling of

Many complexuse the concept of ies. Dependencies are additional
requirprincip in order to properly. he speech synthesisfestival depends upon libasound2,asupplying the ALSA
sound library needed for audio playback. In order for , it and all of its
must be installed. Thetools in Ubuntu will do this 2
2. dpkg
dpkg is manager for Debian-. It can install, remove, and build, but
unlike others, it cannot doinstal or
theirThis section covers using dpkg to manage locally:
• To list  on the system, from a ter type:
dpkg -l
• Depending on the amount on yourthis can generate a laoutput.
Pipe the output through grep to see if a specificis | grep apache2
Replace apache2 with anyname, part of name, or other regular expression.the file by, in this case the ufw package, enter:
dpkg -L ufw
• not sure whichnstalled a file, dpkg -S may be able to tell you:
dpkg -S /etc/host.conf 
base-files:
Tshows that thebelongs to the  package.
Many files are generated during the process, and even
though they are on ystemnot knowthey belong to.
•install a local .deb file by enterin -i zip_3.0-4_i386.deb
Change to the actual file name of theyou wish to install.
• Uninstallingcan be aby:
sudo dpkg -r zip
, in most cases, is NOT recommended. It is use
that handles to ensure that the system is in a consistent
state-r zip will remove the zipbut s that
depend on it will still and may no longer correctly.dpkg options see the man page: man dpkg3
3. Apt-Get
The apt-get coa powerful ctool, which woPackaging Tool (APT) performing suchs as insof new software packages, upgrade
of dating of tlist index  the entire
Ubuntu system.
Being a simpleapt-get has numerous s over 
tools in Ubuntu for server . Soseinclude ease of use over
simple terminal connections (SSH), and the abe used in ion scripts, which
can in turn be the cron scheduling utility.
Some examples of popular uses for tutility:
• IPackage: usingtool is quite simpl, to
install the network scanner nmap, type the followinmap
• Remove a Removal (or) is also straightforward. Tonstalled in the previous eremove nmap
Multiple Packages:specify ackages toor removed,
separated by spaces.
Also, adding the --purge option to apt-get removepackage cos as
well. This may or may not be the desired effect, so use with caution.
• UPackage Index: The APTdex is essentially a database of rom thedefin/etc/apt/sources.list file an
.d . To ulocalwith the latest changes made in the
rupdate
• UpgradeOver time, updated versionscurrenton your computer
may become packag(for example security updates). 
first update you index as outlined abthen type:upgrade
For io a new Ubuntu release see Section 3, “” [p. 9].
Athecommand, such and rare loggvar/
log/dpkg.log log file4
For furtheabout the use of APT, read the comDebian APT User Manual
1
 or
type:
elp
debianuser-manuals#apt-howto5
4. Aptitude
Launching with nooptions, will give you a menu-driven, text-based frontend to the system. Macommonmanagement
functions, removal, and upgrade, can be performed insingle-key
commands, which are lowercase letters.
is best suited for use in a non- terminal epropering
of the command keys.tart the interface ofas a normal user by typing
theat apromptitude
Whestarts,see a menu bar at the top of the screen and two panes below
bar. The top pane containscategorieNew and Not IPackages.
The bottomrelateand.
Usfo is relatively, and the usermakes
common tasks simple to perform. Tare asa package, locate thevia the package
category, by keyboard arrow keysENTER key. Hdesire,
then press the + key. entry should turn green, indicating that itmarked
for i. Now press g to be presented with a summary actions. Press g again,
andbe prompted to become root to complete thePress ENTER which will
result in a Password: prompt. Enter your user passwor.press g once more
and you'll . on the prompt, and
downloading and will commence.remove 
remove, -pinkit has
been marked for removal
again, ENTER UpdateIndex:package index, simplyu key
update 
Upindex OK prompt when the dialog isprocess. perform the updateindex as detailed
press the U key to mark als with updateswhereby you'll
6
 prompt.
 upgrads will
The first column of idisplayed in list in the top pane, when actually viewinglists the current st, and uses thekey to describe the
package:
• i
• c:not installed, but paremains on system
• p: Purged fromv: Virtua
• B: Broken• u: Unpacked filesnot yet configured
• C: Halfd - failed and requires fix
• H: Half- - RemovalTo exitqconfirm exit. Many oths are
rom themenu by presF10 key.
4.1. Command Linalso usas a command-line tool, siapt-get. the nma
with all necessary, as in the apt-getyou would usecommanitude install nmap
 same remConsult the man pages for more details ofline options for7
5. 
The unattende can be used to install updats, and can be
 to update aor jus s. First,th in gur, edit apt.conf.d/50and adjustto fit your needs:
UUpgrade::Allowed-Origins {"Ubuntu quantal-security";
//      updates";
};
Certais can also be blacklisted and therefore will not beupdated. To, add it to the listPackage-Blacklist {vimlibc6-devi686";
};
The double “//” serve as comments, so whatever follows "//"evaluated.
To enabl updates10periodic and set the aptation options:
APT::Periodic::Update-Package-Lists "1";Download-UpgradeablAutocleanInterval "7 "1";
The aboveation updates list,s, and instalupgrades every
day. The localarchive is cleaned every week.read more about apt Periodicoptions in the /etc/cron.daily/apt
script header.
The results ofwill be logged to /var/log/8
5.1. Nots
Co Mail inwill
enableto email an a detailing as that need upgrading or
have problems.
Another usefulis apticron. will a cron job  aboon the system that have, as well as 
changes in each package.
apticro,  enterapticrons installedicron/conf, toemail address and othe:
EMAIL="root@example.com"9ation of the r is storedapt/ apAn example of this file is referenced
here, along with iadding or removingys file.
You may edit the file tor disable them.o r
of inserting the Ubuntu CD-ROM wheneveroperations occur, simply comment out the
line for the CD-ROM, which appears at the tfile:
# no more prompting for CD-ROM please
# deb cdrom:[Ubuntu 12.10 _Quantal Quetzal_ - Release i386 (20111013.1)]/ quantal main restricted
6.1. Extra R
the officially supportedUbuntu, there exist a
community-maintainedwhich add thousands more packpotential installation.
Two of the most popular are the Universe and Multiverse. The are not
by Ubuntu, but because they are by the  they generally
providsafe for use with your Ubuntu computer.
Packages in they often have licensing issues that prevent them from
being distributed with a free operating system, and they may be illegal in your locality.
Be advised that neitheror contain. In particular, there ms for thes.
package sources are sometimes even offering only on, case
ofsources provided by the developer of a single a. You should always be very
careful and cautious when using non-standarsources, however. Research the source andcarefully before peany, as sond their
could render your system unstable or non- in some respects.
, are enabled but if like tm
esouandthe following lines:
deb http://archiveu universe m
deb-src http://us.universe-updates30 http://security1
Mostaterial covered in this chapter is in , many of online.
• The InstallingSoftware
2
 Ubuntu wiki page has more i.
•dpkgsee the dpkg
APT HOWTO
4
 and apt-get5
useful regardingusage.
•aptitude6
 options.
• The Adding HOWTO (Ubuntu Wiki)
7
 page contains n adding.
2ma1/dpkg.1.html
dmanuals/apt-howto/
8/apt-get.8.html
6
http://man8/aptitude.8.html
7/Ubuntu324. 
Networks consist of two or more devicecomputer systems, printers, and related equipment
connected by either cabling or wireless linkspurpose of sharing and
ingamong the devices.
This section provides general and ipertaining to networking, including an
overview of network concepts and detailed discussion of popularprotocols.33
1Ubuntu ships with a number of utilities to configure youdevices. This document is
geared toward se and will focus on managingon the command line.
1.1. Ethernet Interfaces
i are identifisystem unaming convention of ethX, where X
represents a numeric value. The first is as eth0, the second as
eth1, and all others should move up in numerical order.
1.1.1. IdentifyToidentify all , you can use the ifconfigas shown
below.
-a | grep eth
eth0      Link encap: HWaddr 00:15:c5:4a:16:5a that can help network vailable tois the lshw
command. In the example below, lshw shows  with the logical name of eth0
abus, driverand all capabilities.
sudo lshw -class network
  *-     description:
       product: BCM4401-B0 100Base-TX
       vendor: Broadcom Corporationhysical id: 0
       bus info: pci@0000:03:00.: ethversion: 02
       serial:       size: 10MB/s
       capacity: 10width: 32 bitlock: 33MHzbilities: (snipped for brevity)onfigurationresources: irq:17 memory:ef9fe000-ef9fffff
1.1.2Names
s ared in the file /etc/udev/rules.d/70-persistent-net.rules. If
control which receives a , find the line masMAC modify theNAME=ethX to the desired.
Reboot the system to commit your change4
1.1.3Settings
ethtool is a program that displays and changescard settings such as auto-negotiation, port
speed, duplex mode, and Wake-on-LAN. It is  by default, but is i
in theinstall ethtool
Theis anof how to viewndof an.
sudo ethtool eth0
Settings for eth0:
        Sorts: [ TP ]link modes:   10baseT/HalfFull  100baseT/Support: Ye Advertised Speed: 1000Mb Duplex: FullPort: Twisted PairHYAD: 1Transceiver: internaA:  Wake-on: gdCurrent message level: 0x000000ff (255 Link detected: yes
Changes madeethtoolre temporary and will be lost after a reboot. If
like to retain, simply addto a pre-up statement in thenetwork/interfaces.  could be permanently
with a port speed of running in full.
auto eth0
iface eth0 inet static
pre-up /sbin/ethtool -s eth0 speed 1000 duplex full
Although theabove showstostatic method,
it actually works with other methods as well,DHCP. Tis meant to
demonstrate only proper placement of therelation to the rest of thec5
1.2. IP Addressingsection describes the process ofings IP default
gateway needed for communicating on a local areaand the Internet.
1.2.1. T Assignment
For nesstandard commandsip, and route,also found on most others. Theseallow you twhich take effect immediately, however they are not  

Toi anthecommand in themanner.
Just subnet mask to matchr.
sudoeth0 10.0.0.100 netmask 255.255.255.0
To verify the of eth0
mannereth0 inet addr: Bcast:10.0.0.255  Mask:inet6 addr: fe80::215:c5ff:fe4a:165a/64 Scope:LinkUP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:  RX packets:466475604 errors:0 dropped:0 overruns:0 frame:   T0317265carriercollisions:0 txqueuelen:1000RX bytes:2574778386 (2.5 GB)  TX bytes:1618367329 (1.6 GB  Interrupt:16
To a default gatewayrout M
route addw ethyourationroute -n
Kernel IP routing table
Destination     Gateway         GenmaskFlags Metric Ref    Use Iface
10.0.0.0           U     1       eth0
10.0.0.1       UGIf you require DNS for youadd es
in the resolv.confbelow shows how to enter twos to /etc/6
, which should be changed to servers anetwork. A more lengthy
de of DNS client is in asection.
nameserver 8.8.8.84.4
If you no longer need thisand wish to purge all IPfrom an interface, you
canp commandflush option as shown below.
ip addr flush eth0
Flushing theidoes not clear the contents of /etc/. You must remove orose entries manually.
1.2.2. Dynamic  (DHCP Client)your server to use DHCP for dynamica, hcp method to the
ess family sfor thene The
 assumes you ing your dentified as eth0dhcp
By addings shown abovemanually enable the through
the ifuhich initiates the DHCPvia dhclientupdi fdown command, turn will the
DHCP releaseand shut downdown eth0
1.2.3. Statuse a ss to the inet
addr Change
the address, netmask, and gateway values to meet the  ofstatic
gateway74. Loopback 
The loopbac is as lo and has of 127.0.0.1. It
can be viewedlo
lo       Local27.0.0.1 0.0.i::1/128 Scope:HostLOOPBACK MTU:16436 2718183308 (183.3 Kretwo lines in /etc/ responsible for . It is recommended that you keep theunless you
have a purpose for changing them. e twolines areauto lo
iface lo inet
1.3. Name Resolution
Name r as it relates to IP networking is themapping to hostnames,
making it easier to resources on . section will explain how to
properyour system for nusing DNS and static records.
1.3.1. DNS ClientTraditionally, the was file that rarelto be
changed  changed via DCHP client hooks. Nowadays, a computer can switch from
oneto another quite often and the resolvconf framework is now being used to track theseand updateer'sutomatically. It acts as an intermediary between
programs that supply iand s that need.
Rgets populated with by a set of hook scripts related tointerface. The most notable difference for the user is that any change done to s it gets overwritten each time something triggers. Instead,8
uses DHC, andto generate a list ofs
and domains to put in /etc/res now a symlink:
 -> ../run/eres of the that are 
network in t.also add an optional DNS suffix search-lists
todomain names. For each other valid opt
include, in the stanza, one line beginning with that option name with a dns- prefix. The resulting file
might lo:    address 192.168.3.3
    ne   1
    dns-search 458.10
The searccan also be used with  so that DNS queries will be
appended in the order in which they are entered.yourmay havesubsearch; a parent domain of, and two sub-domains, sales. and
dev.
If youdomains you wish to search, yourIf you try to ping a host with the name of server1, will  query DNS for its
Fully Qualified (FQDN)ollowing order:
1. server1
2
3If no matches are found, the will provide a result of notfound andquery will fail.
1.3.2. Static Hostnames
Ss are locally defined-to-IP mappings locathosts.
Entries in the hosts file will have precedence over DNS . This means that if
tries to resolve aand itn entryhosts, it will not attempt to look up the
record in DNS. In somes, especially when Internet access is not required, servers that9
communicate with a limited resources can be conveniently set to use s
instead of DNS.ahere alocalhave been 
simples, aliases and their equivalent s (FQDN's).
 localhost
127.0.1.1 ubuntu-server
10.0.0.11 server1 vpn10.0.0.12 server2 mail server210.0.0.13 server3 www server34 server4 file server4In the above example, notice that each of thegivenin addition
to their proper names and FQDN's. Server1 has been mapped to the name vpn,is
referred to as mail,as www, andas file.
1.3Service Switchheselects a method of resolving tois controlled
by the Switch (NSS)nsswitch.conf. As mention
previous section, in the systems /etc/
ovresolved from DNS.is an ee line rethis order of
hostname lookupsile /etc/
hosts: files mdns4_minimal [NOTFOUND=return] dns mdns4
• files first .
•attempts using Multicast DNS.
•any responseby the preceding
process treated as authoritative and that should not try to continue hunting for
an answer.
• dns rlegacy un query query.
To order of tname resolution methodsimply change the
hosts: string to theyour choosingif you prefer to use legacy U
versus, you can string as dnsmdns4
1.4. Bridging
Bridging interfaces is a more advanced, but is very useful in
scenarios. One scenario is setting up a bridge witterfaces, then using a firewall40
to filter traffic between two network segments. Anotherusing bridge on a system with
one  to allow virtual machines directo the outside networkexample
covers the latt.
Beforeingyou will need to install the bridge-utils package. package, in
a tete
Next,e by editing:
auto br0
iface br0 inet static0.1network0ne    broadcast25592.168.0.bridge_ports ethbridge_fd 9bridge_hello  bridge_maxage 1stp off
values for your and
Now restart neto enbridg:
sudo servicing restart
The new  w be up and running. The brctl providesformation about
the state of, controls s are partetc. See man brctl for more
i1.5. Resources
• The  Network page
1
 has links to articles coveringnetwork
• The resolvconf man page
2
 has more  on.
1Network
man8.8.htm1
• Thes3
 has details on more options for.
• The dhclient4configuring settings.
•DNsee ter5
. Also, Chapter 6
ofLinuxA's Guide
6
 is a good source er and name servicbridging see t7
 and the Linux Foundation's Net:Bridge
8
page.maman558/8.htmlman5/resolver.5oreillylinag2/book/ch06man8/brctl.8.htmlwww.linuxf.org/en/2
2. TCP/IP
The Transmission Control Protocol and(TCP/IP) is a standard set of protocols
develop late 1970s by the DefenseProjects Agency (DARPA) as a
means of cion between different types of computers and networks. TCP/IP is the
driving force of the, and thus it is the most popular set of on Earth.
2.1Introduction
The two components of TCP/IP deal withaspect.
Protocol, the "IP"is a connectionlesswhich deals only withacket
routing using the IP Datagram as the basic uniing Tconsists
of a header followed by a message. The is the "TCand
enableshosts to establishs which may be used to exchange data streams. TCP
also guarantees that the datas is delivered and that it arrives at one
in the same order as sent from another.
2.TCP/IP consists of several elementust be set the
cofiles, or deploying solutions such as the  (DHCP) server turn, figured to provide the proper TCP/IP 
settings toclients . These values mcorrectly in order to
facilitatnetwork operation of your Ubuntu system.
The commonand their purposes are as follows:
• Theis a unique identifying string expressed as four decimal numbers
ranging from zero (0) to two-hundred and fifty-five (255), speriods, with
four numbersing eight (8) bits of the address for a total length of thirty-two (32) bits for
the whol. This format is called dotted quad notation.
• Netmask The Subnet Mask (or simply, netmask) is a local bit mask, or set of flags which
the portions of ansignificant to thebits subnetwork.in a Class C network, the netmask iswhich masks the first
three bytes of tand allows the last by to remain 
specifying hosts on the •dress Therthe bytes comprinetwork portion
.he host 12.128.1.2 Awould use 12.0.0.0 as
address, where twelve (12), (
part) and zeroes (0) in all of the remaining to the potential host values. Ahostprivate192.168.1.100 would in turn use aof
0, which specifieof theand a
for all the possiblenetwork43
• Broadcast Adiswhich allowsdata to be sent
simultaneously to alla given rather than a host. The
general bIs255, but this
cannot send amessage to every host on thebecause routers block
it. A more is set to match a on
the privat,1.0, theis255.
messages are produced byAddress
(ARP) and the Routing IRIP).
•Address Ais thethrough which network,
oramay be reached. If onehost wishes to cnother, and that host is not locatedam, then amus. In
many cases, thewill be that of a routerwhich will in turn
pass traffic on to s or hosts, such ashosts. The
settingcorrect, ornot be able to reach any hosts beyond those
• Nameservereses of 
(DNS) which resolvnames intoes. There are three levels of
, specified in order of precedence: The Primary,
the SecondTerti. In order fto be able
totheir corresponding, you must specify valid which you are authorized to use in's these addresses can and will be provided by yourservicr, but many
free and publicly accessible ns are usethe Level3 (Verizon) servers
with from 4.2.2.1 to 4.2.2.6.
, Netmask,,, and Gateway
Address via the directives in the file
interfaces. Thee 
reso, view the system manual page
for  or  respectively, with the following commands typed at  prompt:
Access :
man4
2.3. IP Routing
IP routing is a nd discovering paths in a TCP/ along which network
data may be sent.uses a set oftables to direct the forwarding ofpackets
from their source to the destination, often via many intenetwork nodes routers.
wo primary forms of : StaticandRouting.
Staticnvolves manually adding IP routes to's, and this is usually
done by manipulating theroute command. enjoys many
advantages over dynamsimplicity of implementation on smalles,
predictability (is always computed in advance, and thuse is precisely the
same each time it is used), and low overhead on other routers andlinks dulack of
a protocol. sdoes present some disas well. For
is limited to small networks and does not scale wellalso fails
completely to adapt tooutages and failures aloefixed nature of the
route.
D depends on largewith from aa
 and makes use of specialthe Router 
(RIP), which handle the  adjustments inhat makeossiblhas several uperior scalability and the ability
nd longroutes. Additionally, there is less manual
ofing tables, sincelearn from one another about their existence and routes.
This trait also eliminates the possibility of introducing mistakes in via human erroris not perfect, however, and presentssuch as heightened complexity
and averhead from routerions, whichi benefit
the end users, but still consumesbandwidth.
2.4. TCP and UDP
TCP is a connection-based, offering error correction andd delivery of data via
what isflow control. F determines when the flow of a  needs to be
stoppedviously sent data packets should to be re-sent due to problems such as collisions,
for thus ensuring complete and accuratethe data. TCP is used in the
of important isuch as database transactions.
The UserUDP), on the other hand,less which seldom
dealstrandata because it lacks  or any other method to
ensure reliablUDP is commonly used in such applications as audio and video
streaming, where it is considerably faster than TCP flow
control, and where the loss of a fewis not generally catastrophic5
2.5. ICMP
TheControl ICMP) is an eto tP) as
defin Request For Comments (RFC) #792 and supportspackets containing control,
error, andal messages. ICMP is used by suthe ping utility,
which can the avaiof ahost or device. Esome error
returned by ICMP which are useful to boths and devicesrouters, includeUnreachable and Time Exceeded.
2.6. Daemons
Daemons are special systemwhichexecute continuously in the background and
await requests for the functions they provide from other. Many dnetworkcentric; that is, a large ndaemons executingon an manetwork-relatedality. daemons include the Hyper
Text TransportDaemon (httpdprovides web server; the Secure SHell
Daemon (sshsecure remote login shell and file transfer capabilities; and the
Message AccessimaE-Mail services.
2•man pages for TCP
9
 and IP
10
 that contain moi• Also, see the TCP/IP Tutorial and Technical11
 IBM Redbook.
• Another resource isTCP/IPministration
12en/man7/tcp.7.html
107/iredbooks.ibm.com/abstracts/gg243376.html
1or978059600297846
3.(DHCP)
The is service that enables host computers
to be assigned settings from a server as opposed to manually coea
host. Computersed to bes have no control over thethey receive from
the DHCP sertheation is transparent to the's user.
The most commonpra toincludeand netmaskof the default-gateway to use
• IP adresses of the s to use
can also suppation properties such as:
• Host Name
• 
• Time Server
• Print Server
The  of using DHCP is that changes to the network,  a change in the address of
, need only be changed at a hosts will be reconfigured
the next time theirpoll. As an added, it is also easier to
integrate new inas there is no need to checkn IP
address. Conflicts in IPallocation are also reduced.
Acancousing the methods:
Manual ()
This method entailsto identify the unique hardware  card
connected  and then continually supplying a constant the
makes a reques using thatdevice. This ensures that a
address is tocard, based on it's address pool)
In t, thewill assign afrom a pool of a(sometimes
also called a range or scope) for a period of time or lease, that ised on the server or
until the client informsthat it doesn't need thanymore. This way,s
eiving theirdynamically and on a "first come, first served"
basis. When a is no longer on thefor a period, the
is expired and released back topool for use by other Dsan
address cand be leased or used. After this lient has to renegociate
the leaseserver to maintain use of.

Using tspeto a device,
selecting it vailables. Usuallyused to assign a temporaryto a client, but aallow an infinite lease time7
The last two methods can be considered “” n each case theassigns
an address with no extra intervention needed. The only dibetween them is in how long the is leased, in other words whether'svaries over time. Ubuntu is shipped with
bothnd client. The server is dhcpd (dynamic hosttocol daemon).
The client withand installed on all crequired to be
configured. Both programs are easy to install ande and
started at system boot.
3.1. Installation
At a terminal prompt, enter thecommanddhcpisc-dhcp-server
probablyange the defaul/etc/dhcp/dhcpd.conf to suit
your needs and .
You also maedit /etc/default/ to specify the interfaces dhcplisten to.
NOTE: dhcpd's are being sent to syslog. Look there for diagnostic.
3.2.e the i ends with might be a little confusing, butsteps will
help youthe service:
Mly, what you want to do is arandomly. This can be done withas follows:
# minimal sample 
default-lease-time 600;
max7200;
subnet netmask{
 range15000;
 option routers4domain-name-serv1, "mydomain.example";
} 
This will result in thegiving nfrom the range150-200. It will lease aor 600 seconds if tdoesn't ask for
c time frame. Otherwise the maximum (allowed)ll be 72will
also "advise"to us254 as the and 2
as its .
After changing the config file you have to restart the dhcpd:8
srestart
3.3. References
• The dhcp3-server
13
 page has more information.
•options see.conf man page
14
.
• ISC 15
13
ma5.5.html
isc.org/software/dhcp9
4. 
NTP is a for synchronising time over a network. Basically a client requests the
current time , and uses it to set its own clock.
Behind this simple de, there is a lot of complexity - there are tiers of NTP servers, with the
tier one coatomic clocks, and tier two and three servers spreading the load
of actually handlingacross the Internet. Also the client softwamore complex than
you might think - it has to factor out communication delays, and adjust the time in a way that does not
upset all the other processes that run on the server. But luckily all thatis hidden from you!
Ubuntu uses ntpdate and ntpd.
4.1. ntpdate
es withs standard, and will run it once at boot time to set up your time according
to Ubuntu's.
ntpdate -s ntp
4.2. ntpd
The ntp daemon ntpd calculates the drift ofclock and continuously adjusts it, so there
are no large correat could lead to inconsistent logs for instance. The cost is processing
power and memory, but for a modern server this is negligible.
4.3.ntpd, from  ententp
4Entpadd/remove server lines. eseare configured:
# UNTP Pool Project. Approved by Ubuntu Board
# on 2011-02-08 (LP: #104525). See http://www.pool.ntp.org/join.html for
#server 0.ubuntu
server 123load the nt50ntp reload
4.5. View status
Use ntpq to see to see:
# sudo ntpq -p
     remote refid      st t when poll reach   delay   offset  jitter
=
+stratum2-2.NTP. 129.70.130.70    2 u    5   64  377   68.461  -44.274 110.334
+ntp2.m-online.n 212.18.1.106    54.629  -27.318  78.882
*145.253.66.170  .DCFa. 1 u   10  83.607  -30.159  68.343357   68.795  -68.168 104.612
+europium.canoni 193.79.237.14    2 u   63   64  337   81.534  -67.968  92.792
4.6.See theime
16
 wforntp.org, home of theTimeproject
17
16UbuntuTime
1ntp.org/515. 
52
1. Device Mapper 
Device mapper multipathing () allows you to I/O paths between
server nodes and storage arrays into a single dese are SAN connections
that can include separate cables, switches,rollers. aggreg,
creating a new deconsists of thed paths. This chapter provides a summary of the
features of that are new for the initial release of Ubuntu Server 12.04. Following
that, thigh-level overview of DM and its components, as well as ansetup.
1.1. New and Changed Features for
Migrated from-0.4.8 to9
1.1.1. Migration from 0.4.8
The priority checkers are run as standalone binaries, but as shared libraries. The key value
name for this feature has also slightly changed. Copy the attribute named prio_callout to prio, also
modify the argument the na, a system path isnecessary. Enversion:
devicevendor "NEC"
        product "DISK ARRAYmpath_prio_alua /dev/%nio    alua
}
See Table Priority Checker Co[p. 52] for a complete listing
Table 5.1.
v0.4.8 v0.4.9
emc /dev/%n prio emc prio aluanetappnetapprdardahp_swhp_swhds_modular %b prio hds
Since the coparser essentially parses all key/value pairs it finds and then makes use
of them, it is safe for bothand prio to coexist and is recommended that the prio
be inserted before bmigration. After which you can safely delete the legacyiout
without interrupting service.3
1.2.can be used to provide:
• Redundancy can provide failover in an active/passive configuration. I
, only half the paths are used at any time for I/O. If any element of an
(the cable, switch, or controller) fails,switches to an alternate path.
• Improved Performance  iactive mode,
where I/O is spread overin a round-robin fashion. In som
can detect loading on thend re-balance the load.
1.3. Storage Arrayincludes support for the mthatDM. The supported devices can be found in the.conf.defaults file. If your storage
array supportsand is noted by defais file, you madd
them to the file,  file, see Section, TCFile. Some require
specialof I/O errors and path switching. These require separate hardware handler kernel
modules.
1.4.mponents
Table “C” des ofpackage.2
 De
dm_
Reroutes I/O andfor pathgroups.
command Lists andsdevices. Normally started up with /etc/
rc.sysinit, it can also beby a udev program whenever a
block device is added or it can be run by the initramfs file systemd daemon Monitors paths; as paths fail and come back, it may initiate path group
switches. Provides for interactive changes  This
daemon must be restarted for anythe /etc/.conf
file to t.
kpartx command Creates devdevicespartitions on a device It is
 to use thisfor DOS-based with kpartx is provided in its own package, buttools package dit4
1. Setupcompiled-insettings that are suitable for commons. Setting up DM-is often a simple procedure. The basic foringwithis as follows:
1. Install-tools and-tools-boot packages
2. Create an empty co,, that re-defines the f3. If , edi.confation file to modifvalues and save the
updated file.
4. Star daemon
5. Update initial ramdisk
For detailed setup instructions forco Setting Up5
2.Devices
Without, each path  node to a storage controller is treated by the system
as a device, even when the connects the same se totorage
.prway of organizings logically, by singledevice on top of the underlying
2.1 Identifiers
Each has a World Wide (WWIDisto be globally
unique and unchanging., theais set to its WWID. Alternately,
et the user_friendly_names option in thefile, which causes to use a node-unique alias of the form mpathn as.a node with
two HBAs attached with two ports via a single unzoned FC switch sees
four devices: /dev/sda, /dev/sdbc, and /dev/sddcreatesdevice
with a unique WWID that rto those four according to. option yesthmpathn. When ns are brought under the control of
themay be seen in two different places/dev directory: /dempathn
dm-n.
• The devices in are created early in the boot process. Use thesto aed devices, for example whenlogical volumes.
• Any/dev/dm-n are for internal use only and should never be used.thedefaults, including theoption, s , “ Defaults”.set theto ayour choosing by using the alias section of thfile.
“s Device ”.
2.2. CoDevice Names in a Cluster

is unique to a node, but it is notthe same on all nodesdevice.
if you setfor a device.confis not sistent acrossin the cluster. This should
not cause any difficulties if you use LVM to create logical, but if
youthat youdevice names be cin every node it isyou
leave option set to no and that you n aliases for theif you do not set to yes or configure an alias ,
name will be the WWID, which is always the sam want the system-defined
user-friendly names to, however,follow this
:6
1. Set up all of thes on one machine.
2. Disable all ofs on your other machines by running the following commands:
# servic-tools stop
#-F
3./bindings file first machine to all thein the
cluster.
4. Re-enabled daemon on cluster
commandart
If you add a , you will need to repeat this that you would like the nodes
i, you should ensure that the file i for each node  bythe same:
1.e the s in the.conf fileWhen2.3. attributesuseand s, a has numeroussmodify these for a specificn entry for
thatation s sation File
".
2.4s inVolumes
After use just asuse an LVM .ifa is
the name of, thecommand will markas a
volume.
# mapper/mpatha7use the resultingdevice when you create an groupyou
would use adevice.ttempt  on a whole device on haveed , thefail.
 that uses aarrays as the 
devicesinclude filterlvmexclude the disks that underlie ths. This is because if the array hanges the active path to the passive
path when it receives I/O,will and failback LVM scans path
if theseare not filtered. Forarrays thata comakeactive, LVM prints a warning message when this occurs. To filter all SCSIin the LVM (lvm.conf), infilter in thfile.
filter = [ "r/block/", "r/disk/", "r/sd.*/", "a/.*/" ]
After updating /etc/lvm.conf, it's necessary to update the initrd so that this file will be copied therthe filter matters the most, during boot. Perform:
update-initramfs -u -k all
Every time either oris updated,hould be
rebuilt to reflect these changeimperative when blacklists andare
to maintain a stable storage8
3.Overview
Thisstes fing It includes the
:
• Basicsetup
• Ignoring local disks
• Adding moreto th file
3.1
Before seon your system, has been updated and
-t. If boot from SAN is desired, then the-boot
package is also required.
A basic need not even exist, when multpath is run without an accompanying
, it draws from it's internal database to find a co, it also
. If after-ll conos are
discovered. One must proceed to increase the verbosity to discover why was not created.
Consider referencing the SAN vendor's documentation,s found in /
usr/share/do-tools/examples, and the livd:
# echo 'show config' |d -k >.conf-live
To work around a quirk in, when andoesn't exist, the
previouswill return nothing, as it is the result of a merge be /etc/.confin memory. To remedy this, either define an empty, ouch, or create one that redefines a default value like:
defaultsuseno
}
and restartrestart
Now the ""database.
3.2. Installing witho enabl support during installation
1
 use
install disk-detect/enable=true
at the installer prompt. If devices are found these will show up as<X>
.
iki.dDebianInstaller/Support9
3.3.Local Disks When GeneratingSome have local SCSI cards for theirisks.is not recommended
for these devices. The  sho file to
ignore the whening
1. Determine which disks are the and mark them as the ones to. In this/dev/sda is. Note that as originallyed in theethe-v2 shows, in 
map. For further information ooutput, s
Command Output”.v2
create: SIBM-ESXSST336732LC____F3ET0EP0Q000072428BX1 undef WINSYS,SF2372
size=33 GB features="0" hwhandler="0" wp=undef
`-+- policy='round-robin 0' prio=1 status=undef
  |- 0:0:0:0 sda 8:0  [--------- 
device-mapper ioctl cmd 9 failed: Invalid argument14No such device or address3600a0b80001327d80000006d4362167712G'0''0'2b 8:16  undef ready  running
    `- 3f 8:80create: 510000009a436215ec1 sdc 8:321 sdg 8:96d800000070436216b32 sdd 8:482 sdg 8:11b4362163e3 sdd 8:643 sdg 8:122. In order to prevent the device mapper from mapping in itsmaps, edit the
 s file to iis device. you couldthe sda device using a devnode type, that would not be safe  sinces
notreboot. T individual devices, you can using
the WWID of thatin the output to -v2 command, 60
thdevice is
th,ein thefile.{
      wwid
}
3. After you have updated, you must manually telld
daemon to reload the filecommand reloads th.reload
4. Run thcoremovedevice:f5. To check whether the device removal workedru-llto display
the current. 
 Queries withCommand”that theed device was not added
backas iexample. Themmandto alevel of v2 pecify a -v option1
3ing Storage Devicesdefaultation value, can be theeed to add a storagthat is not as a knowndevice, edit
the and insert the appropriati.to add  about the HP Open-V series the entry looks like this, where %n is
tname:
devices {
     device    vendor "HP    product "OPEN-V.getuid"/lib/udev/scsi_id --whitelisted --device=/dev/%n"
     }
}onsFile
Devices [p. 70]62
4. provides for the muses oing.,
. The  and thedevicesYou can override tforby editing . you can alsarray t
to thefile. This chparsing and modifying th file. It contains otopics:
• [p. 62][p. 63Defaults [p. 65[p. 69
Iyou need to specify only the sections that you need
for your, orwish to change ds inthere arof the file that are not relevant to your
eor for which you do notvaluleave them
commented out, as they are in the initial file.
T allows regular e de syntax.
An annotated version of /
examples..gz.
4.ation File file is divided into thesections:
Listing of devices that will not be considered for_ecandidatould otherwise beaparameters of
th section.
Generalsettings .the characteristics of i. These values overwrite what is
 defaults and devices3
devicesstorsyou arestorage  by
default, you mcreate aubsection array.system determines the a of afirst it checks thesettings,
then the perttings, faults.
4 File 
T ofs theused
when the systemess. Daregrouped into a.
• Ifeed todevicedo so criteria:
• By WWID, as describeding By WWID By device nameintypType [p. 64]a variety of device types , even acomment out the
, seing By 4.2.1.specifydevicesby their World-Wide IDentification with a wwid entry
in t
example ines in the that wouldwith a
WWID of 26353900f02796769wwid
}
4.2.2b ey
device by specifyinentry ll,
since its all sd* devicesdevnode "^sd[a-z]"
}4 irather than al of a type. This is not,
since unless it is statically mapped by udev rules, there is no thatdevice will have
the same name on reboot.d couldto /dev/sdb on
reboot.devnode entries are compiled in the defaul; thethese
entrieso notsupportToing on any of these
dewouldspecify them ,
i [p. 64] (ram|raw|loop|fd|md|dm-|sr|scd|st)[0-9]*h
4.2.3Type typwith a device
section.exampleIBM DS4200 and HPice "IBM3S42"       #DS4200 Product }
       dev  }
}
4.2.4 that have been.fa laevices and want toonly one of them (with the3600d0230e13955cc3757803), instead lying each of th except the one you want, you couldall of then allow only the one
you want by adding thelines to the  wwid "*5wwid ""
}
Whendevic
  in the same way they were For example, a WWID
apply toby entry, even if the
device is associated with that WWID. apply on,
ice entries.
4.3.Defaults
Tincludes a defaultsthat sets the
 to yes, as followsyes
}
This s thevalue of the .template ofdefaults. Thiis c
#{
#       udev_dir /devpolling_interval        5selecto""ath_grouping_policy    failover         "/lib/de# prio   const
# path_checker  directio
# rr_min_io  1000
# rr_weight  uniform
# failback  manual
# no_path_retry  fail
#no
#}
Tofor , you can copy the
line from this intoand uncomment it
pso that it is multibus failover, copy
the eto the initiof thefile, and
    yes6multibus
}
Table6] deathat are set in the.are used by
unless they areten by the s of thefile.
Table 5 DeSpecifies the wo path checks in seconds. For properly
functioning paths,checks will gradually io
(4 * ).value is 5.
The directory where udev device nodes are created/
dev._dir the dynamic shared objects are stor
pendent, commonly /lib
verbosityerbosity. Higher valueshe. Valid
levels are between 0 and 62.
path_default algorithm to use in determining what path to use for
the next I/O operation. Possiblelude:
• : Loop through every path in the path group, sending the
same amount of I/O to each.
• queue-length 0: Send bunch of I/O dowleast outstanding I/O requests.
• service-timeshortest estimated service timised by divitotal size of the to each path by its relative throughput.
Theis.ing policy to unfailover = 1 path per priority group
•= all valid paths in 1group_by_serial = per detected serial number
• priopathvaluenode_nametarget node namefailover7rogram and arguments to call out to obtain a unique
path identifier. An absolute path is r.
prio function. the ALUA bits in SPC-3 provide an exploitable prio value.
const: Set aof 1 to all paths.
• emc: Generate the for EMC arrays.
• aluabased on the SCSI-3 ALUA settings.
• netappNetApprdaLSI/Engenio RDAC controller.
• hp_swCompaq/HP in active/
standby mode.
• hdsHitachi HDS Modular storage
arraysconst.
prio_args Thestring passed to the prio Mosts
. The datacore prioritizer need one. Example,
"timeout=1000 preferredsds=foo"(null) "".The extra  only existing feature is
queue_if_no_path, which is the same as settingto
queue.issues that may arise when using this feature,
s, "Issues with  feature".
patmethod used to the state ofsreadsector0: Rerst sector of the device.
• tur: Issue a TEST UNIT READY toemc_clariion: Query the EMC Clariion EVPD page 0xC0 to
determineCheck state for HP stors with Active/Standby
firmware.
• rdac:  for stor.
• directiowith direct I/Odirectio8Manages path group failback.
• A immediate sto the highest
that contains activemanualthat there shou
but that can happen only with operator intervention.
• A numeric value greater than zerodeferred,
ein secondmanual.
 to route to a path before  topath in the current1000.
If set toes, then isending ro a path
before calling patto choose the next path, the
send times the path's priority, asd by the . uniform, all path weights are
equaluniform.
for this attribu 
system should attempt to use a faileddisabling queueing. A
fail indicates ure, without
queuethastop until is fixed0.yes, use the/
to assign a persistent and unto the, in
the form of mpathnno
WWID as the alias for. In either case, what isd
here will be overridden by a-aliases you specify in ths section no.
queue_without_daemonno,d daemon will disable for all devices
when it is shut downyes.
flush_on_last_delylast path to a
device has been deleted9no.
max_fds Sets the maximumpen file descriptors that can be opened byand.equivalent to the ulimit -
n command.max will set this to the system limit from /proc/
sys/fs/nr_open. If tset,
is taken rocess; it is usually 1024. To be
safe, this should be sepaths plus 32, if that
number is1024.
checker_timer The timeout to use for path checkers that issue SCSI commands with an
explicit timeout, /sys/block/sdx/device/which
is 30 seconds as of 12.04 LTS
fast_io_fail_tmo Theseconds the SCSI layer will wait after a problem
detected on an FC remote port before failing I/O to devices on that remote
port. This valuemaller than thedev_loss_tmo. Setting
this to offtdetermineOS.

been removing itsystem.
Setting this to infinity2147483647 seconds, or 68 year4   ayou can set in thes section
offor each . These apply
only to the one  These defaults are used  and 
ndsections 4.wwid device to which apply. This parameter is mandatory saliassymbolic nameapply. If use, do not
set tto mpathn; this may conflict with an automatically assigned
user  and give you incorrect device s70the followings mayin this• pat
• pat
• failback
• prio
• 
•
•
• 
• cofor twos. The firshas a3600508b4000156d70001200000b0000 and a
of yellow.
The seconddevice in the example 1DEC_____321816758474red. In this the is set to priorities.      wwid       aliasyellow  manual        red}
}
4.5.vices
Table Device [p. 71]individual storagen the u of ths that contaitheset in
the.
Mathat suppoing are included by default in a. The
valuesdevices that are re listed.con71
You probably will not need to modify the s, but if you do values by including an en that s those
values.copy conf or ifhave a brief config file,.synthetic file tthat to change.
To add athis that is noted ,
you must set the vendor and productfind thesby looking at 
device_name/device/model where  is thto beed, as in theexample:
# csda
WINSYS  model
SF2372
The additionalto specify depend on your device. Ifis active/active,
you willset.want to set to
multibus. Otheryou mset are and, as described in.
passive, but itpaths with I/O to the passive path,
youchange the checker one that dendth to test if it is
working (otherwise, your device will keep failing over). This almost always means that you set theto tur; this works for all tthe Test Unit Ready command,
which most doneeds a special command to switch paths, thening this device for
requires a ha module. The current availableis emc.
not s for, ot be able to the.5.vendorvendor name of the storodevice, forCOMPAQ.
productproductHSV110 (C)COMPAQ.
revision_blacklisa rused to devices by product.
hardware_handlea module that will beperformctions
when path groups or handerrors.
include72• 1 emc:for EMCarrays
• 1 aluaarrays.
• 1 hp_sws.
• 1 rdathecontrollers.device section
•
• 
• pat
• features
• 
• deWheneveris , it is your responsibility to ensure that the
kernel module is loaded to support the interface. These modules can
be found in /lib/modules/`uname -r`/kernel/drivers/scsi/devic/ . The
requisite module integrated into the initrde necessary discovery and
failover-capacity isduring boot tim# echo scsi_dh_alua >> /etcmodules  ## appendo file
# uThe ee.
#devices {
# device {
#  vendor   "COMPAQ  "
#  product   "MSA1000         "
# #    tur
#  # }
#73
The spacing reservvendor, product, and fields are sias is
performing a direct match against these a, whose format is defiSCSI specification,
lly the Standard INQUIRY
2
 command. When quotes are used, the fieldsinterpreted strictly aspec. Rs may be 
quoted strings. Should a field bewithout the spacing,will
copy the stringproperly sized buffer and pad with the spaces. Thetion expects the entire field to be populated by printable characters or spaces, as seen in the
example above
• vendor: 8
• product: 16revision: 4To more robustation file,s can also be used. Operators include ^
$ [ ] . * ? +.functionalby examining the live
database and.conffilesu
2
http://en.wikipedia.org/wiki/SCSI_Inquiry_Command4
ion and 
5.1. Resizing an Onlineresize an onlin device, use theprocedure
1. Resize your . This is storage platform.
2. Ufind the paths to the LUNl
3aths. For, writing 1 to the rescan file for the device causes the SCSI
driver to rescan, command1 >devicrescan
4device by d resize -k 'resize map mpatha'
5the file system (assuming no LVM or DOS partitions are used):
# resizmapper/mpatha
5.2. Moving root File Systems from a Single Path Device to aDevice
This is dramatically simplified by the use of UUIDs to identify devices as an intrinsic label. Simplyand reboot. This will rebuild the initial ramdisk and affor the
opportunity to build it's paths before the rootis mounted by UUID.
 is updated, so shourd by e
. The reason being isis copied to theis integral ting the devices for grouping via it's and device sections.
5.3swape  is exactly the same as illustrated in the previous section called
 Device.
5.4. Theaemon
If you find you have trouble implementing a, you shouldeemon isas de "". Thd d
running in order to usevices. Also see
interactive console concerning ng withd as a debugging ai75
5.5. 
If "1" is  in the, then any process
that uses I/O will hang until one or more paths are restored. To avoid this, set theN
parameter., remove theoption
as well. If, hoare usefor
option is set as a comdefault, as it is for many
SAN devices, you must add0" to is default.do this by copexistingsection, and just that(not thele), from too intoand editing to suit your
needs.us and you experience the issue noted
herdmsetup edit the policy at runtime for a particular LUN (that is, for which
all theun).if you want to policy on t device
mpathc from "qu" to  "fail", execute the fcommand.
# dmsetup message mpathc 0
specify the mpathN alias rather than
5.6.mmand Output, modify, or list device, you get a printout of the currenttup.
The format is as follows. For eac device:
   action_if_any: alias (wwid_if_different_from_alias) dm_device_name_if_known vendor,product
   size=size='featuresha' wp=write_permission
path group:
  scheduling_policy' prio=prio  status=path_group_status:
   `- host:channel:id:lun devnode major:minor dm path_status
  online_statushe output ofcommand might appear:
  0 dm-1  size=269rw
  |active
  | `- 6active reaenable6
    `- 7 If is up and ready for I/O, the status oready or ghost. down, the
status is faulty or shaky. The path updated periodically byd daemon based on
the polling interval defined i.
The dmsimilar tostatus, but kernel's point of view. has
two states: failed, which is analogous to faulty, and active which covers all otheres.
Occasionally,e and te of a device will temporarily not agree.
The pfor arend offline. Aoffline the
 has been disabled.
When  is being created or modified group status, the dm device
name, the write s,us are not known. Also, the are not
always correct
5.7-l and -ll optiodisplay the. The -l option displays topology gathered from iin sysfs and the
device mapper. Thethethe -lin addition to 
components of the system.
Wheing theco, there are three verbosity levels you can specify with
the ofmmand. Specifying -v0 yields no output1 outputs
theupdatednames only, whichthen feed to other tools such as kpartx.
2 prints all detected paths,s, and s.
The default ofis 2 and can be globallyby defining theain ts section.conf.
The the -l -l1 dm-10enabled
  | `- 19:0:0:1 sdc 8:32  7
  
    `- 18h 8:112
   3 dm-2  size=125    |3 sde 8:64    3 sdj 8:1445.8ptions
Table Useful [p. 77some 
hat you might find useful.6.
Option-l D 
theper.
-l, th, and  n-f device Rnamdevice.
-F Remove all unuss.
5.9. Determining Device Mapper Entries with dmsetup Commandfind out which entries matched
devicescommand all  devices and their major and minor numbers.
The determine the.a of 3
corresponds to device /dev/dm-3.ls
mpathd  (253, 4)
mpathep1        (253, 12)
mpathf1)
mpathb  (253, 3)
mpathg4)
mpathh3)
mpatha  (253, 2)
mpathh  (253, 9)
mpathg  (253, 8)
VolGroup00-LogVol01)
mpathf  (253, 700)
mpathe  (253, 6)8
mpathb0)
mpat5)
  
5.10.  inte
Thed -kis aninterfaced daemon. Entering thisbrings upconsole. this commanenter help
to get a list of commands,enter ammand, orCTRL-D
to quit. can be used to troubleshoot problems you may be having with
your systemthecommand sequencet,
ithe defaults, before exiting the See the IBM article "Tricks withd"
3
 for
more examples.
#
  > > show config
  > > CTRL-Densures thathas picked up any changes to the
,> > reconfigure
toat the path checker is working properlypathsCommands can also be streamed intousing stdin like so3
-01support/docview.wss?uid=isg3T1011985796. Remote 
There are many ways to remotely administer a Linux server. This chapter will cover two of the most
popular applications OpenSSH, and Puppet.80
1. 
1.1. Introduction
This the Guide introduces a powerful colltools for the remote
control of, and transfer of data between, networked computers called OpenSSH. also learn
about some of the cosettingsOpenSSH serve and how to
change them on your OpenSSH is a freely version of the Secure Shell (SSH) protocol family of remotely
controlling, orring files.  toolsaccomplish theses, such as telnet or rcp, are insecuremit the user's password in cleartext when used.
OpenSSH provides a server daemon and client tools to facilitate secure, encrypted remote control and
file operations, effectively replacing the legacy tools.
Theserver component, sshd, listens continuously for client co from a
. When a request occurs, sshd sets up the correc depending on the
type ofn computer is ssh client
, tsets up asession after authentication. Ifuser
connects to anwith scpdaemon initiates a secure copy of files
beserverOpenSSH can use many methodsplain, public key, and tickets.
1ation
Installatlient ands is simple. To installs, use t at a terminal prompt:
sudo aptopenssh-client
se, and related support files
server
The openssh-server package elected tduring the Server Edition i
process.
1
You may configure the default behavior ofsshd, byhe file
/etc/ssh/sshd_config.about theation directives used in this file, you may
view the appropriate manual page, issuedman 1in the sshdfile co such things as communication
settings, and  modes. are ofthat can be
changed file.
Prior tocoshould make athe original file and protect
it from writing so you will have settings as a reference and to reuse as necessary.
Copy the  
commandssudo cporiginal
sudo chmod a-w.you may change:
• To set yourto listen on TCP port 2222 instead of , 
Port as such:
Port 2222
• To have sshd allow-based login credentials, simply add or modify the line:
Pubkeyyes
If is already present, then ensure it is not commented out.
• To makeserver onten/etc/issue.net file as a pre-login
banneBanner 
In.
After making c, save the file, and restart server to effect theusing the  service ssh restartfor sshd are to se's
to fit your needs. ,if your only method of access to a server
is ssh, and you make a mistake in configuring sshd via, you
may find you are locked out of the server upon restarting it. if an incorrect
 is supplied, may refuse to start, so be extra careful
whenis file on server.
1.4. SSH Keys
SSH keys allow wo hosts without the need of a. SSH key
uses two keys, a private key and a2
To generate the keys, from a te enter:
ssh-keygen -t dsa
This will Digital Signature A(DSA) method. processbe prompted forimply hit Enter whento cre. the is saved in the file ~/.ssh/id_dsa.pub, wh is the private
key. Now copy the  file to the remote host and append it to ~/.ssh/authorized_keys by
entering:
ssh-copy-id username@remotehost
Finally, double check the permissions on the file, onlyenticated user
should have read and .are not correctm by:
chmod 600 
now be able to SSH to the hostbeing
1.5. References
• Ubuntu Wiki SSH
1
 page.
•Website
2
• Advancediki Page
3
1SSHwww.openssh.org/
wikAdvancedOpenSSH3
2. Puppet
Puppet is a cross platform framework enabling system administrators to perform common tasks using
code. The code can do a variety of tasks from installing new software, to checking fil,
or updating user accounts. great not only initial ia system, but also
througsystem's entire life cycle. In most circumstances puppet will bea client/server.and Puppet in ation. This simplewill demonstrate how to install Apache using Puppet.
2.1. Puppet, in on the serverpuppetmaster
On the client machine, or machines,figurationpuppet you may want to add a DNS CNAME record for puppet,
where example.com is your domain. Puppet clients check DNS as
the puppet server name, or Puppet Master. See Chapter 8,  (DNS) [p. 138]
for more DNS details.
If you do not wish to use DNS, you can add entries toand client /etc. in the P's add:
1localhost.localdomain  puppet
7 meercat02
On each, add an ente server:6 meerca meercat puppetth es and domain names above with your actual server and
client address.
Now setup some resources for apache2. file /etc/puppet/manifests/site.pp containing
the :
package {4
    'apache2':
        ensure => installed
}
service {true,able => require => Package[]
}
Next, node nodes.pp with:
node '' {
   include apache2
}'s host name.
The final step for t is todaemon:
sudo service Now everything ised o, it is time to .
First,Puppetagent dstart. default/puppet, changing START to yes:
START=yes
Then startice start
Back sigcertificate by entering:
sudo puppetca --sign
Check syslog for any errors with theation. If all goes well th package
and it's dependenciesclient.
This example is very simple, and does not highlight many of Puppet's features and benefits.see Section 2.3, “Resources” [p. 84].
2.3. 
• See the Official Puppet Doc
4
 web site.
4
http://docs.puppetlabs.com/5
•Pro Puppet
5
.
• ource of ais thePuppet Page
6
.
5.apress.com/9781430230571Puppet6
3. Zentyal
Zentyal is a Linux small business server, tas a Gateway, Infrastructure
Manager, Unified Threat Office ServCo Server or a combination
of them. All network services managed byare tightly integrated, automating most tasks. This
helps to avoid errors in thecoand ion and allows to save timeis open source, released under the GNU General Public License (GPL) and runs on top of Ubuntu
.consists of a serie of packages (usually one for each module) that provide a web interface toe the different servers or. T is stored on a key-value Redis database
but users, groups as related is on OpenLDAP . onfigure any of
the parameters through the, finalfiles are ovetemplates provided by the modules. The main af using: unified,useraand high, out-of-the-boxion between
them.
3Zentyal 2.3 ison Ubuntu 12.04 repository. Tare:
• zentyal-core &mmon: the core of theand the common libraries of the
. Also include the logs and events modules that give the  angenerate events from them.network: manages theof the network. s (supporting static
IP, DHCP, VLAN, bridges or PPPoE), to multiple gateways when having more than one Internet
connection, load balancing and advanced routing, static routes or dynamic DNSobjectsservices:n abstration level for(e.g. LAN
instead of /24) and ports named as(e.g. HTTP 80/TCP)firewall:s the iptables rules to block forbiden s, NAT
redirectionstp: installs the NTPkeep server on time and allowlients to
synchronize their clocks a serverdhcpISC network rangesleases and other
options like NTP, WINS, updates andboot with PXEns: brings ISC Bind9  into your server for caching local queries as a forwarder
or as an authoritativeed domains. Aconfigure A, CNAME, MX, NS,
TXT and SRV recordca:es the management of a ion Authority withinso users can use
s to e ices, like with OpenVPNpenvpn: aVPNand clients using OpenVPN with
dusing Quagga7users annd manage users and groups on.
OtheroaredLDAP having a centralized
. It is also possible to users, passwordfrom a Microsoft
domainsquidSquid and Dansguardian for speeding up browsing thanks to the caching
capabilities and content filteringambaSambaandion with existing LDAPsame
interfacedefine policies, create shared resources and assign peprintersCUPS with allows toe the printers give them based on LDAP.Zentyal, in a terminal on the server enter (where <zentyal-module> is a modulesprevious list):publishes one major stable release once a year (in September)latest
Ubuntu LTS release. Ss always have even minor numbers (e.g. 2.2, 3.0) and
beta releases have odd1, 2.3).comes with2.3 packages. If you want to upgrade to a newpublished after th
ofyou can useTeam PPA
7
.  to newes can
provide you minor bugfixes not backported to 2.3 in Precise and newer.more ion how to add from a PPA see  Add a Personal
Package Archive (PPA)
8
.
Not present on Ubuntuies, but 9
 you will find these
other modulesantivirulamAV  with  like the proxy, file
sharing or mailfilteasteriskAsterisk to simple PBX with LDAP basedbwmonitormonitor bandwith usage of your LAN clientptiveportala captive portal with the firewall and
groupebackupake scheduled backupsserver using the popular
duplicity backup toolfta F .launchpad.net/~zentyal/
8$distro-rev-short/ubuntu-help/addremove-ppa.html8idaintrusion detection systipsecIPsec tunnelsSwajabberejabberd XMPP serverthinclients: a LTSP based thin clients solutiomail: a full mail stack including Postfix and Dovecotckendamavisd withto filter spam and attached viruintegrates collectd to monitor server peand running serviceppPPTP radiFreeRADIUSsoftware: simplemanage installedmodules and system
updattrafficshapingtraffic limitingdo bandwidth throttling and
improve latencyusercorneusers to edit their own LDAP ausing a web browsevirtcreate and manage virtual machines libvirtwebmailaccess your mail Roundcube webmaiwebserverApache  to hostites on your machinezarafZarafa groupware suite and LDAP.
3.2. First steps
Any system account belonging to the sudo group is allowed to log into. If you
areuser created stallation, this should be inby default.add another user, just execute:
sudo adduser username sudo
To access, browse into https://localhost/ (or the IPremote server). Asreates its own self-signed SSL ,have to accept a security exception on
yourOnce logged insee the dashboard with an overview. Toaof yourmodules, go to theections on the left menu.make any
changes, on the upper right corner appears a red Save changes button that you must click to save allchanges. To apply theseationin yo, the module needs to be
enabled first, you can do so from the Module Status  entryyou enable a
module, a pop-up will appear asking for a confirmation to perform the necessary actions and changes
o andfiles9customize any or run certain(scripts or commands)
tnot onplace the customtemplates
on /etc/zentyal/stubs/<module>/ and the hooks hook.<action>.
3.3.Zentyal 
10
 page.
See alsoCommunity1And don't forget to visit the forum 
12
 for csupport, feedback, feature requests, etc.
1doc.zentyal.org/
1trawiki
1forum907.applies LDAP toand authorization.Network 91
1.Server
The Lightweight , or LDAP, is a protocol for querying and modifying
a X.500-based directory serviceover TCP/IP. The current LDAP version is LDAPv3, as
defined in RFC4510
1
,LDAP implementation used in Ubuntu is, currently at
version 2.4.25 (Oneiric).
So thisaccesses LDAPies. Here are some key concepts and terms:
• Ay is a tree of data entries that is hierarchical in nature and is called the
ITree (DIT).
• An entry consists of a set of a.
• An has a type (a name/description) and one or more values.
• Everymust be at least one objectClass.
• and objectclasses arschemas (an is actually considered as a
special kind).
• Each entry has a unier: it's Distinguished Name (DN or dn). Thisit's Relative
RDN) followed by the parent entry's DN.
• The is not a. part of the entry itself.
The terms object, container, and node have certain connotations but they all essentially
mean the same thing as entry, the technically correct term.below we have a singleing of 11  It's DN is "cn=John
Doe,dc=example,dc=com"; it's R Doe"; and it's parent DN is ".
 dn: cn=John 
 cn: John Doe
 givenName: John
 sn: Doe
 telephoneNumber: +1 888 555 67891232
 mail: john
 manager: cn=Larry Smith
: inetOrgPersonorganizationalptop
The above entry is in LDIF format (LDAP Data Interchange Format). Any ithat you feed
into your DIT must also be in such a format. It isRFC2849
2
.
this guide will describe how to use it for central , LDAP is good for anything
that involves a laaccess to a mostly-read,-based (name:value)
ools.ietf.org/html/rfc4510t28492
backend.include an address book, a list of email addresses, and a mail server's1Install theserver the traditional LDAP management utilities. These are
found in packages slapd and ldap-utils respectively.
The ins of slapd will working co. In particular, itinstance can use to store your data. the suffix (or base DN) of this will be
determined domain name of the .something different, edit
and rewith one that will give you you desire. For, if you
want a suffix of  then your file would have a line similar to this:
1      hostnamehostnamerevert the change after packation.
Tuse a database.
Proceed with tslap
Since Ubuntu 8.10 slapd is designed to beed within slapd itself by dedicating a separate
DIT for that purpose. This allows one to dconfigurethout the need to restart the
service.figurationcollection of text-based LDIF files located under /
etc/ldap/slapd.d. This way of working is known by several names: the slapd-config method, the
RTC method (Real Time), or the cn=.still use the 
flat-fileslapd.conf) but it's not recommended; the ity will be eventually phased out.
Ubuntu now uses for slapd and treflects
that.
stall you were prompted to define aive credential LDAPbased for the rootDN ofbase., this user's DN is
cn=admin. Also , there is noaccount created for the
and you will thereforeexternally to LDAP in order to
access it. We will see how to do this later on.
Some classical cosine, nis, inetorgperson) come built-in with slapd nowadays. There is also
an included "core" schema, a pre-rfor any schema to wor3
1.2. PostInspectionprocess set up 2 DITs. One-config and one for your own data
(). Let's take a look.
• This is what thedatabase/DIT looks like. Recall that thisis LDIF-based and
lives under /:
   /
 ###
 #   ### cn=module{0}.ldifschema
 #  {0}core{1}cosin2}nis3}olcBackend={0}hdbDatabase={0}config-1}frontend1.ldif
Do not edi directly. Make changesLDAP
():
sudo ldapsearch -Q -LLL -Y EXTERNAL -H ldapi:/// -bdn
dn:dn:,
dn: cn=schema{0}core,1}cosin2}nisolc4
dn: 0}config1}hdbExplanation of entries:
•: global settings
•: aloaded module
•: contains hard-coded system-level schema
• cn=: thecore: the cosin: the nis: the: the 'hdb' backend storage type
•: frontend, default for others: (): (dc=exam):
x -LL:/// -b dn
dn:
dn: 
: base of the DIT
•:or (rootDN) for this DIT (set up during package
install)
1.3. Modifying/Populating your Database
Let's introduce some content to ouadd the following:
• a node called People (to store users)Groupsgroups)
• a group called miners
• a user called john
Create and call it add_content.ldif:
dn: ou=Peopl5
: oUnit
ou: People
dn: ou=GroupsGroups
dn: cn=miners,posixGroup
cn: miners
gidNumber: 5000
dn: uid=john,ineposixAccountshadowAccount
uid: john
sn: Doe
cn:display Doe
u10000userPassword: johnldap
gecosloginShell: /bin/bash
home: /home/john
It's important that uid and gid values in your ddo not collide with local values. Use
high number ranges, such as starting at 5000. By setting theldap high,
you also allow for easier control of what can be done with a local user vs a ldap one. More
on that later.
Add th:
ldapadd -x -D -W -f
Enter LDAP ********
adding new entry """
We can check that the ihas been correctly added utility'uid=john' cn 6switches:
• -x: "simple" binding; will not use theSASL method
• -LLL: disable printing extraneous
•: a "filter" to find the john user
•:certain ato be displayed (is to show all)
1.4 the slapdThe DIT can also be queried and modified.a few e• Use ldapmodify to add an "Index" (DbIndex) to your {, call it uid_index.ldif, contents:add: olcDbIndex
: uid eq,pres,sub
Then issue the commandmodify -Q f
"confirm the change in this way\
 '(1}hdb)' eq• Let's add a schema. It will firstbe converted to .find un
schemas in addition toones in thechema.
•trivial to remove . Practice addingon a test Before adding a, you should check which schemas are already installed
(shown is a default, ououtput):7\
c dIn the example we'll add the CORBA schema.
1. coco file schema_converttaininglines:
includ/core.schemallectivrbasinduaconfdyngroupinetorgpersonjavmiscnisopenldappolicyldapnpmi.schema
2outputldif_output.
3. Determine the index of the schema:
slapcat -f-F  -n 0 | grep corba
cn={1}When slapd injests objectssame t will  index for that
object. An index is contained within braces: {X}.
4. Use slapcat to 0 -H \
ldap:/// -l cn=corba.ldif
Theschema is now in8
5. Edit to arrive at:
dn:...
cn: corba
Alslinesbottom:
structuralO: olcSchemaConfig
entryUUID: 52109a02-66ab-1030-8be2-bbf166230478
creatorsName: 
createTimestamp: 20110829165435Z
entryCSN.935248Z#000000#000#000000
modifiemodifyYour  values will vary.
6. use ldapadd tonew schema to the addcn\addicn="
7. Confirm loaded schemasdn: cn={4For external applications and clients to using LDAP they will each need to
be specifnfigured to do so. Refer to the appropriate client-side do for
details9
1.5. Logging
Activity logging for slapd is indispensible when ing an-based solution yet
it must be manually enabled after software i. , only rudimentary messages
will appear in the logs, like any other , isvia
database.
comes with logging subsystems (levels) with each one conlower one
(additive). A good level to try is stats. 
3
 man page has more to say on the different
.ile logging.ldifhangetype: modify
add: olcLogLevel
: stats
Implement the change
This will produce a simount ofandwant to throttle back to a less verbose
level once your system is in production. While in thi mode your host's syslog engine
(rsyslog) may have a hard time keeping up and may drop:
rsyslogd-2177: imuxsock lost 228 from pid 2547 due to rate-limitingsider a change to rsyslog's co. In /etc/rsyslog.conf, put:
# Disable rate # (default is 200in 5 seconds; below we make the 5 become 0)
$SystemLogRateLimitInterval 0
And then rsyslog drsyslog restart
1.6. Re
The LDAP service becomes increasingly as more networked systems begin to depend on it.
In such an e, it is standard practice to build redundancy (high availability) into LDAP to
prevent havoc should ter become unresponsive.done through LDAP r.
maen/man5/.5.html100
 is achievedSyncrepl engine.changes to be sd using a
Consumer - Provider model. The specific we will  in this guide is a
co of themodes: refreshAndPersist and delta-syncrepl. This has the
push changed entries to the as soon as they're made but, in addition, only actual chanbe sent, not entire entries.
1.6.1.C
Begin byinganwithcontents and name it provider_sync.ldif:
# Add indexb.centryCSN eq
-UUID eq
#Load the syncprov and accesslog modules.odule{0}ModuleLoad
olc:
# Adatabase definitions2ConfiglcHdbConfig
: {2}hdb
olcDbvar/lib/ldap/olcSuffix: cn=RootDN: cndefault entryCSN,,reqEnd,reqResult,reqStartbOverlay=syncprov,={addOverlaySyncProvOverlayolcSpNoPresent: TRUE
olcSpReloadHint: TRUE1
# syncreplfor primary db
dn: olc#overlay AccessLogDBOps: writes
olcSuccess: TRUE
# scan theDB every day, and purg older than 7 dayPurge: 07+00:00 01+00:00
Change the rootDN in theto match the one you have for.
2. The apparmor profilewilladjusted forlocation. Edit
/etc/apparmor.d/local/usr.sbin.slapd by adding:
// r,** rwk,
directory, set up a databse config file, and reload t:
sudo -u openldap mkdir cpDB_CONFIGservicreload
3. Add the new content and, due tochange,ldapa
sudo service slapdTheis nowed.
1.6.2.And the.
1. by going through Section 1.1, “I” [p. 92]. Make sure the
is identical to t's.mschemas and the
databse suffix are the same.aconsum2UUIDSyncRepl
olcSyncRepl: rid=0=ldap://ldap01bindmethod=simple binddn="" 
 =secret searchbase= logbase="" 
 logfilter="(&(=auditWriteObject)(=0))" schemachecking=on 
 type=rretry="60 +" syncdataUpdateRef
olc: 
Ensure theahave the correct values:
• (server's hostname -- in this example -- or )
• binddn (the admin DN you're using)
•password (the suffixrid (Replica ID, an unique 3-digit that identifies the replica. Each consumer should have at
least one rid)
You're done. The twos (suffix:  should nowing.
1.6.3. Testing
Onction starts, you can monitor it by runningz1 -LLLQs base contextCSN
dn
: 20120201193408.178454on both theand the. Once the output
( in the above example) for both machines match, you
hav. is done in, this value will change and so 
consumer(s)103
If your connection is slow and/or your ldaplarge, it might take a whileconsumer'sprovider's. But, you will know it is progressing sincewill be steadly increasing.
If is missing or does not, stop and figure
out the issue before continuing. Try checking the slapd (syslog) and the auth log files
to see i requests were successful or itsto retrieve data (they
look like a lot of ldapsearch statements) return no errors.
To test if it worked simply query, on the, the DNdatabasseasee the user 'john'group 'miners' as well as the nodes 'People' and 'Groups'.
1.7. Access Control
The management of what type of access (read, write, etc) users should be granted to resources is
ccess control. The codirectives involved are called a lists or ACL.
When we installedpackage various ACL were set up automatically.look at a few
consequences of those defaults and, in so doing, we'll get an idea of how ACLs work and
how they'red.
To get the effective ACL for an LDAP query welook at the ACL entries of the
beingsose of the special  instance. The ACLs belonging to the
latter act asin case thformer do. Thes the second
to be consulted andto be applied is the first to match ("first match wins") among these
2 ACL sources. Thecommands will give, re, the ACLhdb() androntendAccesAccess: {0}to attrs=use,shadowLastChange by self write by anonymous
 auth by * none: {1}to dn.base="" by * read2}to *
  read
The rootDN always has full rights to it's. Including it in an ACL does provide anbut it also causes slapd to incur a pepenalty.config)' 0dn.exact=gidNumber=0+=0,cn=peercred      cn=external,cn=auth manage by * breakexactcn=SubschemaThe very first ACL is crucial:This can be represented differently for easier digestion:


 auth

 by * noneThis compound ACL (there are 2) enforces t:
• Anonymous 'auth' access id to the  attribute for the initial coto
occur. Perhaps counter-intuitively, ' auth' is needed even when  access to
the DIT is unwanted.remote end is connected, howerver, can occur (see
next point).
• can happen because all users have 'read' (due to '') the
.
• Tis otherwise unaccessible by all other users, ef the
rootDN, who has completeit.
• In order for users to change their own password, using passwd or other utilities, the
needs to be once a user hased.
This DIT can be searchedlyof '' in this ACL:
to *
 If this then you ACLs. To forceduring a bind request
you can alternatively (or in cmodified ACL) use the 'olcRequire: authc' 5
As previously mentioned, there is no aaccount createdase.
There is, however, a SASL identity that isfull  it. Its the localhost's
superuser (root/sudo). Here it is:

 will display the0}config: {Sinceuse a SASL mechanism when invoLDAP utility in
question and and we have seen it plenty of times in this guide. It is the. See
the command for an example.:
1.use sudo to become the rootinthe ACL to match.
2. T works via IPC (UNIX domain sockets). This means you must use
the ldapi URI format.
A succinct way to get allis like thiAccess=* olcSuffix much to topic control. See the man page for slapd.access
4
.
1.8. TLS
When ng to anit is best to do so using an encrypted session. This can
be accomplished using Layer Security (TLS).
Here, we will be our own  and then create and sign ourer certificate
as that CA. Since slapd is compilthe gnutls libraryuse the certtoolto
these tasks.gnutls-bin and ssl-cert packages:
sudo apssl-cert private key:ma.access6
sudo sh -c "--generate-privkey > /etc/ssl/private/cakey.pem"
3.template/fileca.info to define the CA:
cn = Example Company
ca
cert_signing_key
4seCA:
sudo\
--load \ 
--templat\
--outerts/cacert.pem
5. Make aserverprivkey \
--bits 1024 private/ldap01_slapd_key.pemldap01 in the filename with your se. Namingificate and
host and service thatusing them will help keep things clear.
6ldap01.info info file containing:
on = 
tls_www_server
encryption_key
expiration_days = 3650
The above is 10 years. Adjust accordingly.
7rver's ca-cprivkey \ile certinfo (a, our example assumes
we created certs using https://www.cacert.org):
dn: cn=configTLSCAFile7
olc:TLS
olcKeyFileKeyFileUse the ldapmodify command to tell slapd about our TLS workmodify 
Contratry to popular belief, you do not need ldaps:// in /etc/default/slapd in order to use. have just:
SLAPD_SERVICES="ldap:/// ldapi:///"
LDAP over TLS/SSL (ldaps://) is deprecated in favour of StartTLS. The latter refers to
an e session (listening on 389) becoming protected by TLS/SSL
whereas LDAPS, like HTTPS, is a distinct-from-the-start protocol that operates
over636.
Tighten up ownership and permissiondduser sudo chgrp
sudo chmod g+ro-Restart:Check your host's logs () to see if the server has started properly.
1.9. and TLS
If you have set up replication between servers, it is common pencrypt (StartTLS) the
traffic to prevent evesdropping. This isfrom using  with 
as we did above. In this sectionuild on that TLS-work.
The assumption here is thatandccording to
6, “” [p. 99] and have configured TLS for on theby
following8, “TLS” [p. 105].stated, the objective (for us) withis hilit.
Since we havewe will require the same on theIn addition to thiwe want to encrypttraffic. What remains to be done is to8
create a key andonsumer and then generate the
key/, to avoid having to other ,transfer the
necessary material over to 1. Oholding directory (whichedeventual transfer)'s
p:
mkdir ldap02-ssl
cdpldap02info file, ldap02.info,server, adjusting it's values2ConsumeGet a copy of the:
l/.
WeNow the Here we use scp (adjust
):
cd ..
scp - user@consumer:
2Consumer,
Configure TLS 109ap  
sudo ckey.pem
the i2_slapd_the as().
3for-side. Modify theolcaby
tacking on some TLS options. In  will seefirst time, how to change an
's value(s).consumer_sync_tlsolreplace: o
: ri
 credentials
 ll
  starttls=critical tls_reqcert=demand
The extra options specify, reat the consumer and that the CA
is required to verify the's identity. Also note the LDIF syntax for changing
the values of an ('replace').se chanl10
And restart slapd4heck to see that a TLS session has been established. In , providing
'conns'-level logging set up,ee messages similar to:
slapd[3620]: conn=1047 fd=20 ACCEPT from IP=10.153.107.229:57922 (IP=0.0.0.0:389)op=0 EXT oid=1.3.6.1.4.1.1466.20037STARTTLSRESULT oid= err=0 text=TLS tls_ssf=128 ssf=1281 BIND methodch=SIMPLE ssf=0RESULT tag=97
1.10. LDAP
Oncea working, need to install ln the client that will know
how and when to contact it. On Ubuntu, thistraditionally ad by installing the
libnss-ldap package. This package will bring in other toolsassist you in the configuration
step. now:
s
be prompted for details of yo. If you make a mistake you can try again
usinldap-auth-config
The results of the dialog can be seen in /etc/ldap.conf. If  requiresnot covered
in the menu edit this file 
No the LDAP profile for NSS:
sudo auth-client-config -t nss -p lac_ldapthe system to use LDAP :
sudo pam-auth-update
enu, choose LDAP and amechanisms you need.log in using LDAP-based 11
LDAP clients willrefer to servers ifis in use. I you
would have something like:
uri ldaThe request will time out and the(ldap02) will attempt to be reached if the(ldap01) becomes 
If you are goingto store Samba usersconfigure the Samba server to
e. See2, “LDAP” [p. 11
An a to the  isd, will
the nsc which is problably not wanted. Simply remove it afterwards.
1.11. User and Group Management
The ldap comes with enough utilities to manage thebut the long string of
options needed can make them a burden to use. The ldapscriptscontains wrapper scripts to
thesehat some people find easier to use.
package
Then edit the/.conf to a the:
SERVER=
BINDDN=''
BINDPWDFILE="scriptspasswd"
SUFFIX=''
GSUFFIX='ou=Groups'
UPeople'
MComputers'
GIDSTART=10000
UMNow, create t.passwd file to allow rootDN access to :
secho -n 'secret' >400“secret” with the actual password for your database's rootDN user.
Theare now ready to help manage your.examples of how to use
them12
• new user:
sudo ldapadduser george example
This will create a user with uid george and set the user's primary group (gid) to• Change aassworsetpasswd george
Changinguser uid=georgeNew 
 (verify): 
• Deledelete
• Add a groupgroup qadeleteAdd a user tousertogroup george qasee a memberUid for the qa group with a value of george.
• RemovfromfromTheremoved qa group.
•modifyuser script allows you to add, remove, or replacs.  uses
the same syntax as the ldapmodify utility.george
# About to mfentry :
dn:account
cn: george
uidNumber: 10011001georg13
logigecosdescription: User account:: e1NTSEF9eXFsTFcyWlhwWkF1eGUybVdFWHZKRzJVMjFTSG9vcHk=
# modifications here, end with CTRL-D.replace: gecos
gecos: George Carlin
Tgecos “”.
• A nice feature ofis the template system. Templates allow you to customize thes of user, group, and machine objectes, to enable the useredit /etc/
changing:
UTEMPLATadduser.template"
There are sampls in theCopy or rename the
.sample:
sudo cp examples/\

Edit the newto add the desirenew users with an of ine<user>,<usuffix>,<suffix><user>
sn: <ask>
uid: <user><uid><gid><home><shell>
gecostitle: Employee
Notice the <ask> option used for the sn . makeprompt you for it's
valuare in thethat were  here. Here is a complete list:
ldaprenamemachine
5ma1/.114
6
ldap
7
ldapfinger
8
ldapid
9
ldapgid
10
luser
11user
12
lsldap
13togroup
14
ldapsetpasswd
15
ldapinit
16
ldapaddgroup
17
group
18group
19machine
20group
21
ldapadd23rimarygroup
24user
25
1.12. Backup and Restore
Now we have ldap running way we want, it is time to ensure we can save all of our restore it as needed.
What we need is a way to backup the ldap(s), the backend  and
If we oses into, say, /export/backup,
we could use slapcat as shown in the script, called /usr/local/bin/ldapbackup:
#!6
http://adduser.1en/man1/user.1fing9id.1g11/lsldaptogrouinit78modify20machine.1.html
2renamesetp.5
BACKUP_PATH=
SLAPCAT=/usr/sbin/slapcat
nice ${SLAPCAT} -n 0 > ${}/config.ldif1example.com2access.ldif
chmod 640*se files are uncompressed text files containing everything in yours
including the tree layout, usernames, and every. So, you might want to consider
making an encrypted partition and even having the script encrypt those
files as it creates them. Ideally you should do both, but that depends on your security
requirements.
Then, it is just a matter of having a cron script to run this program as often as we feel comfortable
with. For many, once a day suffices. For others, more often is requiredn example of a cron
scriptetc/cron.d that is run every night at 22:45h:
MAILTO=backup-emails@domain.com
45 22 * * *  root   created, they should be copied to a backup server.
Assuming we did a fresh reinstall of ldap, the restore process could be  this:
sudo serstop
sudo slapadd -F/slapd.d -n 0 -lsudo 1.ldif
2sudo chown -R openldap:openldap/
vaart
1.13. Resources
• Theresource is the upstream do: www.openldap.org
26
• many man pages that come slapd package.ones,
especiallying the material presented in this guide:
slapd
27
slapd-config
28
slap29
2/
28/slapd.8.html
2
25/16
slapo-syncprov
30
• Other:

31
pa32
• Zytrax'sRocket Scientists
33
; a less pedantic but comprtreatment of LDAP
• A Ubuntu communitywiki
34
 page has a collection of notes
• LDAP System Aon
35
 (textbook; 2003)
• Packt's Mastering
367)
35/.5.html
38/.8.html
38/www.zytrax.com/books/ldap/
34
https://helpOpenLDAPServer
3oreilly.coldapsa/
3packtpub.com/OpenLDAP-Developers-Server-Open-Source-Linux/book7
2. 
This section covers the integration of Samba with LDAP. The's role will be that of
a "standalone" server and the LDAP will provide the layer in addition to
cotheaccount information that Samba requires in order to function
(in any of it's 3 possible roles). The pris anconfigured with a
that can acceptrequests.1, “Server” [p. 91] for details on
fulfilling thment. Once tis completed,decide what Samba to do for you and then  it a2.1. Software three packages needed whenng: samba, samba-doc, and
smbldaps.
Strictly speaking, the  ied, but unless you other way to
mavarious Samaba entities (users, groups, computers) in an LDAP context then
install itsosamba
2.2. LDAP We will noserver so that iomodate Samba data.perform three
tasks in:
1. Import a schema
2. Index some entries
3. Add objects
2.2.1. Sambto be used as afor Samba, logically, the DIT will need to usthat can properly describSuch attributes can be obtained by introducing a
Samba LDAP schema. Let's do this now.schemas and their installation see 4, “ the
slapd Database” [p. 96].
1. The schema is found in the nowIt neeunzipped and copied
to thechem8
s/LDAP/samba.schema.gz
sudo gzip -d
2. Have theation file schemthat contains thelines:in
3dldif_output hold output.
4.sambdn: cn={14}5. Convert tto LD:
sla0  -l cn=samba.ldif
6. generated file by removing index io arrive at:
dn:samba
Remove the bottom lines:
stb53b75ca-083f-102d-9fff-2f64fd123c95
creator080827045234.3414259
7. schema:
s cn\To query and view this nseacn 'cn=*samba*'
2.2.indices
Now that slapd knows about the Samba, we can set up some indices based on them.
Indexing entries is a way to improve pewhen a client performs a filtered search on the DIT.samba_indicechangetNumber egiduid eolcDbIndex: memberUuniqueMember eq,pres
sambaSIDsambaPrimaryGroupGroupTypeSIDListDomainNamdefault sube lda load the new indicesmodify
If all went wellsee using ldapsearch\
ldapo 
2.2.3. AddiLDAPNext,e the to match your e. The package is supposed
to come with ahelper script (smbldap-config.pl, formerly.pl) that will askneeded options but there is a bug
37
 whereby it is not installed (but
source code; 'apt-get sourc').
37bugs.launcserverguide/+bug/99717220
To manfpackage youcreate and edit the files /etc//
smbldap.conf andsmbldap_bind.conf.
Tpopulate script will then add the  . It is a good idea to
first make a backup of your DIT using slapcat:
cat -l backup.ldifbackup proceed to your:
sudopopulatereate a LDIF file containingSamba objects by e-e . This allook over the changes making sure s correct. If it is,
rerun ththout the '-e' switch. A, you can take theand import it's data
per usual.
Yournow has the necessary iuthenticausers.
2.3. Sambaultiple ways toSamba. F some commons
see Chapter 18, [p. 275]. use LDAP, edit it's
configura/etc/samba/smb.conf commenting out the default passdb backend parameter and
adding some ldapones:
#  = tdbsam
# LDAP Settings
ldapsam:ldap://hostname
   ldap suffix = userou=Peoplgrouou=Groupsmachineidmou=Idmapadmin dn = sl = start tlpasswd sync = yes
...
   add cript = sudo mbldap-useradd -t 0 -w "%u"values 
Restart samba to enew settings:
sudo restart smbdnmbd1
Now inform Samba r's password (the one set during the iof the slapd
package)passwd -weusers that you want to include in your new LDAP-backed Samba they
will, of course, alsobe given some of the extra a. The smbpasswd utility can do this
as well (your host be able to see (enumerate) those users via NSS; install and
either d oa usernameprompted to enter a. It will be considered  for that user.
Making it the same as before is reasonable.
To manage useaccounts use the utilities provided by the 
pacexamples:
• To add a nsa -PThe -a option adds theand the -P option calls
user is created allowing you for the user.
• To remove a useruserdelIn the above command,-r option tthe user's home.groupgroupadd -a groupname
As foruseradd, the -a.
• To make an user a member of a mod -mThe -mn add more than one user at a time by listing them in comma-separated format smbldap-groupmod -xSambaaccount22useusernameusername with the naworkstation. The -t 0reates the
without a delay, while the -w option specifies as . Also, note the add
in was changed to use.in thtoolsthat were add
38
del
39mod
40show
41passwd
42opulate
43useradd
44del
45info
46list
47mod
4usershow
49
2.4.For more ion installing ing Samba s
Networking [p. 275] of this Ubuntu Server Guide.ultiple places where LDAP and Samba is documented in the upstream Samba HOWTO
C
50
.
• Regarding the above, see passdb section
51
.
• dated (2007), the Linux Samba-HOWTO
52
 contains valuable notes.
• The main page of the Samba
53
 has a plethora of li
that may prove useful.
38groupad3del.8.html
4mo4showsmbldap-passwpopulateuser4infolistuseruser5samba.org/samba/docs/man/Samba-HOWTO-/
5passdb.html
5download.gna.orgdocs/samba-ldap3Samba#3
3.
is a network system based on the principal of a trusted third party. The other
two parties being the user and the servicewishes toe to. Not all services and
applications can use, but for those that can, it brings the one step
closer to being Single Sign On (SSO).iation of aserver, and some example clients.
3.1. new tohere are a few terms that are good to understand before setting up
. Most of the terms will relate to things you may be familiar with in other
s:
• Principal: any user, andserversdefined ass.
• Instances: are used fors and special a.
• Realms: the unique realm of control. Think of it as the
domain or group s and users belong to. Convention dictates the realm in
uppercase.ubuntu will use the DNS domain co (EXAMPLE.COM)
a.
• Key Distribution Center: (KDC) consist of three parts, a database of alls, theion the ticket granting server. realm there must be at least one KDC.
• Ticket Granting Ticket: issuServer (AS), the
(TGT) is encryptseknown only to theServer: (TGS) issuestickets to clients upon requests: confirm the identitywo. Onebeing aother a
service requestuser. Tickets establish an encryption keycure communication
d session.
• Keytab Files: are files extracted KDCand contain the
for aor host.
To put the pieces together, a Realm has, preferably more for redundancy, which
 When a userlogs into a  that is configured
for, the KDC issues a (TGT). Ifsupplied
credentials match,is and can the tickets izefrom
Server (TGS). Theallowt tentering another username and password24
3.2.Server
3.2.1.For this discussion, we will create a MITdomain following features (edit them to
fit your needs):
• Realm: 
• Primary KDC: kdc(1)
• Second22)
• U: steve
• Admin: steve/admin
It is strongly recommended thatworked users have their uid in a
different range (say, starting at 5000) than that of your local users.
Before itheserver a proped DNS server is needed for your
domain. Since Realm by comatches the domain name, this section uses the
figured in Section 2.3, “Primary Master” [p. 141] of the DNS
.
Also,is a time sensitive protocol. So if the local system time between a client machine
and the server differs by five minutes (by default), thewill not be able
. To correct the problem all hosts shouldtime synchronized using the
same(NT. NTP see4, “Time
Synchronisation with NTP” [p. 49].
The first step in creating aRealm is to install the krb5-kdc and krb5-admin-server packages.
From a terminal enter:
sudo apasked at the end of theo supply the hostname for thend Admin servers,
which may or may not be the same server,realm.realm is created's.the new realmkdb5_newrealm utility:
sudo kr
3.2.2. questions asked during ire used to the /etc/krb5.conf file. If you need
to a (KDC) settings simply e and restart5
daemon to refrom scratch, perhaps to change the realm name, you
can do so by typing
sudo dpkkrb5-kdc
1. KDC isrunning, an admin user -- the a --. It is
ro use a from your everyday. Using the kadmin.local
utility inpromptng asroot/admin@with
: addprinc sWARNING: no policy specified for; defaulting to
Enter for"": 
Re-e  created.quit
example steve is the, /admin is an, and 
signrealm. The "every day"a.k.a. the use, would be
steve, and only normal user rights.and steve with your Realm andname.
2. Next, the new needs to appropriate  List (ACL) permissions.
The ared in kdc/kadm5.acl file:
        *
This entry grants the ability to perform any operation on a in .gures with more restrictive privileges, convenient i an
that junior staff can use inclients. man page
for details.
3. NowforACL to take affecervicerestart
4. The new can be test kinitkinit's
e, use the klis to view ia
Ticket (TGT126
klist
Crecache: FILE:/tmp/krb5cc_1000
       
  Issued Expires
Jul 13 17:53:34  Jul 14 03:53:34  krbtgt/Where the cache filename  is composed of the prefix krb5cc_ and the user id (uid),
which in this case is 1000.need to add an entry into hostsDC so the
client can find the KDC.         kdc01
Replacing of your KDC. This usually happens when you have arealm encompassingnetworks sby routers.
5. The best way to allow clients to automatically determine the KDCusing DNS
to /etc/named/db:
_kerberos._udp..     IN SRV 1  0 88 .tc0. -adm._749passwd464Replace, kdc01, and kdc02p,
and s.
S ed instructions on s
DNS.
Your newnow ready to  clients.
3.3.one on your network, it is good practice to have a
 in case the primary becomes unavailable. Also, ifhat are
in(possibly using NAT), it is wise to place a
in each of those networks.
1. First, ipackages, and when askederberos and names enter the
name of the2. the packages installed, create the's host. From a
terminal prompt, enter7
kadmin -q "-randkey host/kdc0"
After, issuing any kadmin commands you will be prompted for your username/
aprincipal.
3. Extract the keytab file:ktadd -norandkey -k keytab.kdc024. There should now be ain the current directory, move the file to /etc/
krb5.keytab:
sudo mvkeytab
If the path to.kdc02 file isaAlso, you can list thes in a K, which can be useful when troubleshooting,
u:
sudo klist -kkeytab
The -k option indicatesis file.
5.rebe a kpropd on each KDC that lists all KDCs. on bothkdc/:
1an empty n :
sudo kdb5_util -s create
7. Now stpropd daemon, which listens for connections kprop utility. kprop is used
to transfer dump files:
sudo kpropd -S
8. on theaincipaldump krb5kdc/dump
9's and copy it to1"18
re is a host for before extracting the Keytab.
10. push thetoprop -r -f 
be a SUCCEEDED message if the propagation worked. If there is an error
message check on the for .
You may also reate a cron job to periodically updateo
, the willevery hour (note the long line has been
split to fit the format of this document):
# m h  dom mon dow   command
0 * * * *  && 
11. stash file to hold themaster kestash
12. rb5-kdc daemon  KDC:
sudo sekdc start
Theble to issue tithe Realm.test this by stopping
the k, then by using kinit to request a ticket. If all you
should receive. and
auth.log i.
3.4.Linux Clientconfiguring a Linux system as aclient. This will allow access to any
kerberonce a user has sly logged into the system.
3.4to toRealm, user and libpam-krb5 are needed,
along with a few others that are not strictly necessary but make life easier. To i
in a te:userlibpam-ccreds aut
The package allows simple confof PAM forion from multiple
sources, and the will cacheallowing you to login in cas29
theisThisis also useful for laptops that maye usingwhile on the corporatebut will need to be accessed off the
network as well.
3.4oe the client enter:
sconfigthento Realm.don't have DNSed with, the menu will prompt you for the hosty
 (KDC) and Realm  server.
The adds entries to theconf file 
entries similar to the:
[libdefaultsdefault_realm =...
[realm= }         kdc =admin_server}
If you set the uid ofto start at 5000, as suggested
in3.2.124],then tell pam to only try 
users with uid > 5000:
#should only be applied to ldap/kerberos users, not local ones.
for i in common-auth common-sessioccount common-password; do
 sudo sed -i -r \ 
 -e 's/pam_krb5.so minimum_uid=10005000/' \ 
 /etc/pam.d/$i 
done 
void being a(non-existent)password of a localld user when changing its using passwd.test theby requesting a ticket ui.Password for st:
Whenhas been granted, the details can be viewed using klis30
klist
Ticket cachDefault principal:
Valid starting       Service
07/24/08 05:18:56  1        renew until 07/2574 t/tmp/tkt1000
klist: You have no tickets cached
Next, use the  tlmodule to during login:
sudo-a -p kerberos_exampleupon  login ion.
3.5.MIT's version of, see the
54
 site.
• The Ubuntu Wiki
55
 page has more •Kerberos: The Definitive Guide
56
 is a great reference when setting up.
• Also, feel free to stop by the #ubuntu-server and #IRC channels on Freenode
57
 if you
have.
5web.mit.edu/Kerberos/
55Kerberos
5or4033/
5freenode.net/31
and LDAP
Most people will not usby itself; once an user ised (Kerberos), we need to
figure out what this user can do (authorization). And that would be the job of programs such as
LDAP.ng  between two servercomplicated, and adds an
additional userto. Fortunately,can beed to use an
LDAas a. This section coversing a primary and secondary
server to usefor the
The examples presented here assumeand.
4.1.ing
Firscessary schema neeloaded on anserver that has network connectivity
to theands. The rest of tassumes that you also have LDAPconfigured between at least. For iosee
Section .
It is also required for TLS and SSLons, so that trafficthe
KDC and LDAP server is encrypted. See1. for is a user we created with rights to edit the ldapMany times
it is the RootDN. Change its value to reflect your setup.
• To lchema into LDAP, on thekrb5-kdcente-ldap
• Next, erberosfile:
sudo u
sudo  /etc/ldap/schema/
• Theadded to the tree. The procedure to add a new schema
to slapddetailed in First, create aation file named , or a similar descriptive name,flines:2dke
2. temporary  toLDIF files:
mkdir /tmp/ldif_output
3. Now use slapcat to cofiles:
 -n0 -s \
"cn={12}kerberos" > /tmp/cn=ldifabove file and path names to match your own if they are .
4./tmp/cn\ file, the a:
dn: kerberos
And re end of the file:
st18ccd010-746b-102d-9fbe-3760cca765dc90111203510.32644The values will vary, just be sure ts are removed.
5.  with ldapadd:
ldapadd -W -f 
6. Add an index for the krb5nam:
dn: oadkrbName 37.s (ACL) replace: olcAccess
: to attr,Key by
  by anonymous auth by se* nonedn* by* readThat's it, your is nserve as .
4.2.Withit is time toe the KDC.
•npackages, from a teow editadding options to under the asections:  kdc = adefault_domain = edatabase_module = openldap_ldapconf}
...
[domain_realm4
...
[dldap_container_dn = d
[dbmodule = db_library = kldapldap_kdc_dn = # this objecthave read rights one realm , and realm sub-treesadmindand writeservice_password_file =kdc/service.keyfileservers = ldapsldap_conns_per5Change,, , and
ldatodomain, LDAP object, for your
network.use the kdb5_ldap_util utility to realm:
s-D  create -subtrees \
 s -H lda
•stash of the ed to bind to the. Thisis used by the
and ldap_kadmin_dn options instashsrvpw -f \

• Copy the :
scp ldap01:/etc/sssudo cp cacertcerts
Andldap/ldapuse the certificate:
TLS_CACERT 
T will also need to be copito allow the connection
s using LDAPS35now addrincipalsdatabase, and they willany other
s for replication. uadmin.loca
 addprinc -x dn="uid=steve,ou=people steve
 created.now be ,Key, krbLastPwdChange, and krbExtraData
 a user object. Use the kinit and klist
utilities to test that the user is indeed issued a ticket.
object is already created the -x dn="..." option is needed to add the. a newobjectreated in thetree.
4CoLDAP backend istoing one 
normaldatabase.. In 2. Next,to use the 63. stashLDAP bind4. Now, on thecokrb5kdc/.k5 Master Key stash to
the. Be sure to file over an such as scp, or on
media.
sudo scpsteve@kd:~
sudo mv 
Again, r with your actual realm.
5.(re)start the ldap server only,
sslapd restartkr:start
7. e twos (and by extension) are in sync.
You now have redundant KDCs on, and withyou should be
able to continue to e users if one, oneserver, orand oneserver become 7
4The Admin Guide
58
 has some addetails.
• see 5.6
59
 and theman page
60
.
• Another useful link is the krb5.conf 1
.see t and LDAP
62
 Ubuntu wiki page.
5krb5-1.6/krb5-1.6.3/doc/krb5-admin.html#-Kerberos-with-back_002dend
5Global-Operations-on-theLDAP-6quantal/en/man8/.8.html
65.5.html
62-ldap138
Chapter 8. Domain Name(DNS)
 is an Internet service that maps fully qualified domain
names (FQDN) to one another. In this way, DNS alleviates theremember.
 that run DNS are called name servers. Ubuntu ships with BIND (BerkleyNaming
Daemon), the most common program used for maintaining a on Linux.139
ns:
sudo apbind9
A very useful package for testing and tro DNS issues is the dnsutils package. Very often
these toolsinstalled already, but to check and/or installenter thednsutils40
2.There are many BIND9. Some ofcos are a caching
nameserver, primary master, and as a second.
• Whened as  BIND9 will find the answer to name queries and
when the domain isgain.
• As a server BIND9 reads the data for a zone from a file on it's host and is
authoritative for that zone.
• Ination BIND9 gets the zone data from anothere zone.
2The DNSfiles are stor/etc/bind . The file is /
etc/bind/namedinclude line filename which contains the DNThe line in theoptions file tells DNS where to look for files. All files BIND uses will be
relative to this
The file named /db.root describes the roots in the world. The servers change
over time, so thefile must beed now and then. This is usually done
as updates to the bind9The zone section defines a master server, and it isa file
mentionfile option.
It is possifigure the  to be 
master. A server can be the Start of (SOA) for one zone, while providing service
forzone. All thecaching services for hosts on the local LAN.
2.2. Caching N
The defaultis setup to act server. All that is required is simply a
IP Addresses of your ISP's DNS servers. Simply uncomment andfin
options:
forwarders1.2.3.4;5.6.7.8};1.2.3.4 and 5.6.7.8 with the IP Aactual.
, to enable the new.prompt:1bind93.1.2, “dig” [p. 146] for i caching.
2.3.Master
In thisbethe for the domain. Simply
replace FQDN ().
2.3.1. Forward Zone File
DNS zone to BIND9, turning BIND9 into aserver, the fs to editlocal:
zone "" {
 type masterfile ";
};
(Note, if bind will be receiving automaticfile as with DDNS, then use bind/
 rather thaboth here and in the copy command below.)
Now use an existing zone file as a template to  file:
sudo cplocalchange localhost. to the FQD
server, leaving the "." at the end. Change 1to the's  and
root. to a valid email address, but with a "." instead of the usual "@" symbol, again leaving
the the comment to indicate the domain that this file is for.
A recordbase domain,Also, create an ns,
the in this example:
;
; BIND data file for
;
$TTL    604800
@       IN      SOA    root. ( 2; Serial604800Refresh864try24192Expire)       ; Negative Cache TTLIN      A      1.10
;NS      42AAAA    ::1
ns     You must increment the Serial Number every time you make chang. If
changes before restarting BIND9, simplyonce.
Now, you can add DNS records to the bottom of the. 4.1, “Common Record
Types” [p. 150.
Many admins like to use the last date edited as the serial of a zone, such as 2012010100
which is yyyymmddss (where ss is)mad BIND9 neerestarteake
e2.3.2. ReverseNow thatand resolving names toazone is a. A
Reverse zone allows DNS to resolve an address to a name.
local and add the :
zone "1.168.192.in-addr.arpa"192";
168.192first three octets of whatever network you are using. Also,
namefile192 aly. It should match the first octet ofNow192127
Next ebind/db.192 changing the basically the same options asreverselocalXXX net 3
10PTR    
Tin theed on each change as well. For each
you configure in, that is for a different you need to
PTR record192.
the rfile restart BIND94. Master
Once has beend a is needed in order to the
availability of the domain should theb
First, onMaster zone transferallowed. Add the allow-transfer
option to the exampleanddefinitions       file        {1; };
};Replacedress of yourn.BIND9Nex, install the  way as. Then edit
the  declarationsForward 
zonesslave;4file ""masters0; };
};        
      type slave19292.168.1.10Primary In see something similar to (some lines have been 
of this doclient#39448: received notify for zone ''
zone /IN: Transfer started.
of '100.18.17/IN' from53:
 connected using#37531transferred serial 5completed: 1 messages, 
6 records, 212 bytes, 0.002 secs (106000 bytes/sec)sending notifies (serial 5)
20329'
zone8577825125Note: A zone is onlyred if theois larger than the
one on the. If you want to have yourDNS notifying
DNS Servers of zone changesalso-notify { ipaddress; }; in tolocal as shoexample below 11; }; 
 }5master;
 192";
 for non-zone files is /var/cache/bind/. This 
is alsoin AppArmor to allow the named dwrite to it.
isee Section 4, “AppArmor” [p. 166]6
3. 
Tcovers ways to help detecause when problems happen with DNS and BIND9.
3.1. Testing
3.1.1. resolv.conf
The fn testing BIND9 is to addserverto a hosts resolver. The Primary s well as another host to double check thinge
 :01
alsof  in case tbecomes 
3.1.2. dig
If you installed the test your setup uDNS lookup utility dig:
• After installuse dig alooto make sure it is listening on port 53.prompt:
dig -x see linesthe  in the command output:
;; Query time: 1 msec
;; SERVER:1.10)
• If you haveBIND9 as a "dig" an outside domain toe
q
dig ubuntu.com
Note the  toward the end of49 msec
After a second dig thereimprovemen7
3.1.3. ping
Now to demonstrate how applications make use of host namepingto
send an ICMP echo request. enter:
ping
This tests if thecan resolve n to an. T
output should resemble:
PING 56(84) bytes of data.
64 bytes: icmp_seq=1 ttl=64 time=0.800 ms213 ms
3.1.4. named-checkzone
A great way to bybind9Thisallotheation is correct  and
making the changes live.
• To test our enter from aprompt:
If everything iscorrectly output:load6
OK
• Similarly,thefileThe be3
OKof yourwill probably be different.
3.2. Logging
BIND9 has a wide variety of loggingThere are two main options.
The channel options where logs go, and the category option s what ito
log8
If noopnfigured the default :
logging {
    default { default_syslog;debug; };unmatched { null; };
};coBIND9 to send debug related to DNSto a separate
file.
• First,  ato specify which filetheto. 
channel query.log {      severity debug 3; 
    }; 
};
• Next,ategoryallthe query file   queries {; };
};
Note: the debugan be set from 1 to 3. If a level isn't level 1 is.
• runs as the bind user thefile must be created and
the ochanged:
sudo touch
sudo chown bind• Beforecan the new log file theproupdated. First,
apparmor.dnamed and add:
 w,
Next, reload the profile:
cat /etcusr.sbin.named | sudo apparmor_parser -r9
• BIND9 for the changes to take see the filel with query.a simple
ethe BIND9s. For coverage of advanced options s.2, “More
I50
4. References
4.1.  Typessome of the  types.
•: This record maps a to a hostname.
www      IN    A     2
• : Used to alias to an existing. You cannot CNAME
record pointing to another.
web     IN    CNAME  www
• MX recorddefine where email sent to. Must point to an, not a
CNAME.IN    MX  1   mail
mail   3
• ich servers serve copies of a zone. It mwhereservers are definedNS    2ns  s21
4.2. More 
• The DNS HOWTO
1
 explains moreforing BIND9.
• For in depth see Bind9.net
2
.
•
3
 is a popular book now in it's fifth edition.
• A great place to ask for BIND9 assistance, and get involved community, is
the on freenode
4BIND9 Server HOWTO
5
 in the.
www.tldp.org/HOWTO/DNSwww.bind9.net/
www.ordns5
BIND9ServerHowto19. Security
Security should aconsidered when installing, deploying, and using any type of computer
system. a fresh installation of relatively safe for immediate use on the Internet, it
is importaa balanced understanding of your systems security posture based on how it will
be used after deployment.
This chapter provides an overview ofrpics as they pertain to Ubuntu 12.10 Server
Edition, and outple measures you may use to protect your server and network from any
number of potentialthreats.152
1. User Management
User m is a critical part of maintaining a secure system. Ineffective user and privilege
often lead manyinto being compromised. Therefore, it hat you
 howthrough simple and ccount
techniques.
1.1. Where is root?
Ubuntu developers made a conscientious decision to disadministrative root account by default
in alls. This dean that thhas been deleted or that it may
not be accessed. It merely given a password which matches no encrypted value,
therefore may not log in directly by itself.
Instead, users are encouraged to ma tool by the name of sudo to carry out system
duties. Sudo allows an author to temporarily elevate theirsir owninstead of having to know thebelonging to .
This simple yetmethodology ccountability for all user actions, and gives theor granular control over which actions a user can perform with sais.
• If for some reason you wish to en, simply give it:
Cowith roots are not supported.
sudo passwd
Sudo will prompt you for your, and then ask you to supply a newfor root as
shown below:
sername: (enter your)
Enter new UNIX)
Retyperepeat)
passwd:updated s
• Touse the following passwd syntax: -l root
•read more on Sudo by checking out it's man page:
man sudoinitial user created by theer is a member of the group "sudo" which is
added to the file /etc/sudoers asudo user. Ifgive any other account full
root access through sudoadd them to the sudo group3
1.2. Adding and Deleting Users
The process for managing local users and groups is straight fodiffers very little from most
other operating systems. Ubuntu and other Debian based distributions, the use
of the "adduser" paa.
• us, syntax, and follow the prompts to give thea
and identifiable characteristics such as a full name, phone number, etc.
sudo adduser username
• To delete a  and its primary group:
sudo delandoes not remove their respective home folder. It is up to you whether or notdelete the folder manually or keep it according to your desired retention policies.
Remember, any user added later onsame UID/GID as the previous owner will now have
access to this folder if you have not taken the necessary precautions.want to change thesvalues to something more ,the root
account, and perhaps even relocato avoid future conflicts:-R root:root /home/username/
sudo mkdir /home/archived_users/
sudo mv• To tlock or unlocklysudo passwd -uadd orpersonalized,addgroup groupnameto a1.3. User ProfileWhen a new user is created, the tility creates a brand new home directory named /home/
username. The default profile is modeled  contents found in thof /
etc/skel, which includes allbasic4
If will be home to users, you should pay close attention to the user home
permissions to ensure confidentiality. ies inre
created with world read/execute . This means that all users can browse and e
of other usersies. This may not be suitable e
• To verify your currentyls -ld
The output shows that hasabl:
drwxr-xr-x  2   4096 2007-10-02 20:03You can using tchmod 0750Some people tend to use the recursive option (-R) indiscriminately which modifies all
child folders and files, but this is not, and may yield other undesirable results.
The parentalone is sufficient for preventing unanything
bearent.
A much more eapproach to the matter would be to modify the adduser global default
when creating folders. Simply edit the addusermodify
the DIR_MODE variable o that allies will receive the
correct
DIR_MODE=0750
• After correcting theusing any of the previously mentioned techniques, verify
the resultsresults below show thathremoved--- 1.4. Policy
A strong policy is one of the most aspects o. Many
s security breaches involve simple brute force and dictionary attacks against weaks. tend to offer any form of remote access involving your localsystem,
myou adequately address minimumcomplexity requirements, max
lifetimes, and frequent audiauthentication system5
1.4.1. MinimumLengthUbuntu requires alength of , as well as some basic
entropy checks. These values are controlled inpam.d/cos
outlined below.       [success=2 default=ignore]      pam_unix.so obscure sha512
If you would like to aminimum length to , c 
min=8. The modification is  min=8
Basic andlength rules do not apply to the aor
using sudo level commands to setup .
1.4.2E
Wheaccountmake it a policy to have and maximumge forcing users toirs when they expire.
• To easily view thestatus of sudo chage -lThe outputs interesting facts auser namely that there are no policies
applied:
Lasthange : Jan 20, 2008
e: neverinactiv   : never
Account Minimum days between: 0
M99999
Ndays of warning before: 7
• To set , simplyinteractive prompageis also an how you can explicit e date (-
E) to 01/31/2008,age (-m) of 5 day age (-M) of 90 days,
inactivity period (-I afte, and atimeW) of 14
daysation.
E11 -m 5 -M 90 -I 30 -W 14changessame s:6the new that established for the accountApr 19MayJan 31, 2008
5014
1.5. Other Considerations
Many ause alternate mechanisms that can be easily overlooked by even
experienced system s. Thero understand and control how users
e and gain aservices andon.
1.5.1. SSH Access by Disabled Users
Simply disabling/locking will not prevent a user frominto
remotely if they have set up RSA public key. They will still be able to
gain shellthe server, without the need for any. Remember to check the users
for files that will allow for this type ofed SSH access. e.g..
Remove or rename the.ssh/ in's home folder tofurther SSH
capabilities.
heckSSH coby the disabled user, as it is they may
have existing inbound or outbound. Kill any that are found.
Restrict to only s that should have it. For example, you may create a group
called "sshlogin" and add the group name as the value associated with the AllowGroups
locatedss
sshlogin
Then add your permitted SSH , and restart the SSH service. sudo service ssh restart
1.5.2. External User Database Most enterprise networks require centralized and access controls for all system
resourcehtoe users against external databases, be7
sure to dibothly and locally, this way you ensure that local fallbackion is not8
2. ConsoleAs with asarrier you put in place to protect, it is pretty tough to defend
against untold damage caused by someone with your e, f
theft of hard drives, power ordisruption, and so onconsole should be
addressed merely as one component of your overalltrategy. A locked "screen door"
may deter a casual criminal, or at the very least slow down a determined one, so it is still advisable to
perform basic precautions with regard to .instwill help defendissues that could otherwise yield very
serious consequences.
2.1. Disable Ctrl+Alt+Delete
First and foremost, anyone that hasthe keyboard can 
 key combination to reboot the serverhlog on. Sure,could
simply unplug the power source, but yostill prevent the use of thison a
production server. This forces an attacker to take more drastic measures, and will
ccidental reboots at the same time.eboot action taken by pressing the, comment out
the following lineinit/control-alt-delete.conf.
#exec shutdown -r now "Control-Alt-Delete pressed"9
3. Firewall
3.1. Int
The Linux kernel includes the Netfilter subsystem, which is used to manipulate or decide the fate
of network traffic headed into or through. All modern Linux firewall solutions use this
system for packet filtering.
The kernel's system of little use to a userspace
interface to manage it. This is the puiptables. When a packet reacheswill be
handed off to for acceptance,ion, or rejection the rules
supplied to it from via Thus, is all you neage yourif
you're familiar with it, but many frontends are available to simplify the task.
3.2. ufw - UncomplicatedThe defaultco tool fors ufw. Developed to easefirewall
, ufw provides iendly way to create an IPv4 or IPv6 host-based.
ufw  is initialed. ufw man page:
“ ufw is not intended to provide completefunctionality via its command , but
insteadn easadd or remove simple rules. It is currently mainly used for
firewalls. ”are some examples of how to use ufw:
• First, ufw neeenabla terminal prompt enter:
sudo ufw enable
• To open a port (ssh in this examplufw allow 22
• Rules can also be added using a numbered formatinsert 1 allow 80
• close an opened pordeny 22
• To remove a rule, use delete followed by the ruledelete o allow access from specific hosts orto a port. The example
allows sshhost0.2 to any ip address on this host60allow proto tcp fromport 220.2 with0/24 to allowthe entire subnet.
• Adding the --dry-run option to a ufwwill output the resulting rules, but hem.tis whatapplied if opening the HTTP port:
 allow http
*filter
:ufw-user-input - [0:0]outforwardlimilimit-accep### RULES ###
### tuple ### allow tcp 80 0.0.0.0/0 any
-A p tcp --dport 80 -j ACCEPT
### ENDj RETURNoutput -limit -m limit --limit 3/minute -j LOG --log-prefix "[UFW LIMIT]: "limit -j REJECTCOMMIT
Rules updated
• ufw can be byissee thestatus,status
• And for more verbose status iusstatus verbose
• Tostatus
If the port you want to open or close is defined in /ets, you can use
name instead of the number. In the above, replace 22 with ssh61
This is a quick i to using ufw. Please refer to the u.
3.2.1. ufw A Integration
s that open ports can include an ufw profile, which detailss needed for the
 to function properly. The profiles are keptufw/.d, and can be
edited if theports hchanged.which have installed aenter tn app list to allowing traffic , using an profile is accomplished by enteringllow Samba
• An extended syntax is as well:
ny app SambaSamba andwith theyou ared the IP range for
you.
There is nospecify the protocol for, because that  is
detailed in t. Alsat the app name replace numberdetails about which ports,s, etc arefor app info Samba
Not alls that requirea network port come withs, but if you have
profiled and want the file to be included package, please file a bug a
package in ubuntu-bug nameofpackage
3.3. IP Masquerading
The  is machines with private, non-routable on your
o access the Internet through the machine doing the m. Traffic from your privatedestinmust bed for replies to be back to
that made the request. To do this, the kernel must msourc of each packet so that
replies will be routed back to it, rather than to the privat, which
is imover t. Linux uses Connection Tracking (conntrack) to keep track of which
cs belong to which and reroute each return packet accordinglyleaving
is thus "ed" as having originatedUbuntu gateway machine.
This process is referred to in  documentation asSharing2
3.3.1. ufwcan be achieved using custom ufw rules.e current backend for ufw is iptables-restorerules files l/etc/ufw/*.ese a
great place to add legacy rules used without ufw, and rules that are moregateway or
bridge related.
The rules are split into two different files, executed before ufline
rulesafter rules.
packet forwarding n in ufw. Two files willbe
adjusted, in /etcufw change the DEFAULT_FORWARD_POLICY to “ACCEPT”:
="ACCEPT"
Then edit sysctluncomment:
net/ipv4/ip_forward=1
for IPv66/conf=1
• Now we will ado thebefore.. rules onlye the
filter table, and to enable the nat tabled. Add the following
to the top of the file just header comments:
# nat Table rules
*nat
:POSTROUTING ACCEPT [0:0]
# Forward teth1 through eth0.
-A -s-o eth0 -j MASQUERADE
# don't delete the 'COMMIT' line or thesrules won't be processed
COMMIT
The are not strictly necessary, but it is considered document your. Also, when modifying any of the sufw, mthese lines are
the last line for each table modified:For each Table a corresponding COMMIT statement is required. In these nly the nat ands are shown, butalsofor the raw and mangle tables3
 replace eth0, eth1, aropriates and • disable and re-enable ufw to apply the changes &&enable
should now be enabled.any additional FORWARD rules to the
. It is recommended that theserules be added to the ufw-beforeforward chain.
3.3.2.iptables used .ufw, the first step isIPv4 by editing /etc/
 the line
net.ipv4.enablealso .ipv6.con.ext, esysctl commthe new settings in theation file:
sudo sysctl -p
• can now be awith a singlerulmay differ slightly
:
sudo-t nat 16 -o pppThe aboveassumes that address space is16 and
Internet-facing device is ppp0. The broken down as follows:
• -t nat -- the rule is to go into the
•be appended (-A) to thechain
• 16aptrafficing from the 
•scheduled to be routed tnetwork device
• -- traffic matching this"jump" (-j target to
be manipulated as described above
• Also, each chain in the  where most or alliltering occurs)
has a default policy of ACCEPT, are a firewall in additgateway device,
you may have set the policies to DROP or REJECT, in which case youredneeds
to be allowFORWARD chain for trule to work4AACCEPTd-m state \
--state ESTABLISHED,RELATED -iACCEPT
s will allow all colocal networand all
traffic related to thoseto return to the machine that initiated them.
• Ifing to on reboot, which you probably do, erc.local
and add any commands used above. add the firstwith no filtering:
3.4. Logs
Firewall logs are essential for recognizing attacks, troyourrules, and noticing
unusual activity oninclude logging rules in for them to be
generated, though, andmust come before any applicable terminating rule (a rule with a
target that decides the fate of the packet, such asDROP,).
If youfturn on the following in logging on
To turoff in ufw, simply replace on with off in tcommand.
If using iufw, enterA INPUT --state NEW -\
NEW_HTTP_CONN: "
A request on port 80local machine, then, would generate a log in dmesg that looks like this
(single line 3 to fit this document):
[4304885.870000] IN=lo OUT= MAC=00:8:00
 SRC=DSTLEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=58288 DF PROTO=TCP
 SPT=53981 DPT=80 WINDOW=32767 RES=0x00 SYN URGP=0log will also appear in messages,syslog, andkern.log.
This behavior can be log.conf appropriately or by installing anding ulogd and using the ULOG target LOG. The ulogd daemon is a userspace
server that listens forinstructionskernel specifically fos, and can log to any
file you like, or even to a PostgreSQL or MySQL database. Making sense oflogs can be
simplified by using a log analyzing toollogwatch, fwanalog, fwor lire5
3Tools
There are many tools hestruct a completewithout intimate knowledge
of. For the GUI-inclined:
• fwbuilder
1
 is very powerful and will look to an a who has used a commercial utilityCheckpoint FireWall-1prefer a command-line tool with plain-text cofiles:
• Shorewall
2
 is asolution to figure an advancedfor any network.
3.6.• The Ubuntu3
 wiki page contains ion the development of ufw.the ufw manualsome very useful: man ufw.
• See the packet--for more.
• The nat-further details oning.
• The IPTables HowTo
6wiki is a great resource..org/
shorewalls:/ww.netfilter.org//HOWTO/.html
5
http://wNAT6IptablesHowTo66
4. AppArmor
is a Linux Module implementation of name-based mandatory a.confines individual programs to a set of listed files and posix 1003.1e draft capaind loaded . It uses profiles of an application to determine what files
and peherequires. Some packages will install their own, and 
can be found in the apparmor-package.
To from a te:
sudo aphave two modes of execution:
• Complaining/Learning: profile violations are permitted and logged. Useful for testing and
developing new.
• Enforced/Confined: enforc policy as well asth.
4.1. UsingTutils packcommand line utilities that yoo change the mode, find the status of a profile, create, etc.
•_status is used tocurrentprofiles.
sudo
• aa-complain places into mod/path/to/bin
• aa-enforceenforce enforce The  directory is wher are located. It can be used to
mathe mode of allEnter the fto place:
sudo*
T et*7parserloadthe kernelalso reload a 
loaded profile u. To :
cat/profile.namea
Toprofilr
• service:
sudoreload
• /disablealong withR 
 profile.
sudo ln -sdisable/parser -R
To ra disablremove the symbolic linprofile in
disable/. Then la option.
sudo rmdisable• can be, and  module unlenteringstop
sudo update-rc.d -fremove
• entestartapparmor defaultsname of theyou want to . Also,/
/ctual executable file path.for the ping command use /
bin/ping
4.2. Profilesare simple text files lapparmor.d/. The files are named 
full path to thetheyreplacing the "/" with "."
bin.ping is theprofile for the /bin/.two main type of rules used i:
• Path entries: which detail which files an can access in the file system8
• Capabilityprivileges a confined process is allowed to use.
As an example take a look bin.ping:
#include <tunables/global>
flags=(complain) {
  abstractions/base>consolesnameservice>
 y net_raw,setuid,
 inet raw,
  
 mixr,
  /etc/modules.conf r,
}
•: include statements from other files. This allowspertaining
to s to be placed in a common file.
•:profiled program, also setting the mode to.
•: allows the access to the CAP_NET_RAW Posix.1emixr,read and execute file.
After editing  file themust be reloaded. See Section 4.1, “Using for details.
4.2.1. Creating a Profile
• Design a test plan: Try to think about howrcised. The should
be divided into small test cases. Each should have a small description and list the steps to
follow.
Some standard are:
• Starprogram.
• Stopping the ReloadTesting all the commands supported by the init script.
• : Use aa-genprof to. genprofslapd9
• To get your included in the , file a bug in against
the7
 package:
• Include your  an.
• Attachto the bug.
4.2.2. When is misbehaving, audit messages are sent to the loge program aa-logprof
 scan for, review them and uprofiles.logprof
4.3.See  Guide
8
 for configuration options.
• F u with other leases see the Community Wiki
9
 page.
• The OpenSUSE10
 page is another introduction to.
• assistance, and get i
community, is the11
.bugsubuntu/+source/+filebugnovell.comapparmor201_sp10_admin?page=
apparmordata/book_apparmor_a10
http://en.opensuse.org/SDB:AppArmor_geeks
1freenode.net70
5. 
One of the mostorms of cryptography today is public-key. P
utilizes a pnd a private key. The system works by encrypting information. The can then only be decrypted
A common use for istraffic using a Secure Socket
Layer (SSL) or  connection., configuring Apache to
provide HTTPS, the HTTP protocol over SSL.a way to encrypt protocol
that does not itself provideon.
A is a method used to distributeotherabout a server and
the organization who is responsible for it gitally signed by aion
or CA. A CA is a trusted third party that has confirmed that tontain
certificate is accurate.
5.1. Types ofTo set up a secure server using, in most cases, you send your 
request (including your), proof of your company's identity, and payment to a CA. The
CA verifies the request and yourthen sends back afor your secure
server. Alternatively,create your own se.
Note, thats t bemost pes.
Continuing the HTTPS example, a CA-signedprovides two important capabia
:
• Browsers (usually) automatically recognizeand allow to be
made without prompting the user.
• When a CA issues a , it is guaranteeing the of tthat is
proviweb pages to the browser.
Most Web browsers, and computers, that support SSL have a list of CAs whoss they
accept. If a browser encounterswhose authorizing CA is not in the list, the
browser asks to either accept or decline the Also, other may
an error message whenself-sing.
The process of gettingfrom a CA is fairly easy. A quick overview is as follows:
1. private and public key pair.
2request the. Thcontai
about your server and the company hosting it71
3. Send t, along with documents provingWe cannot tell
you whichauthority to choose. Your decision may beyour past es, or
on thefriends or colleagues, or purely on monetary factors.decided upon a CA, you need to follow the insthey provide on how to
obtainthem.
4. CA is satisfied that you are indeed who you claim to be, they a digital.
5. Iison server, and confiappropriate to use the2. a Signing Request (CSR)
Whetheror generat, the
first stgenerate a key.
If twillby service daemons, such as Apache, Postfix, Dovecot, etc, a keypassphrase is often . Not having a services to start without
manual intervention, usually the preferred waya daemon.
This section will covea key with, and one without. The non-key
will thentothat with various.
Runnsicis cobecause you will not need
to enter theevery time you starice. But it is insecure and a
compromise of the key means a server as well.
Tthe keys for the run the fcommand from a
terminal prompt:
openssl genrsa -des3 -out server.key 2048
RSA p, 2048 bit long modulus
.++++++
.......++++++
e is 65537 (0x10001) phrase for:enter your. For best security, it should at least contain eight characters.
The miniwhen specifying -des3 is four include numbers and/or
punctuation and not be a word in a dictionary. Also remember that is case-sensitive.
Re-typeto verify. re-typed it correctly, the server key isd and
storfile.
key, the , and shufflenames72rsa -in.insecure
mv.
Thekey is now named, and yohis file the CSR.
To create the CSR,at a req -new -keycsr
It will prompt you. Ifcorrect, ito enter
Company Name, Site Name, Email Id, etcenter all these details, your CSR will be created
andbe csr file.submit this CSRa CA for processing. The CA will useand issue th On the other hand,create s using.
5.3. Self-Signedx509 -req -days 365csr -signrt
The athe 
your  rt file.is toin a preyou probably need a CA. It is not recommended to us.
5.4. Installing theYou can ie key fileandcrt, or theissued
by your CA, by runnings sudo cp server.crt /etc
keyprivate
Now simply configure ations, with the ability to use , to ands.Apache can prDovecotIMAPS and
POP3S, etc.
5.ion 
If the services on your network require more than a fews it may be worth the
aeffort to setup your own internal (CA). Usings signe73own CA, ss to easily trust otherusings issued ame CA.
1. First, directories to hold the CAand related files:
sudo mkdirCAnewcerts
2needs a few files to operate, one to kethe last serial number used
by the CA, eamust have a unique, and anotherrecord whichhave been issued:
sudo sh -c "echo '01ssl/CA/serial"
sudo touch/index.txt
3. The third file is a CAation file. Though not stricit is very convenient
when issuing s.ssl/openssl.cnf, and in the [ CA_default ]
change:
dir=# Where everkept
database        = $dir/CA     # index file.certs/cacert.pem # T
serial # The curren
private_key private/cakey.pem# The
4. Nexsrootrx509 -extensions v3_ca -keyout  -out 0asked todetails about the.
5. Now and key:
sudo mvprivatv/
6. You are now ready to start sign. The first item needed is a Signing
, see Section 5.2, “” [p. 171]
for details.a CSR,tosigned :
sudo openssl caconfig
 A key, youprompted to sign, and
again to commit the newthen see a somewhat large amount of output
related to creation.
7. There a new file,newcerts/01.pem, containing the same output. Copy
and pastebeginningline: -----BEGIN CERTIFICATE----- and continuing
tENDlines to a file  hos4
server wherewill be installed.maicrt, is a nice
descriptive name.
Subsequensnamed 02.pem, 03.pem, etc. with8. copy to the host that needs it, and the 
it. The default location to is. This enables
seusethout overly complicated file permissions.
For d to use a, you should also /etc/
ssfile to the/ directory on each server.
5For more detailed inson using csee the SSLs HOWTO
12
 by
tlpd.org
• The Wikipedia HTTPS
13
 page has more i regarding HTTPS.
• on OpenSSL see theHome Page
1Network Security with OpenSSL
15
 is a good in depth reference.
1tlSSL-enHttps
1openssl.org/
1or701/5
6. eCryptfs
is a POSIX-compliant enterprise-class stackedic filesLinux.  Layering
on tosystem layer protects files no matter the underlying, partition
type, etc.
During installation there is an option to encrypt the /home. This will 
neededand mount th, tco/srv to be encreCryptfs.
6First,the necessary packages. prompt enteecryptfs-utils
Now:
sudo mount -t ecryptfs /srv /srvfor some details on howshoulddata.
To test that files /srv are indeeeddefault folder to /srv:
sudo cp -r /et /srv
Now unmount /srv, and try to view a fil
cat /srvcron
Remounting /srv usingwill make the data viewable once again.
6.2. Automatically Mounting EPartitionsa couple of ways tomount anat boot. Thisa /root/.ecryptfsrc filemount options, aa file
residing on a USB key.
containing:
key=:_passwd_file=/mnt/usb/.txt
ecryptfs_sig=5826dd62cf81c615cipher=aeskey_bytes=166passthrough=nenable_filename_crypto=n
A to the signature in/sig-cache.txt.
:
=[secrets]
Now add /etc/fstab:
/dev/sdb1       /mnt/usb        ext3    ro      0 0
defaults 0 0 USB drive is mounted before the.
reboot and the /srv mounted using 3. Other Utilities
Theincludes several other useful utilities:
•setup-private: creates a ~/Privateto containi. This utility
can be run by unprivileged users to keep data private users on the system.mount-pri: will mount andrespectively, a users
add: adds a newto the kernel keyringanager: manages objects such as keysstatyou tometafor a file.
6.4.see theproject page
16
.
• There is also a Linux Journal
17
 article cover• Also, for mor optionsan page
18
.
• TheUbuntu Wiki
19
 page alsodetails.
1launcecryptfs
linuxjournal.com/article/9400
18
httquantal/en/man7/ecryptfs9eCryptfs17710. Monitoring
178
1. e m of essential servers and services is an part of system aon.
Most networkared for pe, availability, or both. T
iaation of Nagios for, and Munin
.
The examples in tuse twowiths server01er02. Server01
onfigured with Nagios to monitoron itself will also be setup
with the munin package to gatherrom the network. Using-node package,
server02sendto.
Hopefully these simplwill allow youon you.9
2. Nagios
2.1. I
First, oninstall the nagios package. In a terminal nagios3 nagios-nrpe-pluginbe a pasadmin user. The user's credentials are stored in /
etc/nagios3/htpasswd.users. To changeadmin, or add the
Nagios CGI scripts, use the htpasswd that is part of the apache2./ nagiosadmin
To add a user:
sudosteve
-nrpe-server
NRPE allows you to execute local checks on remote hosts. There are other ways of
aing this through other Nagios plugins as well as other checks.
2.2. Confire are a Nagios cand check files.
• : containfiles for the operthe nagios daemon, CGI files, hosts,
etc-plugins: houseservice: on theusr/lib/nagios/plugins/: heck binaries . To see the options of a check use
the -h option: /check_dhcp -hplethora of checksan beedfor any given host. For tNagioscheck disk space, DNS, and a MySQL hostgroup. The DNS
check2, and the will include both80
S1, “HTT” [p. 186 setting up Apache,Section 1, “MySQL” [p.
205] for MySQL.
Aly, there are some terms that once explained will hmake understanding Nagios
easier:
• Host: a server, workstation,device, etc that is being monitored.
• Host Group: a group of similar hosts.you could group all web servers, fileetc.
• Service: the service on the host. Such as HTTP, DNS, NFS, group gether. This is useful for grouping
HTTP for example.
• Contact: person to be notified when an event takes place.send emails,
SMS messages, etc.Nagios ischeck HTTP,SSH, current users, processes, and load
on the localhostping check the gateway.
Large Nagios is can be quite complex to. It is usually best to start small, one or
two hosts, get thinghe way you like then expand.
2.3.
• a hostation file for server02. Unless otherwise , run all these
commands on server01.cp/conf.d/_nagios2.cfg \
conf.d/cfgand fexamples, replace "server01",2"
172.18.100.100, and 1 host names and f your
servers.
2. Next, edit:
define hostuse generic-host  ; Name of host template to use
        host_namserver02aliasServer ddres
}
# check DNS service.
define        generic-servic       service_de DNS1check_command       check_dns!3. Restart the to enable the new:
sudonagios3 restart
• 1. Now add adefinitionMySQL check by adding theto
ices:MySQL hostgroupmysql-serversMySQcheck_mysql_cmdlinecred!nagios!secret!$HOSTADDRESSnotification_interval 0 ; set > 0 if you want to be renotified
}
2. A  now needefined.nagios3/conf.d/
 adding:
#group                 member,}
3. Theheckauthenticate to MySQL. nagios user enter:
mysql -u root -p -e "create user nagios ident'secret';"
Tuser will need to be added all hosts in the.
4nagios checLastNRPE to2.
O add thecheck :
# NRPE disk checksenrpe-diskcheck_nrpe_1arg!check_all_disk2
2. Now/nrpe.cfg changing:
allowed_hosts=
And below in the command area add:
command[]=isk -w 20% -c 10% -e
3.restart nagiosrestart
4. Also, now be able to see the host andfiles. To access them
point a browser to http://server01/nagios3. You will then be aname
and.
2has just scratched the surface ' features. -plugins-extra and nagiossnmp-plugins contain many mors.
•see Nagios
1
 website.
• Spethe Online Doc
2
 site.
• There is also a list of books
3
 rNagios and network :
•4
 page aagiosnagios.sourceforge.net/docs/3_0/
npropaganda/books/
4Nagios3
3. Munin
3Muninapache2installed. The default
is fine for running a munin server.
Server.munin.munin
install the munin:
sudo ap
3edit the /etc/munin/munin.conf :
## First our "normal" host.
[server02addressserver02 andactual hostname and for.
2.-node.conf to allow access by
server01:
allow ^172\.18\.100\.100$ with
Nowchanges to take effectrestartin gomunin, andsee links to nice graphs displaying
itandard muninfor disk, network,system.
Since this is a new install it may take some timegraphs to display anything useful84
3.3.  Plugins
Tpac checks a services such as DNS,
DHCP, Samba, etc. Tothe package, ente-extraipackage on both the server and node machines.
3See the Munin
5 for more detailsMunin6
 page includes ionplugins, writing
etc.
• Also, t book in German by Open Source Press: Munin Graphisches Netzwerk- und System7resource is 8
 page.munin.projects.linpro.no/
6wik7www.opensourcepress.de/index.php?26&backPID=178&tt_products=152community/Munin1851. 
A W is a software reaccepting HTTP requests from clients, which are known
asserving them HTTP responses along with optional data contusually
are WsML dand linked objects (images, etc.).186
1. 
Apachmost commo on s are used to serve
Web Pages requested by client computers. Clients typically rview using Web
Browser such as Firefox, Opera, Chromium, or Mozilla.
Users enter a Uniform Resource Locator (URL) to pby means of its Fully
and a path to the required resource.tohome
page of theeb site
1
 a enter only the FQDN:
wwwT
2
 sub-page,the FQDN followed by a path/The  protocoltransferis the Hyper fer Protocol (HTTP).
Protocolsover Secure Sockets Layer (HTTPS), and File
FTP), afor uploading and downloading files, are also supported.
Apache are often used in combination engine,Text
Preprocessor (PHP) scripting language, and other popularPython and
Perl. This is termed LAMP (Linux,MySQL and Perl/Python/PHP) and forms a
powerobust platformdevelopment and deployment of Web-based .
1The Apache2  is in Ubuntu LinuxApache2:
•  enter the fapache2
1Apache2 ed by placing directives in plain tex files. Theseare
separated betweenfiles and directories:
• apache2.conf: the maincofile. Contains settings that are global to Apache2.
• conf.d: contwhich apply globally Other packages that use
Apache2 to serve content may add files, or symlinks, to thisy.
• envvars: file where variables are set.
ubuntu.com7
• httpd.conf: historically, named ttpd daemon.
Now the file is empty, as mosoptions hmoved to the below
reference. The file can be used for user specificoptions that
effectmods-:to both load modules ande
them. Not allwill havefiles, however.
• mods-enabled: holds tos in /etc/apache2/. When a modulefile ied it will be enabled the next time arestarted.
• ports.conf: houses thethat determine which TCP portsis listening on.
• sitehasfiles forVirtual Hosts.Hosts
allowto bed for multiple sites that have separatationslike, sitesymthesitesdirectory.  when a in, the sited byactive onceIn addition, othermay using the Include, and wildcards can be
used to include many. Any may be placed in any of thes
files. Che mainare only recognized byhen it is started or
The server also reads a file containing mime document types;name is set by the TypesConfig
, via/mime.conmight als
additions and overrides, and is /etc/mime.types by default.
1.2.1. Basic Settings
This section explainsserver essentialparameters. Refer to the Apache2
3
 for more deApache2 ships with a virtual-host-friendl. That is, it iswith a
single default vir (VirtualHost) which can modified or used as-is if you
have a single site, a template for s if you have. If left
alone, thwill serve as yourthe site users will see if the URL
they enter dServerNameof any of your custom sites. To modify the
, edit/Ths set for host only apply to that particular. If a
is set server-wide and not defined within thesettingssetting is
use, you can define a Webmaster email address individual
es for each
configure a newor site, copy that file into the sory with a
name you choos:httpd.apache.org/docs/2.2/8site/defaultmynewsitefile to the new site using some of tdescribed below.
• The ServerAdminspecifies theto be advertised for the server's
a. Thealue is webmaster@localhost. This changed to an email
address that is delivered to you (if you are ). If your website has a
problem,ill display an ethisreport the problem
to. Find tive in your site'sfile in.
• The Listeport, and optionally theshould listen on.
If is not ill allassigned to the machine
it runs onfor tis 80. Change this to :80 to causly on your looso that it will not be to the Internet,
to ) 81 to change the portlistens on, or leave it as is for normal operation. This can be found and changed in its own file,is ands what FQDN should answer to. Th has no sorespond to allthat
do not match ain anotherjust acquired the domain
name ubunturocks.com and wish to host itUbuntu server, the value of thein you. Add tto
thefile you created earlier ().also wantto , since manyassume
the www prefix is a. UseAliasfor this. You may also use 
in.he fwill causeany domain request
ending in .
ServerAlias *
• TheRootshould lookfiles that make up the
siteis /var/www, as in If
desired,is value infile, and remember to create that  if
necessary!
Ena2ensite utility and restart sudo sapache2 restartreplace  with a more de. One method
is to name the file the 9use the a2disto disable sites. This is ful when troubleshootingproblems withs:
sudo1.2.2. Defaultcoof thedefault settings.if you add a
, the youetake precedence for thatFor avalue is used.
• The Index is thepage served by the server when a useran index ofory by specifying a forward slash (/) at the end ory namethe page http://www/this_/, he or she
will get either tpage if it exists, a serverdlist if it and
the Indexes option i, or a Permission Denied page if neither is true. Till try
to find one of the files listed indirective and will return the first one it finds.
Ifind afiles and if Optionsis set,ill and return a list, in HTML format, of the subd and files in thealue, found indir.conf is "index.html index.cgi index.pl
index.php index.xhtm". Thus, iffinin a rmatching
names,will be displayErrorDocumentallospecify a file forto use for error
event resource thaexist, a 404 error will occur. By
default,simplyHTTP 404 Return code. Readconf.d/
localized-error-pages for detailed insfor using , including locations of
example files.
•trites the log to the file apache2/access.log. You can
is on a per-site basis ins with the CustomLog,
or omit it to accept the  in other-vhosts-accessspecifyto which errors are logged, via the Error whosiserror.log. These are kept separate s to aid
in  youserver.LogLevel (thalue is "warn") and the LogFormat (see for
value).
• Some options are basis rather than per-server.isses. A stanza is enclosed in XML-like tags, like so:
</>
...
</>90
Thewithin aaccepts one or more of the values
(among others),d by spaces:
• ExecCGI - Allow execution of . are not executed if this not
chosen.
Most files should not beasThis would be very dangerous. CGI
scriptkept in aand outside your, and
only tory should have theoption set.theand tlocation foris cgi-bin.
• Includesserver-side includes. S allow an HTML file to  include other
files. See Apache SSI do (Ubuntu community)
4informatioNOEXEC, but dis#exec andcommands
in
•- Display a formatted list 's contents, if no(such as
index.html) exists in the.
For security reasons, thiusually not be set, and certainl on
. carefully on a per-
only if you are certain you want users to see the entire.
• Multiview - Support content-negotiated multiviews;disabled  for
. See theon
5
.
• SymLinksIfOwnerMatch - Only follow ss if the target file orhas the
same owner as the link.
1.2.3. httpdsome basic hation settings.
LockFile - The sets the path to the lockfile used when the server is compiled with
either USE_FCNTL_SERIALIZED_ACCEPT or USE_FLOCK. It must be
stored on the local disk. be left to the default value unless the logsis located on an
NFS share. If this is the casalue changed to a and to
that is readable only by root.
PidPidFile file in whichrecords its process ID (pid). This file
should only beby root. In most cases, it.
User - The Useruserid used to answer requests. This setting
determines's access. Any files inaccessible to this user will also beyour
website's visitors. Tfor User is "www-data".ServerSideIncludesmod/mod_negotiation.html#1
Unless you know exactly whatdoing, do not set tto root. Using
root aswill create large security holes for your.
Group - The Groupis similar to. Group sets the group under
servegroup is also1.2.4.Modulesis a modular servemplies that only the most basic functionality is included in the
coreExtended features are hrough modules which can be loaded into Apache2.a base set of server at compile-time. er isto use
loaded modules, thencan beseparately, and added at any time using
the LoadModule. Apache2 must be reto add or remove modules.
pilesallow the dynamic loading. s may be
conditionallyon the presence of a pamodule by enclosing them in an <IfModule>
block.install aodules and use them withrun
the command prompt to install the MySQL modulelibapache2-mod-auth-mysql
See the, forse the a2enmod utility to enable a 2enmod auth_mysql
a2dismod will disdis1.3. HTTPS
The mod_ssl module adds an important feature to theserver - the aencrypt
communications. Thus, when your browsmunicating using SSL, the https:// used at
the bof thein thenavigation bar.is in apache2-common package. E
a terminal enenmod ssl2
There is aHTTPSfile in-ssl. In
order forpra certificate and key file are also needeHTTPation will use generats. They are good for
testing, but the autoreplaced byto
the site oFor i on generating a key and obtainingee Section 5,
“” [p. 170]
Toefor HTTPS, enter thesite default-ssl
Theies /et andprivate are ths. If you
iin another make sure to change SSLandKeyFile ly.
Withnowd restart the service the new settings:Depending on how you obtained youryou may need to enter a passphrase whenstartsa secure server pages by typingyour_hostname/url/ inaddress
bar.
1.4. Sharing Write
than one user to be able to it will be necessary to grant write
peto a group they share in common. T example grants shared write 
to to the group "s".
sudo chgrp -R 
sudo find-type d -exec chmod g=rwxs "{}" \;fs If accessgranted to more group p, enable 
(ACLs).
1.5.Apache2contains in depthApache2. Also,
see the apache2-doc package for the officialdocs.
•Mod SSL7
 site for more SSL related.
7modssl3
• Apache Cookbook
8
 is a good resource for accomplishing Apache2s.
• For Ubuntu questions, ask in the.net
9
.
• Usually integrated with PHP and MySQL the Apache MySQL PHP  
 good.or1919/
9
http://freenode.net/
10ApacheMySQLPHP4
2. 
PHP is a general-purpose  suited for Web d. The PHP script can be
embedHTML. This sehow to install andPHP5 in Ubuntu System
w.assumes you have installeddServer.refer toctionsections in this documenanderespectively.
2PHP5 Unlike p perarin the base
system, PHPadded.
• PHP5 you can command in the tephp5 php5run PHP5 scripts fromline. To  yoinstall php5-cli
-clialso executewithout installing PHP5 Apache module. To this,
you shouldphp5-cgun the
-cgi
To use MySQL5 mysqlmysql you
-mysqlto use with pg
pgsql-pgsql
2ce youPHP5,your we. Ifphp5-
command prompt95Apache 2isd t. In other words, the PHP5
module is enabled inserver automatically whentPlease verify
if the filesenabled/php5.conf andload
exist. If they do not existseule using a2enmod command.install PHP5packages and2 module,restartWeb serverat restart serveach2.3. Testing
To verify your installationPHP5 phpinfo script:
<?php
  phpinfo();
?>save the content in a file phpinfo.php and place it underof. When point yoto htt/, it would display
values of various PHP5parameters.• see php.net
11
ation.
• There are a plethora of books on PHP. Two good books from are Learning PHP 5
12
 and
the PHP Cook Book
13
14
 pageiwww.php.php
5603/
1565926813/
16
3. 
Squid is a full-featured web proxy cache server application which provides proxy andices
forport , File nd other popular network
protocols. Squid can implement caching and proxying of Secure SSL)
andof er (DNS) lookups, and perform transpar. Squid also
supports a wide variety of, such as Internet Cache, (ICP) the CachingHTCP) the Cache Array Rout (CARP), and the Web Cache
Coordination. (WCCP)
The Squidis an excellent solution to aing server
needs, and scales branch offterprise level networks while providing extensive,
granular access control mechanisms and monitoring of critical Simple Network
SNMP). When selecting a computer use as a dedicated Squid
proxy, orservers, ensure youwith a laphysical memory,
as Squid maintains an in-memory cache for increaseance.tapsquidconfigured by editing the  contained within the /etc/squid/squid.conffile.s illustrate some ofwhich may be modified to
affect the bSquid server.-depth confof Squid, see thesection.
Prior tofilmake a copy of the original file and
protect it from writing so you willsettings as a reference, and to re-use as.
Co with the 
commands entered :
sudo cp.original
sudo c• To set your  to listen on 8888 insteadefault3128, change
the http_port as such:
88887
• e visiblein order to give t a hostname. This
hostname does notilybe the's In this example it is set to
weezie
weezie
• Using Squid control, you maye use ofservices proxied by Squid to be
only users with certainIP) addresses.we will
access by users of the 192.168.42.0/24 subnetwork only:
 to the bottom of the ACL section of yourfile:
acl fortytwo_network src
Then, add  to the top of accesshttp_access allowthe
 during normal business hour'employees of awhich is operating between 9:00AM and 5:00PM, Monday
through Friday, and which uses the 10.1biz
acl biz_hours time M T W T F 9:00-17:00
 file, file and restart the squid
seto echanges usingcommand
prompsqui
3Squid Website
15
Squid
16
 page.
www.squid-cache.org/
heSquid8
4. 
is an open source web framework for developing database backed web s. It
is optimized for sustainable productivitprogrammer since it lets the to write code
by favouring convention overation.
4Railsinstall Apache and install the Apache package, please
refer to Section . For inson installing MySQLMySQL” [p. 205]hav installed, you are ready to installpackage.
the Ruby bass and, yorails
4Modify thesite to setup your domains.
The first thing to change is theive:Root rails/public
Next, change the "">:
       FollowSymLinks MultiViews ExecCGIAllowOverride Allrder allow,denyallow from aAddHandler cgi-script .cgi
also e_rewrite module for Apache. Tmodenter the  coa te2enmod rewrite
Finallyneedthe ownershi and /
path/to/tmp dto the user used to run rocess:9
sudo chown -R www-data:www-datatmp
That's it! Now you have your Server ready for your
417
 website for more iAlso Agile Dwith Rails
1reat resource.
• Another plac is the11rubyonrails.org/
pragprog.com/titles/rails3/agile-web-d-with-rails-third-edition
1RubyOnRails200
5. Apache Tomcat
 is a web container that alloerve Java Servlets and JSP (er Pages)

T 6.0upport two different ways of running Tomcat.install
them as a classic unique system-wide instance, that will be started at boot time will run as the
tomcat6 u. Butalso deploy privatsrun with your own
user rights, and thatstart and stop by yourself. This second way is particularly useful in a
 server context where userstest on thivate Tomcats.
5.1. SllationTomcat server tomcat6
This willa  with just a default ROOT webapp that displays a minimal "It works"
page by default.
5Tomcat files can be found in /etc/tomcat6. Only a few commontweaksdescribed her se6.0 do
20
.
5.2.1. ChangingportsTomcat 6.0 runs a HTTP connector on port 8080 and an AJ09. You
might want those to avoid conflict with another server on the system. This is
done by changinlines/server.xml:
<Cport="8080" protocol="HTTP/1.1"       connectionTimeout="20000redirectPort="8443" />
...09AJP/1.3" 5.2.2JVM usedpreferably with OpenJDK-6, then try Sun's JVMsome
other JVMs.various JVMs ican set which used by setting
JAVA_HOMEdefault/tomcat6:jvm/java-6-sun
20
http://tomcattomcat-6.0-doc1
5.2.3. Declaring users and roles
Usernames, password (groups) can be defined centrally in  . In Tomcat
6.0 this is done in the/tomcat-users.xml file:
<role rolename="admin"/>
<user username="tomcat"="s3cret" roles5.3. Usi standard webapps
Tomcat is shipped with webapps thatinstall for, a or demo
purposes.
5.3.1. TomcatThe tomcat6-docs pac, packaged as ayou
can adefault at http://yourserver:8080/docs. it by enteri
co
5.3.2admintwocan beadminister thserver
using a web interfacethem tomcat6-adminone is the manager webapp, which
manager/html. It is primarilyget server status and restart webapps.
Access tois protected: youdefine a user with the
role "manager"tomcat6beforeit.
The second host-
create virtual hosts also
 role "admine tomcat6 user cannot  directory Some
in these admin(deployment, creation) need write access to
thatwant to use these e, to give users in t
y right202tomcat6-R g+w5.3.3examples test or demonstrate
and JSPthemexample proexamples
5.4. Using heavin dtesting scenarios where using a single 
instance doesn't meet the requirements ofon. 
in e with tools to help deploy user-oriented instances, allowing every user on
a system to run root rights) separate while still using thinstalled
libraries.
It is possible to runw and thin parallel, as long as
thuse the same .
5.i supporteverythingto run
the tetomcat6-user
5.4.2. create atomcat6-instance-create mynewwith all thesscripts. You
can fornstall your common  in the lib/ y andwebapps in
the webapps. Nare deploy.
5.4.3.ing yourfind the classic  in the conf/
.certainly editserver to default
ports used by to other that might be
running203
5.4.4. Starting/stoppcan start prompt
(supposinstance is located in th):
/bin/startup.shcheck the log for any errorhave a
java.net.BindException: Address a use<null>:8080 error, it means that the port
yo itaken and tchange it.top you 
hutdown.sh
5 Tomcat
2 iTomcat: The Definitive Guide
22
 is abuilding we with Tomcat.
• For abooks see the Tomcat Books
23
 list page.
• Also, see the24
 page.
tomca
2or3180/
2iki/Tomcat/Books
2Tomcat52042. Databases
Ubuntu provides two popular servers. They are:
• MySQL™
• 
They are availableain repository. This section explains hothese
205
1. MySQL
MySQL is a fast, multi-threaded, multi-user, and robust SQL. It is intended for
mission-critical, heavy-load production systems as well as for embedding into mass-deployed
software.
1o install MySQL,following:
sudo mys
As of Ubuntu 12.04, MySQL 5.5 is install Whilst this is 100% compatible with
MySQL 5.1 shouldinstall 5.1 to be a slave to other1
servers)install the -5.1 package instead.
ation process you will be prompted to enter a pasMySQL root user.
Once the installation is complete, the MySQL server started .un the
 to check whetheris running:
sudo netstat -tap | grep mysql
When you run this command, you shouldline or something similar:
tcp        0      0 localhost:mysql         *:*       LISTEN      2556/mysqlder is not running correctly,type the to start iysql restart
1You can/etc/mysql/my.cnf file to confibasic settings -- log file, port number, etc.MySQL to listen for connections from network hosts,bindaddress directive to the server's :
bind-ad=0.5192.168.0.5 with the appropriate address.ao daemon willbe restarted:6
sudo service mIf you would like topassword, in a terminal enter:
sudo 5
Tbe stopped, andnew.
1.3 Engines
e defaultation of MySQL provided by the Ubuntu packages is perfectly 
and performs well there are things you may wish to consider proceed.designed to allow data to be stored in . These methods are referred to as
eitheor storage engines. Two main engines that you'll be interested in: InnoDB
and MyISAM. S are to the end user. MySQL will handlly
under the surface, but regardless of which is in use,interactdatabase
in the same way.
Each engine has its own aand dis.
While it is possible, and may beous to mix and matchengines on a table level,
doing so reduces the effectiveness of the pe tuningdo assplitting thes between twoinstead of dedicating them to one.
• MyISAM is the older of the two. It can be faster than InnoDB under certain circumstances and
favours a read only workload. Some have been tuned arou (though
that's not to imply that they will slow under InnoDB). MyISAM also supports the FULLTEXT
data type, which allows very fast searches of large quantities of text data. However
only capable of locking an entire table for writing. This means only one process can update a table
at a time. As any that uses the table scales this may prove to be a hindrance. It also
lacks journaling, which makes it harecovered after a crash. Thelink
some points foration about using MyISAM on a 1
.
• InnoDB is a more modern, be ACID compliant
2
 which stransactions ared reliably. Writecan occur on a row level basis within
a table. That means pdates sin simultaneously. Data caching is
also handled in memory within theallowingon a more efficient
basis rather than file block. To meetce all journaled independently
of the main tables. This allows for much more reliable data recovery as data consistency can be
checked.
As 5.5the default engine, and is highly recommended ounless
you have need for unique gine.
mysqlblog.com/2006/06/17/using-myisam-in-/
enACID7
1.4. Advanced co
1.4.1.tuned 
a number of parameters that can be adjusted within MySQLthat
will allow you to improve theof the server over time. For initial set-upfind
Percona's my.cnf generating tool
3
 useful. This tool will help generate a that will be much
more optimised for yourserver capabilities and your r.
Do not replace your existingwith one if already loaded data into th. Some of the changesin the fileincoas they alter how data is
stored on the hard disk andunable to start MySQL. If you do wish to use it and
dataneed to carry out a mysqldump and reload:
--all-databases --all-routines > ~/fulldump.sqlthen prompt you for the root before creating a codata. It is amhere are no other users or processes using thewhitakes place. 
on how much data you've got in your, this may take a while. You won't see anything on the
screen during this process.dump has been completed, shut down MySQL:stop
Now backup the originalandwith the new one:
smy.cnf /etc/my.cnf.backuppath/to/new/
Then delete and re-initialisespace and ois correct before restarting
rm -rf mysql/*
sudo mysql_install_db
smysql:start mysqlall that's left is to re-import. To give us an idea of how far the import process has got'Pipe Viewer' utility, pv,eshows how to install and use pv for
this case, but if you'd rather not use it justpv with cat in thcommand. Ignore any
ETA times produced by pv, they're basaverage time taken to handle each row of the file, but
the speed of inserting can vary wildly from row to row withs:tools.percona.com/members/wizard8
pv
pv | mysql
Once that is all is good to go!
This is not necessary for alchanges. Most of the variables yohange
to improve are adjustable even e server is running. thing,
o have a good backupconfig files and data before making changes.
1.4.2. MySQL Tuner
 is a useful tool that will connect to a running MySQL instance and offer suggestions
for how it can be best configurThe longer thrunning for, the
better the adtuner can provide. In a econsider waiting for at least
24 hoursunning the tool.get install mysqltuner Ubuntu repositorie
Then once its been installed, run it:
and wait for its final report. The top sectios general i about theserver,
and the bottomtuning to alter in your my.cnfse can be
altered live onwithout , look tofficial MySQL do (link
in Resources section) elevantto change in.is part of anreport fromdatabase which shows there may be some benefit from increasing
the amount of query cache:
-------- Recommendations -r:
    Run OPTIMIZE TABLE to defragment tables for better
    Increase table_cache gradually to avoid file descriptor limits
Vto adjust:
    key_buffer_size (> 1.4G)
    query_cache32M)
   (> 64)
    innodb_buffer_pool_size (>= 22G)
One final comment on tunings: Whilst we can broadly say that certain settings are the best,
from o.hat works best for Wordpress
might not b for Drupal, Joomla or proprietarys. Peis dependent on
the types of queries, use of indexes, howdesign is and so on.find
it spend some time searching fortuning tips what you're
using it for. Once you get past apoint any adjustments you make will only result in minor
improvements, and you'll be better off either improving the, or looking at scaling up yourethrough either using more powerful hardware or by adding slave servers.9
1.5.
• See the MySQL Fullis both online and offline formats  MySQL Developers
portal
5
• ForSQLsee  Using SQL Special Edition
6
 by Rafe Colburn.
• The 7
 page also has usefu.
4ysql.com/
5
http://dev.mdoc/www.informit.com/store/product.aspx?isbn=0768664128he10
2.is an object-relationalystem that has the of traditiorcialystems with enhancements to be found in next-generation DBMS systems.
2, run the fin the command prompt:ostgree instalyou should the serveryour needs,
although the deis viable.
2connection via TCP/IP is disabled client authentication
methods. IDENT method is used for postgres and local users, unless otherwised. or's Guide if you onfigure
alternatives like8
.
Tdiscussion assumes that you wish to enable TCP/Iions and use the MD5
method for co files are stored in the /etc/p/
<version>/main directoryif you install9.1, theation
9.1
Toid, add entries to9.1/main/
pg_ident.conf file. detailed comments in the file to guide you.
T, edit.conf
Locate the line #listen_addresses = 'localhost' and change it to:

To allow other computers to coyourreplacewith the
IPof your server, or ly to '0.0.0.0' to bind to all interfaces.
edit all other , if you know what you are doing! For details, refer to th or to the.
Now that we can, the next step is to set a for the
user. at a te thetemplat:org/docs/9.1/static/admin.html1
sudo -upsql template1
The above command connects toatabase as userconnect
server, you will be at a SQL prompt.SQLat
the psql prompt tothe
ALTER USERwith encrypted'your';
Aftering g_hba.conf to use MD5
 with user:
local   all        md5yorestart service to initialize the newation. 
prompt enter theto restart:-8.4 restartis not complete by any means

9
more .
2.3.As mentioned above the 10
 is an eresource. The guide is also
tql-doc-9.intothe
packagdoc-9.1
To view tenter file:///usr/share/do-doc-9.1/html into the ad of your 112
 page for more i.www.
1i122123. LAMP Applications
213
1. LAMP is (Linux + Apache + MySQL + PHP/) are a popular setup for Ubuntu
servers. There is a plethora of s written using the LAMP stack.
Somes are Wiki's, Content Systems, and
Software such as phpMyAdmin.
One advantage of LAMP is the substantial flexibility for ddatabase, weband scripting
languages. Popular substitutes forcludeand SQLite. Python, Perl, and Ruby
are also frequently used instead of PHP. While Nginx, Cherokee and Lighttpd can replace Apache.
The fastest way to get started is LAMP using tasksel. Tasksel is a Debian/Ubuntu tool that
installs related packages as a co-ordinated "task" onto your a LAMP
server:
• tasksellamp-server
it you'll be ablemosts in this way:
• Download an archive contaiource files.
• Unpack the archive, usually in a accessible to a.
• on where the source was extracted, to serve thConfthe.
• Run a script, or browse to a page of the , needed by the
.
• steps above, or similar steps, aredready to begiA di ofis approach is that not placed in system in
a standard way, which can cause confusion as tois installed. Another larger
is updatin. When a new version is released, the same process used to is needed to apply updates.
Fortunately, a already packaged, and are for
inway as non-. some extraand setup steps may be needed, however.
This section coverssome.4
2. Moin Moin
MoinMoin is a Wiki engine implemented inPikiPiki, and licensedGNU GPL.MoinMoin,ython-moinmoininstall apache.alling, please
.86] sub-section in 
186] section.Foring your first Wiki pleaseset of commands. Let us assume
tWiki named mywiki:
cd moin
sudo mkdir mywiki
sudo cp -R dataunderlayserver/moin.cgiho.hmod -R ug+rwXmod -R o-rwx mywiki
Now cto find your new Wiki mywiki. open /
etc/moin/mywiki.py file and change the line:
data_dir = '/org/mywiki/data'
to/data'
Also, below the option addunderlay_dir:
data_='/mywiki/underlay'
If the /does not epy/
config/wikifarmtoand do the above 
change.
named your Wiki as my_wiki_nameinsert a line “("",
r".*")” infarmconfigfter thewiki", r".*")”5d  mywiki,
apache2 and make it rea.ddsapache2/sitefile inside the
“<*>” tag:
### moin
  ScriptAlias /mywiki "moin.cgi"
  alias /moin_static193htdocs"
 htdocs>
  Order alloallow from all
  
### end mointhe 
restart icommand toapachYou can verify the and see if it works by pointing your we to
URL:
http://mywikidetails the
1
 web site.
2.4. References
• formation see the moinmoin Wiki
2MoinMoin
3
 page.moinmo.in3MoinMoin6
3. MediaWiki
 is an web based Wiki software written in the PHP language. It can e MySQL or
Database.ediaWikialso install Apache2, the PHing and
are the most common, choose one
depending on your neeto those sections in this manual for istructions.
Tmediawiki php5-gd
ediawikipackage.cofile .conf for  in /etcconf.d/
duncomment linefile to access# Alias /ediawiki
After you above line,Apache server and
urlediawiki/config
ad the “Checking e...”in this page.fix
many issues by carefully reading t.is completepy the LocalSettings.php file :
sudo mv /config//etc/want to edit in order to set the memory limit
(disabled by default):
ini_set( 'memory_limit', '64M' );
3.3. Extensions
The e add new and efor the 
give wiki as and end users the ability to customizto their r7downloads an archive file or checkout Subversion
repositorycopy it toalso add
the at the end of file:.
require_once "$IP//ExtentionName.php";
3ediaWiki
4• Ts’ Guide
5
 contains a wealth of infor new.
• Also, the s a .ediawiki.orgwww.pacMbook
6ediaWiki8
4. 
 is apecificallyforering MySQL servers. Written
in PHP, ed through a, provides a graphical interface foion tasks.you will neeto a MySQL either on the same host as
thaton, or on a host aover the network., 205]. :hpmyadmin
At the prompt choose which  to be conf The rest of t
will use Apache2 for the.
In a browser go to httname/p, replacing serveranme with the server's actual. At the login, page enter rootusername, or another MySQL user if you any setup,
and enter the's password.
Once logged in you can reset the root ifcreate users, create/destroys and
tables, etc.Theation files forare located. The main
file is /etc/config.inc.php. This fileoptions that apply globally
to.
To useto ahosted onserver, ain:
$cfg['Servers'][$i]['host'] = 'db_server';actual remoteserver name or . Also, be sure
that thhost has permissions to access the.
Once, log out ofnd back ibe accessing the new server.
.header.inc.php and config.footfiles are used to add a HTML header and
footer Another importantapache.conf, tis symlinked to /
econf, and isto serve9
site. Thedirectives for loading PHP,, etconingsee 186].Tdocomes installedpackage and can ed from the link (a mark with a box around it) under
logo. The official docs can also on7
 siteMasteringreat resource.
• A third isnet/home_page/docs.phpa-3r/book2204. File Serversmore than one computer on a singleAt some point probably need to
share files between them. In t we cover installing uring FTP, NFS, and CUPS.221
1. 
 is a TCP protocol for downloadingcomputers. In the
past, it has also been used for uploading but, as that method use encryption, user credentials
as well as data transferred in the clear and are easily intercepted. So if you are here looking for
a way to upload and files securely, see the section on OpenSSH in Chapter 6, Remoteion [p. 79] instead.
FTP works on a client/server model. The server component is called an FTP daemon. It continuously
listens for FTP requests from remote clients. When a request is received, it manages the login and sets
up the connection. For the duration of the session it executes any  sent by the FTP client.
an can be managed in two ways:
• Anonymous
• ed
In the mode, can by udefault user account
called "anonymous" or "ftp" and sending an email address as the In the mode
a user must have an account and aThis latter choice is very insecure and should not be
used except in special . Ilooking to transfer see SFTP in the
s-Server. User adirectories and files is dependent on the
defined for theused at login. As arule,dhide the
rootofserver and change it toHome. This hides the rest of the
file systemsessions.
1.1. vsftpd - Installation
vsftpd is an Ubuntu. It is easy to install, set uintain. 
vsftpdun the  commandvsftpd
1.2.FTPationnot coto allow anonymouswi
edit /etc/vsftpd.conf by changing:
_enable=Yesa ftp user is created with a h of /srv/ftp. This is the default FTP
If you wish to change this location, to /srv/files/ftp for example, simply create ain
anotherthe's:2
sudo usermod -dtp
the change restart vsftpd:
sudocopy any files andies you makethroughFTP to /
, or iuse.
1.3. Userusers and allow them to. If you
want users to upload files, :
writeESNow when system users login to FTP thtart in theiries y can, upload, create, etc.,users are not allowed to  to. T
setting, yo, andanon_uploadEnablingupload can be an extreme security risk. It is best to not enable upload on servers accessed directly Interneturation file consists of manyation parameters. The iabout each
 is config. Alr man page, man 5
for details of each.
1.4. Sec
There are options into help make vsftpd more secure. F users can be
limited toby ing:
chroot_local_user=YESalso limit a list ofjust3istchroot_list_file=
After the abova containing a 
one per line. Then/etc/ftpusers file is that are disallowed FTP access. Thelist includes
root, daemon, nobody, etc. To disable for additional users simply add them to the list.
FTP eusing FTPS. Dfrom SFTP, FTPS is FTP over Secure Socket Layer
(SSL). SFTP is a FTP like session over an S. A major difference is that
users of SFTP need to have a shell accou system, instead of a nologin shell. Providing all
users withmay not be ideal for some e, such as a shared web host. However, it
is possestrict such accounts to only SFTP andshell interaction. S
OpenSSH-Server for more.
FTPS, and at the bottom add:
sslAlso, notice the certificate and key related options:
rsa_cerssl/certs/ssl-cert-snakeoil.pem
rsa_private_keyssl/privatekeytheseare set toprossIn a
production these should be replacgenerated for the specific
host. ons s5, ., and non-ausers will be forced to use FTPSof /usr/sbin/nologin FTP, but have no es
shells adding the:
# /etc/shells: valid s
/bin/csh
/bin/sh
/usr/bin/esksh
/bin/krc4ttch
/bin/dash
/bin/brbascreen

This is necessary because,  vsftpd uses , and the /etc/pam.d/
vsftpdfile contains:
auth    required        pam_shells.so
The shells PAM module restrictsshells listed inshells file.
Most popular FTP clients can beed to connect The lftp command line FTP
client has the use FTPS as well.
1vsftpd website
1
 i.
• edoptions see the man page
2
.vsftpd.beasts.org/vsftpd_conf.html
maquantal/en/man5.5.html5
2. Network File System (NFS)
NFS allows a share and files with others over a network. By using NFS, users
and programs cafiles on remote lmost as if they were local files.
most notable benefits that NFS can provide are:
• Local workstations use less disk space because commonly used data can be stored on a single
machine and still remain atothe
• There is no need forhave separateon every network machine. Homeies could be set up on the NFS semade throughout Storage devices such as floppy disks, CDROM drives, and USB Thumb drives can be used by other
machines on This may reduce the removable media drives 
network. to installServenfs-kernel-serverYou can theto be exported by /etc/exports file. For
example:
/ubuntu  *(ro,sync,no_root_squash)
/home    *(rweplace * with one of the hosmats. Makedeclaration as as
so unwantedcannot aNFS mount.
To start, at a te:
sudo service  start
2.3. NFS Use the mountto mount NFSy from another machine, by typing a
similar to the mount example.hostname.com:/ubuntu /local/ubuntu
Tpoint must exist. There sno files or
sin the6
An alternate way n  is to add a line to the /etc/fstab file.
The line must state of the, y on the server being, and
local machine is to be mounted.
Thesyntax for the line in is as follows:
 nfs rsize=8192,wtimeo=14,intrtrouble mounting a, make sure the nfs is installed on your
client. enter commaapLinux NFS faq
3NFS Howto
4nfs
NFSv4Howto7
3. 
iSCSI (Internet Small Computer System Interface) is a that allows SCSto be
transmitted Typically iSCSI is a SAN (Storage Area Network)
to allow servers to access a large store of hard drive space. The iSCSIrefers to clients as
initiators and iSCSIas targets.
Ubuntu Server can bed as both an iSCSI iniator and a target. This guide provides commands
andation o setuptiator. It is assumed that you aiSCSI
target on your localand have the arights to coit. The ins for
setting up vary greatly between hardwarrs, so consult your vendor toe your iSCSI target.
3.1 Installas iopen-iscsi package. In ente
3.2 ,iscsi/iscsid.conf changing:
node.startup = automaticheck which targets are iscsiadm utility. in a
terminal:
sudo -m discovery -t st -p10
• -m: determines the mode thatin.
• -t: specifies the type of.
• -p: option indicates the target 
Change example toIfissee output :
10:3260,1 iqn.1992-05.com.emc:sl7b92030000520000-2
The iqn number and above will vary dhardware8now be able ttarget, andtarget setup you may
have to enter user . Login to nodenode --login
Check toat the new disk has been detected using dmesg:
dmesd
[    4.322384] sd 2:0:0:0: Attached scsi generic sg1 type 0797[sda] 41943040 512-byte logical blocks: (21.4 GB/20.0 GiB)843Write Protect is off6Mode Sense: 03 00 00 089Cache data un99Assuming drive cache: write through32303235312]  sda: sda1 sda2 < sda5 >57257325735ttached SCSI disk
[ 2486.941805] sd 4:0:0:332486.952093[sdb] 112640000576 GB/537 GiB)5419[sdb] 2486.9542008f 00 00 08692Writdisabled, read cache: enabled, doesn't
 support DPO or FUA60577]  sdb: sdb1486In the output above sdb isi. Remember this is just an example;you see
on your screen.
a partition, format the file system, and mounfdisk /dev/sdb
n
p
enter
w
The above are from inside the fdisk utility; see man fdisk for more detailed
i. c is sometimes more user friendly.
Nowit to /srv as:
sudo mkfs.ext41
sudo mount /srv9add an entry totoiSCSI drive during boot:
/desrv        ext4    defaults,auto,_netdev 0 0
It is a good idea everything is working as expected by rebooting the server.
3.3.Open-iSCSI Website
5
Debian page
6.org/ikSAN/iSCSI/30
4. 
The primary mechanism forrinting and print services is the Common UNIX Printing
System (CUPS). This printing system is a freely , portablelayer which has become
the new standard forin most Linux distributions.
CUPS manages print jobs and queues andnetworkusing theInternet
Printing P), while offering support for a very large range of printers, from dot-matrix
to laser and many in between. CUPS also supports PostScript Printer Description (PPD) and autodetection ofand  simple web-basedand aion tool.CUPSUbuntu computer, simply use sudo apt-get nd give the
packages to install as the first parameter. A complete CUPShas many package dependencies,
but they may all be specified on the samelineat prompt tCUcups
Upon authenticating with your user password, the downloaded and installed
without error. Upon the conclusion of installation, the CUPwill be started ally.
For troubleshooting purposes,accesserrors via the error log file at: 
cups/error_log. Ifdoes not show enough i to any problems
you encounter, the verbosity oflog can be increased  the LogLevel directive
if (discussed below) to "debug" or even "debug2", which logs , from
the default of "info". If you make this change, ro change it back once you've solved your
problem, to prevent thefrom becoming overly large. System server's behavior ised ts contained
in the file /etc/cups/cupsd.conf. The CUPSation file follows the same sthe
primaryr the Apache HTTP server, so users familiar with editing Apache'sshould feel at ease whent. Some examples of
settinhange initially will be presented here., so you willoriginal as a reference, and to reuse as file and protect it from writhe following
commands, issued 31
sudo cporiginal
sudo c• ServerAdmin: the emof the designated orserver,
simply edit theconpreferred text editor, and
add or modify the line accordinglare the  for
server, and your e-is 'bjoy@somebigco.com', then you would
 line to appear as such:
• Listen: on Ubuntu,  listens only on the loo
at127.0.0.1. In order to instructto listen on an actualdapter's
, you must specify either a, the, or optionally, an/port
pairingaddition of a . , if yourresides on a local
network at10.250 and you'd like to make it athe other systems
on this subnetwork,and add, Listen :631 # existingListen
Listen /var/run.sock socket 192.168.10.250# Lthe LAN interface, Port 631 (IPP)
In the example above, you may comment out or remove the to the Loopback address
() if you do not wish cupsd thatbut would rather have it only listen
on the of the Local (LAN). To enable listening for al
s for which a certainis bound, including, you could Listen
entry for thesocratessocrates:631  alls'socrates'
or by omittisten and using Port instead, as in:
port 631 on in the, view the
associated system manual page by entering the co:
man 
Whenever you make changes to the, you'll need
to restartscups restart2
4.3. Web 
CUPS nd monitored using a webwhich byis at :631/admin. The can be used to perform all printer
management tasks.
ve taskseithe root account
enabled on youror e as a user in the lpadmin group. For security reasons, CUPS
won't user that doesa.
To add a user to, run at the teusermod -aGusername
Further documentation  in the /Help tab of t.
4CUPS78cups.org/2335. 
The process of getting an email from one person to another  or the Internet involves
many systems working together. Each of thesemust be correcdprocess to
work. The sender uses a Mail User Agent (MUA), or email client, to send the message through one or
more Mail Agents (MTA), the last of which will hand it off to a Mail DeliveryDA)
for delivery to the recipient's mailbox, from which it will be retrieved by
usually via a POP3 or IM.234
1. Postfix
Postfi (MTA) in attempts to be fast and easy to
and secure. It is compat the MTA sendmail. This section ee postfix. It alsoset it up as an SMsecure connection
(for sending emails securely).
This guide cover sePostfixDomains, for ion Virtual
Domains and other as see Section 1.7.3, “” [p. 239].
1.1. I
postfix :
sudo postfix
Simply press return when the iasksthewill be done in
greater detail in the next stage.
1.2. Basic postfix,postfix
The user interfacedisplayed. On each screen, select thevalues:
•Site
• mail
• stev, loca
• No
•0/8 [::ffff:127.0.0.0]/104 [::1]/1280/24
• 0
• +
• all with the domainyou'll accept email,nd class your mail sesteve
username.
Now is a good time to decide which mailbox format you want to use.Postfix will use
mbo. Rather than edi direcuse the
postconf command toe all postfix s. Tstored in5
/etc/postfix/main.cf file. Later if you wish to re-configure a particular, you can either
run theor cmanually in the file.thefor Maildir:
sudo -e 'home_mailbox = Maildir/'
This will place new mail in /Maildir so you will neeyour
 to use the same path.
1.3. SMTP SMTP-AUTH allows a client to identify itself t on mechanism (SASL).
used to encrypt theprocess. Once
d thewill allow therelay mail.
1.e Postfix for using SASL (Dovecot SASL)smtpd_sasl_type = dovecot'path = private/auth-clienlocal_domain =security_options = noanonymousbroken_sasl_auth_clients = yeauth_enablerecipient_restrictions = \
permitenticated,permit_mynetworks,reject_unauth_destination'
The is a path relative to thqueue directory.
2. Next, generate or obtain a digital certificate for TLS. S for
details. This lso uses a (CA). For igenerating a Cs.ion ” [p. 172].
MUAs connecting to  via TLSrecogni
usedThisusing arom a commercial CA or
with a se that users stall/accept. For MTA to MTA
TLS certficates are never validated without advance agreement from the affected
ors TLS, unless local policy requires it, there is no
reason not to use. Section 5.3, “
 for more details.
3.have, Postfix to provide TLS encryption for both incoming and
outgoing mail_tls_level = may6_tls_note_starttls_offertls = /etc/server.kecertserver.crtls_loglevel = 1received_headmy= mai'
4. using your ownto si entesmtpd_tls_CAfilecerts/cacert.pem'
Again, abouts ,After running all the commands,isdand
has been creat.
Nole should look like this
1
.
The postfix initialation is complete.to restart t
daemon:
estartsupportsas defined in RFC2554
2
. It is based on SASL
3
.it is still to set up SASL beforeuse.
1.4.ing SASLtwo SASL ations Cyrus SASL and . Dovecot
SASL the dovecotbe installed. prompt enter the
Nextedit /etc/dovecot/dovecot.conf. In the auth default section uncomment the
socket listen option and change the following:
  {
    #master# Master socket provides access to userdb i. It's typically
      # used to give Dovecot's local delivery agentso itcan findlocations.
      #path =dovecot/auth-master
      #mode = 0600Default user/group is the one who startedauth (root)
1
../sample/postfix_cowww.ietf.org/rfc/rfc2554.txt222.txt7
      #user = 
      #group = 
    #}
    clientThe client socket is generally safe to export to everyone. Typical useisit to your so it can do SMTP AUTH lookupsing it.
      spool
      60
      user = postfix
      group}
  }let Outlook clients , iof
 add "login":
 s = plain loginDovecotrestart it withdovecot restart
1.5. Mail-Stack
Another oconfiguringis using the mail-stack-package
(previously packaged aspostfixackage will installandto use itand as a. The package alssfor IMAP, IMAPS, POP3, and POP3S.or may not want to runor POP3mail server., if you areing your server to be a mail gateway, spam/virus filter, etc. If
this is the case it may be easier to use the toAUTH.t, from a tehave a working , but there are a few options that you mayfurther
customize. uses the and key s, and in you should use and keyd for the host. have a d, in /etc/
p:8
sl-mail.pemkeyprimail.key
ThenPostfix1.6. Testing
 Now it is time to test the setup.
To see ifnd TLS work properly,telnet 25have established the connection to thetype:
ehlo
If you see the lines among others, then everperfectly. Type quit to exit.
250-250-AUTH LOGIN PLAIN
250-AUTH= 8BITMIME
1.7. introduces some common ways to determine the cause if problems arise.
1.7.1. Escaping chroot
Theostfixwill nstall into a chroot efor se.
add greater complexity when roblems.
To turn off the chroot operation locate line in thester.c:
smtp      inet  n       -smtpd
and modify it as followssmtpd
You will thenrestartnew .9
1.7.2. Log Filesends all log messages to mail.log.error and warnincan
sometimes get lost in the normal log output so they are also loggederr and /var/
log/mail.warn respectivelyentered into the logs in real timethe tail -:
tail og/mail.err
The amount of detail that is recorded incan be increased. Below are some
options for increalog level for some of the areas covered above.
• To TLS activity logging set the loglevel option to a value from 1 to 4.4'
•having trouble sending or receiving mail from a domainadd the domain
to the debug_peer_list parameter= problem.domain'
•crease theanydaemon process by e
master.cf and adding a -v entr edi entryunix-       smtp -v
It is important to note that after making onlogging changes above theprocess reloaded in order to reco: 
loadtiloggedSASL issuesset th options in
auth_debug=yess=yes
Just lik if you change atheload.options above can drasticallysent 
files.o retur level back to normal after you have corrected the
Then reload the daemon to take affect.
1.7Aing aserver can be a very complicated task. mayturn to
the munityed help40
A great place to ask forassistaget in the
also post a message toWeb Forums
5
.
For in depthUbuntu developers hig: The Book of6
.thealso has great doon all the different options
.
Postifx
8
 page has more .
freenode.netubuntu.com/support/webforumspostfix-book.com/postfix.org/.htmlPostfix41
2. Exim4
Exim4 is another Message  (MTA)d at the University of Cambridge for use
on Unix systems connected to the. Exim stalled in place of sendmail, although theof exim is quitto that.exim4exim4Eexim4-config
The user intelets youe manys.In Exim4 thefiles are split among files. have them in
one fileco in this.
All thein tare stored in /etc/exim4/update-exim4.conf
filer, either you re- wizard or manually edit this file
ufavorite editor., tothe
master:
sudo The , isand it isvar/lib/exim4/
config.autogenerated.
At any time, not. It is updated automatically every time you run updateun the costart Exim4 daemon.exim4 start
2This section coversing Exim4 to usewith TLS and SASL2
The first step is to create for use with TLS.to a tedoc/exim4-base/examples/exim-gencert
Now Exim4 needs to bed for TLSconf.d/main/03_exim4-
config_tlsdd:
MAIN_TLS_ENABLE = yesneed tothe saslauthd for authentication. .d/auth/30_exim4-config_examples and  plain__server and
logsections:
:
   driver = plaintext
   public_name = PLAIN
   server_condition = ${if{{$auth2}{$auth3}}{1}{0}}set_id = $auth2prompts = :
   .ifndef AUTH_SERVER_ALLOW_NOTLS_PASSWORDSadvertiseeq{$tls_cipher}{}{}{*}}
   .endif
#
 LOG"Username:: : :"
   # don't send system passwords over unencrypted connections1}{$auth21Additionally, in order for outside mail be able to conew exim server, new user needs
to be added into exim by us.
sudo adduser
Users should protect the password files withs.
sudo chown root:Debian-eximpasswd
s640Finally, update the Exim4and restart the service3restart
2provides details ontto provide for Exim4.install the sasl2-bin package.:

edit the /etc/default/cofile and set START=no to:
Next the  to be part of group
addusersasl
Now service startnoed withusing
2exim.org
9
 for• There is also an Exim4 Book
10
 • Another resource is
11
 page.exim.org/
uit.co.uk/content/exim-smtp-mai11Exim44
3.erver
Dovecot is a, written with security primarily in mind. It the major
mais: mbox or Maildir. explain how to set it up as an imap or pop3 server.
3dovecot in the command prompdovecot-imapd dovecot-pop3d
3you canfile.choose the
protocol you use. It could be pop3, pop3s (pop3 secure), imap and imaps (imap secure). A de
of these protocols is beyond the scope of this guide. For further i, refer to the Wikipedia
articles on POP3
12
 and IMAP
13
.
 POP3S are more secure that the simple IMAP and POP3 because they use SSL
e.chosen the, amend the
doveco:s = pop3 pop3s imap imaps
Next,  mailbox you would like to usemaildir and mbs. These
are the most commom. They both have their own benefits and are discussed on
theweb site
14
.hosen yourtype, and line:
mail_location = maildir:~# (for maildir)
orbox:~/mail:INBOX=/var/spool/mail/%u # (for mbox)configure your portTA) to transfer the incoming mail to
this type ofif it isone yonfiguredonfigured dovecot daemon in order to test your setup:dovecot restart
1enPOP3
Internet_Message_Access_Protocol
iki.dovecot.org/MailboxForma45enabled imap, or pop3,also try to log incommands telnet localhost
pop3 or imap2. something like , the installation has been
successful:
bhuvan@rainbow:~$pop3
Trying...
Co.localdomain.
Escape character is '^]'.
+OKready.
3.SLdovecot to use SSL and amends:
ssl = /etc/sssslkey
ssl_disable = no
disable__auth = noget the SSL certificate from aIssuing orcreate self signed SSL. The latter is a good option for email,SMrarely complain about "selfsigneds". , forabout how to create
create the, you will have and 
filecopy them to the pointed in the co.
3.4. Firewall for an er
To access server from another computer, you muste your firewall to allow
co to the server on the necessary ports.
• IMAP - 143
• IMAPS - 993
• POP3 - 110
• POP3S - 995
3Dovecot 5Dovecot 
16
 details.

Doveco6
4. Mailman
Mailman is an open source program for managing electronic mail discussions and e-newsletter lists.
Manymailing lists all the Ubuntu 
17
) use Mailman as their mailing
list software. It is powerful and easy to install and maintain.Mailman a  for the aors and users, using an external mail server to
send and receive emails. It works perfectlys:
•• Exim
• Sendmail
• Qmail
We will see howconfigurwith, the Apache web server, and either theor EximwishMailman with a, please
references section.
You onlyinstall oneand Ubuntufer
Agent.
4.1.1. Apache2
apache2 you.
4.1.2.For instructions on installing andingrefer to , “Postfix” [p. 234]
4.1.3. Exim4Exim42, “Exim4” [p. 241].
Once exim4 is installed, thes are storexim4 directory. Inby
default, the exifiles are split acrossiles.ange this behavior by
changing thevariableexim file:
dc_use_split_config='true'
4.1.Mailman, runcolists7mailman
It copies the ifiles in mailmant installs the  in /usr/lib/cgibin/creates list linux user. It creates thegroup. The mcessowned by this user.
4assumesly mailman, apache2, and postfix or exim4. Now
you justthem.
4.2An example Apac comes withnd is placed in /etc/mailman/
apacheoApache to use file itpied to /etc
site:
smailman//mailman.conf
This will setup a new Apacheon site. Now enable the newandApache:
sudo sapachMailman uses apache2 to render itsarein the
cgi-So, thurl will be htt/
mapach file if you wish to change this
behavior.
4.2ntegration, we will associate the domain listsmailing lists. Please
replacedomain of your choosing.use the postconf coadd thecoto /etc:
srelay_domains =transport_maps = hash:mailman_recipient_limit = 1'
Inster.cf double check thatthe:
mailman   un       n      pipe
  flags=FR user=list argvmailman/bin/postfix-to-mailman.py8
  ${nexthop} ${user}
It c script when a mail is delivered to a list.
Ato themap. file     mailman:
Now havebuild the  map -v
Thens:
postfix4.2Once Eyou can start the Exim server usicommand 
servistartmakework with Exim4, youExim4. earlier,
, Exim4 uses files oftypes. For details,
the Exim
18
 web site. To runwe should add new a file to types:
• Main
• 
• Router
Exima masterby sorting all these minis. So, the order of
these is very important.
4.2.4. Mainfiles belonging to the main type /cony a content to a new file, named 04# start
# Home dir for youri-- aka Mailman's prefix
#
# On Ubuntu this ""
www.exim.org9
# This is normally the same as ~mailman
MM_HOME=
#
# User and group fo, should match your --with-mail-gid
# switch toscript.  Value"mailman"
MM_UID=list
MM_GID=list
#
# Domains that your lists are in - colon separated list
# you madd these into localas well
domainlist mm_domains=hos
#
# -=
#
# These values are derived s above and should not need
# editing unlessmunged your
#
# The path of themail wrapper script
MM_WRAP=MM_HOME/mail/mailmanlist config file (used as a required file when
# verifying list addresses)
MM_LISTCHKlists/${lc::$local_partpck
# end
4.2.5.All theransport
 named  40mailman:
_   ipe
   command = MM_WRAP \
 '${if def:_suffix      {${sg{_suffix}{-(\\w+)(\\+.*)?}{\$1}}}post}}'
    current_ = MM_HOME
    homeuser = MM_UID
    group = MM_GID
4.2.6. Routerrouterrouter/in named 101  mailman_router:
  accep50
   require_files/lists//config.pck
   _optional = -bounces :+* :  -confirm+* : -join : -leaveowner : -request : -admin
   = main andcan be in any order. But
of rous must be the same. This particular file must appear before
the 20primary file. These twocontain same type
of information. The first file takes the precedence. For more the4.2.7. Mailman
Onces iyou can run itmailman startshould default mailing list.
:
sbin/newlist mailman
  email address of the person running the list: bhuvan at 
  Initialpassword:
  To finish creatinging list, you must edit your /etc/aliases (or
  equivalent) file by adding the following lines, and possibly
  `newaliases' program:
  ##
  mailman: "| po"-admiadmin mailmanbounces:      bouncesconfirmconfirmjojoleaveleavownerownerequestrequesubscribe:unHit enter to notifyowner...
  # 
We haveed eitheror Exim4 to recognize all emails fro. So, it is
not mandatory to make any new entries in. Ifade any changes to thefileensure that youthose services before continuing to next section51
The Exim4 does notabove aliases to forward mails , as it uses a discover
approach. To suppress thwhilethecan add MTA=None line i,mm_cfg.py.
4.3. ion
We assumea default i. cgi scripts are still in thecgi-bin/
mailmanbased afacility. this page, point
your uhostname/admin
Them, mailman, will appear in this screenclick the  name, it will
ask authentication passwordenter the correct, you will be hange
ve settings of this.reate a newcommand line
utility (ewlist). c.
4.4. Usersbased interface for users listinfodisplay the subscrimenter your , name (optional), and to
. An email invitationsent to youfollow the instin the email
4GNU-  Manual
19
HOWTO - Using Exim 4 and2.1 together
20
Als219list.org/mailman-instal
20exim.org/howto/mailman21.html
2Mailma52
5. Mail Filtering
One of the largest issues withday is the problem of Unsolicited Bulk Email (UBE). Also
SPAM, such messages may also carry viruses and other forms of malware. According to
some reports theseke up the bulk of  traffic on the Internet.
Twill cover integrating Amavisd-new, Spamassassin, and ClamAV with theMail
Agent (MTA).can also check email validity by passing it through external content
filters. These filters can sometimes determine if a message is spam without needing to process it with
more resource intensive applications. Two commonare opendkim and python-policyd-spf.
• is aprogram that can call any content filtering programs for spam
detection, antivirus, etc.
• uses a variety of mechanisms to filter email thecontent.
• ClamAV is an .
•implements a (Milter) for the DomainKeys d Mail (DKIM)
standard.
• enables Sender Policy Framework (SPF) checking with Postfix.
This is how the pieces fit together:
•accepted by• Tis passedanyfilters in this casethen processes used to scan If contains a viruswill reject the
message.
• Cleanwill then be analyzed byto find out iis spam.
 add X-Header lines allowi to further manipulateFor example,has a Spam score of over fiftyuld be automatically dropped
queuethe recipient ever having to be bothered. Another, way to handle flagged
is to deliver them to the Mail the user to dealmessage
as they see fit.
51, for ion installing and confi.the rest of thes enter the fapa s clamav-daemonpostfix-python
There are some optional packages that integrate withfor better spam 53pyzor razor
Alongain  compression utilities are needed tosome email
attachments:arj cabextract cpio lha nomarch pax rar unrar unzip zip
If someare not found, check that the multiverse repository is enabled in /etc/apt/
sources.list
 file, be sure to run sudo apt-get update before trying to install
again.
5Nowe to work together and fi.
5.2.1. ClamAVbehaviour ofll fit our needs.ClamAVation options, check
thefilesclamav.
Add the clamavthe amavis to have the appropriate access to
scan filedduser clamav amavis
sudo adduser amavis clamav
5.2.2.etectscomponents and will use them if they are present. This
means that there is no npyzor and razor.
default/to activate thedaemon. Change ENABLED=0 to:
ENABLED=1dstart
5.2.3.
Firstspam and antivirus inby editing /etc/amavis/conf.d/15-
content_filter_mode4
use strict;
#modify this file to re-enable SPAM through
# andchecking.
#
# Defaultmode
# Uncomment the two lines below to enable it
#
@bypass_virus_checks_maps = (
   \%, \acl, \$re);spamre);
1;  # insure a defined return
Bouncing spam can be a bad idea as the return address is often faked. Consider
conf.d/20-debian_defaults to set $final_spam_destiny to D_DISCARD rather than D_BOUNCE,
as follows:
      =;
you may want to a options to flag moreas spam:
$sa_tag_level_deflt = -999; # add spam info headers if at, or above that level
$sa_tag26.0; # add 'sed'atkill21.0; # triggers spam evasive actions
$sa_dsn_cutoff_level = 4; # spam level beyond which a DSN is not sent
If the server's hostname is different domain's  you mmanually set the
$option. Also, i receives mail for domains the @_acl
option willbe customized. 50-user file:= 'mai;
 = ( ,org" );
If youcoveyou can use the in theqw(.)ationeerestarted5
smavis re1. DKIM Whitelist
can beed to  addresses from domains with
valid Domain Keys. prdin the40-
policy_banks.ways to the for a domain:
• 'example.com' => 'WHITELIST',: will whitelist any addressdomain.
• 'any suof
that have a valid signature/ that
use the of  the parent adds from. This is usually used for discussion groups that sign their.
A domain can also haveconfigurations. the file, restart amavisd-new:In this context, once has been added tothe message will not receive
any anti-virus or spam filtering. This may or may not be the intended behavior you wish for
a5.2.4. Postfix
Forintenter tconf -e ' = smtp-amavis:[]:10024'
Next editand addto the end of the file:
     unix    2       smtp
        -o smtp_data_done_timeout=12send_xforward_command=yesdisable_dns_lookupsmax_use=20
10025 inet    n      smtpd=localmapsrelaysmtpd_classesmtpd_delay_reject=nod_client=permit56helosenderredatarpipeliningend_of_0/8rror_sleep_time=0oft_error_limit=1001ardclient_connection_count_limitratereceive_override_options=no_header_body_checks,no_unknownchecks
Alsoimmediately below the "pickup" service: -o  -o 
This will preventthat areto report on spam from being classified as spam.
NowContent with spam and s now enabled.
5.2.5 andWhen ng, if you choose to disable the bayesby
espamassassin/local.cf and use cron to unightly rules, the result can cause a
situation where a large amount of erro are sent to the amavis user viad-new cron
jobseveral ways to handle this :
•e your MDA to filteyou do not wish to see.
• Change -cronjob to check for use_bayes 0. edit
top before the test statements:
egrep -q "^[ \t]*[ \t]*0" /etc&& exit 0
5.3. Testing
First, test that theSMTP is listening:
te 10024
7
220  ESMTP  service ready
^]
In the Header ofgo tc you should see:
X-Spam-Level: 
X-Virus-Scanned: Debianat
X-Spam-Status: No, hits=-2.3 tagged_above=-1000.0 required=5.0 tests=AWL, BAYES_00Your output will vary, but the important thing isre are  and X entries.
5.4. e best way to figure out why somegoing wrong is the log files.
• Postfix logging see the , “” [p. 238] section.
•uses Syslog to sendo Thedetail can be
increased $log_level option to50setting the value
from 1 to 5.
= 2;
When log output is also.
• The ClamAV log level can beclamav/clamd.conf and option:
LogVerbose truell send logav.log.
After changing an log settings remember tothefor the new
to t Also, once the issue you are trois resolved it is a good
idea to change the .
5information onmaillinks:Doc
22
• ClamAV 3
 and ClamAV Wiki
24
www.ijs.si/software/amavisd/docs.html
ww.clamav.net/doc/latest/html/
2wikiMain/WebHome8
•Wiki
25
• Pyzor Homepage
26
• Ra7
• DKIM.org
28
•Amavis New
29
Also, feel free to ask in the 30
.
25ik
sourceforge.net/apps/trac/pyzor/
razordkim.org/
29PostfixAmavisNew
freenode.net2596. Chat A
260
1. n this sectiodiscuss how to install and configure a IRC server, ircd-irc2. We will also
Jabber, an instance messaging server.1
2. 
The Ubuntu rhas many Relay Chat servers. T ee the original
2, run the command in the command promp
Theation files are stored in /etc/ircd directory. The documents are available in /usr/
share/doc/
2The IRCcan be done file/ircd.conf.set the IRC
host name in this file line:
M:irc.localhost::Debian ircd default::000A
Please make sure you add DNS aliases for the IRC .ance, if you set
irc.livecipher.com as, pable in your
Domain Name Server. T be same as the
The IRC admin details can bedA:Or, IRC dept.:Daemon <ircdirc.org>:Client Server::IRCnet:add specific lines tothe list of IRC ports to listen on,Operator
credentialsclient , etc. the example example.gz.banner to be displayeIRC client, when the user connects to the server can be set in /
etc/ircd/ircd.motd file.
necessary changeco, you can usingcommand: restart
2be interested to take a look at othersUbuntu R. It
includes, ircd-ircu and ircd-hybrid2
•IRCD FAQ
1
 for moreabou Server.
1irc.org/tech_docs/ircnet/faq.html3
3. 
Jabber a popular instant message protocol is XMPP, an open standard foing,
and used by manycovers setting up a Jabberd 2 server on a local
LAN. Thiscan also be adapted to providingices to users over the
3jabberd2, in a terminal entejabberd2A couple of XMLfiles will be used jabberd2 for Berkeley DB user
.a very simple form of to
use LDAP, MySQL, PostgreSQL, etc for for user
First, edit /etc/jabberd2/sm.xml changing:
  <id>jabber</id> with the, or other id, of your server.
Now in the <storage> section <driver> to:
   <driver>db</driver>
Nexc2s.xmllocal:
  A<authrega<modulto:
    <module>db</module>restart to enable the new settingrestartserver using client like Pidgin for4
The ausingdata is that after beinged no
additional maintenance is. If you need more control over user accounts and anothe method is recommended.
3• The Jabberd2 Web Site
2
 containsoning.
• options see tInstall Guide
3
.
• Setting Up Jabber Server 4
 page has more i.
codex.xiaoka.com/wiki:start
3jabberdoc.org/
4SettingUpJabberServer2657. 
Versionis the art of managing  It has long been a critical tool for
programmers, who typically spend their time making smallsoftware and then undoing
thosehe next day. But the usefulness of vextends far b
bounds of the development world. Anywherefind people using computers to
manag thatoften, there is room for.266
1. Bazaar
Bazaar is a newystem sponsored by Canonical, the commercial company behind
Ubuntu. Unlike  and CVS that only support a centralmodel, Bazaar also
supports distributed, giving people the ability to collaborate more efficiently. In
particularis designed to maximize the level of community participation in open source
projects.
1bzbzr
1o introduce yourself to bzr, use the whoami command like this:
$ bzr whoami 'Joe Doe <joe.doe@gmail.com>'
1.3. comes with bundled do installed intobzr/html by default. The
tutorial is a good place to start. The bzralso ilt-in help:
$ bzr help
To learn more afoo command foo
1.4.  Integration
While highly useful as a stand-alone systemhas good, optional i with
1
,
theive system us and the broader
to manage and extend Ubuntu itself. For on how Bazaar can be used to
o projects, see  http://bazaar-vcs.org/2
.
launchpad.net//7
2.
is aystem. Using,cord the history of
source files ans. It managesirectories over time. A tree of files is placed into a
. Theis much like an ordinary file server, except that it remembers every
change ever made to.accessrusing the HTTP, you must iweb
server. Apache2 is proven to . HTTP subsection in the
Apache2 section toApache2. e
HTTPSdigital certificate in your Apache 2 .HTTPSthe digital
.
,sulibapache2-svn
2.2. Serveration
This step assiabove mentioned packages on your system.
and access the project.
2.2.1. Creat
Thcan be created fcommand vnadmin create /path/to/repos/project
2.2.2. Importing Filescreate theyou can import files into. To import a , enter
the  importimport/ file://3. Access Methodsies can be accessed (checked out) through many dmethods --on local
disk, orvarious networks. Alocation, however, is always a URL. The
table describes howURL schemes map to the access methods8
Table 17.1chema
file:// directaccess (on local disk)
http:// Access via WebDAV to-aware Same as http://, but with SSL encryption
svncustoman svnserve server
svn+ssh://svntSSH tunnel
In t, we will see how to configurefor all these  cover
the basics.dvanced usage details, resvn book
3
.
2.3.1. Dfile://)
This is the simplest of allIt does not require anyserver process to be
running. This is used to afrom the same machine. The syntax of the
command, entered at a terminal prompt, is as follows:
svn coorlocalhostIf you do not specify the hostname, there are three foes (///) -- two for the(file, in this case) plus the leading slash in the path. If you
use two).
permissions depend on filesystem . If the user has read/write,
he can checand commit 
2.3.2(http://)
,snippet between the > and </> elements in /etc/
apachdefault, or anotherile:
 <Location /svn>
  DAV svn
  SVNPath /home/svn
  AuthType Basic
  AuthName "Yourname"svnbook.red-bean.com9
  AuthUserFile /etc//passwd
  Require valid-user
 </Location> 
The aboveation snippet assumes thaties are nder
using svnadmin command. Theyible using http://
hostname/svn/repos_name url.
or commit files to yourover HTTP, theshould be
oe HTTP user. In Ubuntu systems, normally th is www-data. To change the
ownership offiles enter the:
sudo chown epos
By changing the ra you will not be able to import or
i by running svn :/// command as any user other
than
Nex file that will contain user details.
To file issueat aprompt file and add
the first user):
sudo htpasswd -c user_name
To add users omit the "-c" option as this option replaces the old file. Instead use this formhiswill prompt you topassword.pasuser is added.
Now, tyou can httsvn
The password is transmitted as plain textare worried aboutsnooping, you
are advised to use.next section.
2.3. )
Acces is similar
to http://ithe 2 Twithadd the abovecoto /etcsites/default-ssl.isetting upith SSL see 3,
“HTTPS” [p. 191].ssued by a signing authority. install your
own se70
nd d a, pleaseabove section! The  are
exactly the same,e protocol. You must use https://.
2.3.4.(svn://)is created, you can tcontrol.edit the  /
/conf/svnserve.conf file toto
set up uncomment thelines in theation file:
# [general]
#-db = passwd
linesmaintain the user listsswd file. So, file
passwd  in and add the new user.is as username =filevia the svn:// , either  or a 
machinerun svnsesvnserve c s$ -d --foreground -r
# -d -- daemon mode
#- run in (useful for debugging)
# -r -- root ofto serveu:
-helprun t,tarts listening on default port (3690).project
,co svn://project project --user_name
Based on server, it prompts for.areed, it checks out
the code from. To synchronize thewith the local copy, you
update sub-of th,
cd project_dir ; svn updatdetails about using eacmanual. For
example, toco (checkout) command, please from  promptelp71
2.3.5svn+ssh://)
Theand seis same asvn:// method.
. followed the above step and started theerver
using 
It is also assumed that the ssh server ison that machine and that it is allowing incoming
co. To confirmtry to login tousing sscan login, ever
perfeccannot loginaddress it before continuing further.
The  protocol is used to ausingThe
data transfer is encrypted using thisprojewith a
,use the fsyntaxvarthe full path ()
this . you use
via ssh thet2
3. 
CVS is a.use it to reco .
3CVS, te:
sinstall cvs
, you should install xinetd to start/stop the cvs server. , toxinetdthewill be automatically initialized. resides
under the /srv/cvsis path:
cvs -d /your/new/cvs/repo initinitialis set upconfigure the CVSYpylines to the  /etc/xinetd.d/cvspserver file.
service 
{
     port = 2401
     socket_type = stream
    = tcp
     user = root
     wait = no
     type = UNLISTED
     server = /usr/bin/cvs_args = -f --allow-rootpserver
     disable = no
}
if you have changed the(/srv/cvs)onfigured xinetdstartsxinetd restartconfirm that by issuing t:3
sudo netstat cvs*: *:* LISTEN 
From heretinue to add users, add new projects, and manage.
CVS allows the user independently of the underlying OS installation. Probably
the easiest way is to use the Linux Users for CVS, although it has potential security issues.CVS manual for details.
3.3. Add Projects
This section  to. Create theand adddocument and to. Nowto add this
project to CVS:
cd yourcvs -d :pserver:username@hossrv/cvs import -m \
"my " . new_project usROOT e to storrootOnce you
exporavoid using -d option in the above cvs
command.
The stringis a vendor tag, and start is a release tag. They serve no purpose in this
context, but since CVS requires them, they must be present.add a, the CVS usermust have write access  src group has. So,
you can add thethis group, and he can then add projects in the CVS4
4. Bazaar 
56Book
7
CVS Manual
8
Easy Bazaar page
9page
10
bazaar.canonical.com/en/
56
http:/.tigris.org/svximbiot.com/cvs/manual/cvs-1.11.21/cvs_toc.htmlEasyBazaar
10278. Windows Networking
networks are often comprised of diverse and while operating a network made up
entirely of Ubuntu desktop and server computers would certainly be fun, somes
must consist of both Ubuntu and ® Windows® syste in harmony. This
section of the Ubuntu Server principles and tools used in configuring your Ubuntu
Server for sharingresources with.276
1. Introduction
Sly n systemlients involves providing and
intwith services common to. Sucassist theof data
and iabout theand userd in th, and may be under
three major categories of functionality:
• File and Printer Sharing Services. Using the Server Message Block (SMB)to facilitate
files, folders, volumes, andprinters throughout.
• Sharing vitalof with
such technologies as the LightweightAccess LDAP) Active
®.
• and Access. Establishing the identity of a or user and
determinis authorizusing such 
file , group policiKerberos service.
Fortunately,may provide all such facilities clients and shareamong them. principal pieces of softwareincludes
foris the Samba suite of SMB server .will introduce some of the common Samba use cases,
and hothe necessary packages.  detailed and
iSamba can be found onwebsite
1://www.samba.org7
2. Samba File Servermost common ways toWindowsis to configure Samba as
. covers sea Samba server to share files.
The server will bedany client o without prompting for a
pasrrequires stricter Access Controls s4, “Securing a Samba
 Server” [p. 282]he first step is to install the samba pacsamba
That's all there is to it; you are now ready.
2main Sambaation file is located in /etc/samb. Theconfigur
has a significant amount of comments in order to variousdirectives.
Not all the options are included in t. See the smb.conf
man page or HOWTO Collection
2
 for more1. the ken the [global of:
   workgroup = EXAMPLE
   ...
   security = user
Theparameter is farther down i, and is commented 
Also, change EXAMPLE to better match you.
2. new section at the bottom of the file, or uncomment one of the examples, for the to be shared:
[share]
    comment = Ubuntu Share
    path = /srv/samba/sbrowsable = yes
    guest okread only create mask = 0755
/samb8
• comment: a short deof the share. Adjust to fit your needs.
• path: the path to the to share.
This example usesname because, according to the Filesystem Hierarchy
Standard (FHS), /srv
3
 is where site-data should be served. Technically Samba shares
can be placed anywhere on the fas long as the  are correct, but adhering
to standards is recommended.
• : enableslients to browsedusingExplorer.
•: allows cconnect tosupplying a 
• read only: determines i is or if write privileges are granted. Write
allowed only va, as is seen in t. If the yes,
then share.
• new files will have when created.
3. Now that Samba ised, neecreated andchanged.
enter:
sudo mkdir -psnobody.nogrou/
The -p switch tells mkdir to entireree if it doesn't exist.
4. Finally, restart the samba services to enaco:
sudosm
Once again, the abgives allalocal network. For
a more secureation s
282]lient now be able o the Ubuntu file server and see the sharedIf your clienshow your share , try to access your server by its I, e.g. \\.1, in a window. To check that  working try
creating afrom Windowdditional shares simply create new [dirs in, and restart
Samba. Just mthat you want to share actually exists are
correct.
The file share named "[share]"ath are just. Adjuste and path names toe It is a name a share after apathname.com/fhs/pub/fhs-2.3.html#SRVDATAFORSERVICESPROVIDEDBYSYSTEM9 system. Anotherwould bname of [qa] with a path of
qa.
2.3. Resources
• For in depthsSamba 4
• The guide is also printed format
5
.
• Using Samba
6
 is another good reference.
• TWiki Samba 
7
 page.
ww.amazon.com/exec/obidos/tg/detail/-/0131882228oreilly.com/catalog/7690/Samba80
3. Samba Print Server
Another common use ofto iinstalled, either locally or over
the network, on an Ubuntu server. Similar to Section ” [p. 277] t
willSamba to allow  to use the  without
 username andFor  282].and it is best to aation. See
Section 4, “CUPS -” [p. 23To i, apsambaAfter installing samba editChange the attribute to what is
afor yourand change security to userIn the [printerscoption to yes:
  smb.confSambaSambawill share any. Simply
printn your.
38819101icoCUPS12
 page.10cups.org/
122
4. 
4.1. Samba Security Modes
There are twolevels to the Common Internet(CIFS)protocol
user-level and share-level. Samba'smode implementation allows more , providing
four ways ofing and one way to:
•= user: requires supply a to shares. Samba
user accounts are separate from system, but the libpam-smbpass pacsync system
users s with the Samba user database.domain: this mode allowsserver to appear toas a Primary
Domain Controller (PDC), Backup BDC), or a Domain Member Server
(DMS). S5, “Samba as” [p. 287] for further ADSjoin an Activedomain as a native member.
6” [p. 2serveris left over from before Samba could become a member server, and
due to someissues should not be used. See the Server
13
 section of
guide shareshares without mode you choose will depend on  and what you need
to accomplish.
4.2.= Userwill reconfigurefile and printfrom 
277] and3” [p. 280], to require .
First,hich will sync the system users touser
database
If you chosServer task during iis a., and in the [share:noSamba for the n to take effect:
ServerType.html#id3495313Now when connectinsharedies oryou sprompted for 
.ose to map adrive to the share you can check the “Reconnect at Logon”
check box, wrequire you to only enter theonce, at least
until the changes.
4.3. Shareseveral to increase thefor each individual y. Using
 will cover some common options.
4.3.1. Groups
Groups define a c of computers or users which have a common level of particularnd offer agranularity in controllingsuch resources. if a group qa is defined and containss freda, danika, and rob and a second group
supportsists of usersjeremy, and vincent then certain
configured to allow access by the ll subsequently enable,
but not jeremy or vincent. Since danika belongs to both the qa and support groups, she will
access forbothwhereas all otheill have
only  explicitly allowing the group they are part of.Samba lookslocal system gd in /etc/group to determine which
users belong to which groups. adding and removing users fros1.2, “ADeleting User3].
When defining groups in the,the recognized syntax
is to prefacename with an . if you wished togroup
named sysadmin in as, you would do so by entering the
group name as @sysadmin.
4.3.2. File s
 define the rights a or user has to a  , file, or set
of files. Such may beby editing the specifying
of afile share.
hava Samba share called share and wish to give read-only
toqa, but wantwri bycalled
and the user named vincent, then you could edit, and add theentries under theentry:4
    read list = @qa
    writesysadmin, vincentpossible Samba is to declare aveshared
resource. Users havingmay read, write, or modify any i
contained in thehas been givengivemelissathe share example,
 following line
    admin users = melissa
restart changes to For theandto work the Samba security mode must not be set to=
share
limit have dthe
filesystemneed to be updated.
TraLinux filedo not map well toNT Lists (ACLs). POSIX ACLs are ns  more fine grained controenable ACLs on /srv an EXT3 , efstab adding the acl option:
UUID=66bcdd2e-8861-4fb0-b7e4-e61c569fe17d /srv  ext3    noatime,relatime,acl 0       1
Then remount the partition:
sudo mount -v -o/srv
The above example assumes /srv on a separat. If /srv, or wherever you haveyour share path, is part of the / a reboot may be required.
To matchcoabove the group will be givenand execute
to, the , and ousername melissa.  terminal:
s-R melissa/
sudo chgrp -Rshare/
sudo setfacl -R -m g:qa:rxThecommand above gives executell files in the, which you may or may not want85
Now from a notice the neware eacl
andman pages i.
4.4. Samba AppArmor Profile
Ubuntu comes with theule, which provides mandatory access controls. The
defaultprofile for Samba will adyourationdetails
on usinge SeAps for smbd andnmbd,daemon
binaries, aapparmor-profiles packages. package, prompt
enteutils
Thi contains for several other binariesthembd and nmbd are in complain ming Samba to work without
modifying , and only logging errors. To place the smbd profile into enforce mode, and have
Samba work as expected,modified to reflect anyies that are shared.apparmor.d/usr.sbin.smbd adding forfrom the file server example:
  r,** rwkix,
Nowand reload i
cat /etc/Yonorashared as normalsmbd binary willonly theed files anies. add entries for
eachyoushare. Also, any errors will be losyslog.
4.5.1116
 is also a Chapter 18
17
 of is devoted .

am1www.orsecuring-samba.html6
•Samba and ACLs seeACLs page 
18
.19
 page.
AccessControls97568
1Samb7
5. Samba as a
Acannot act as anPrimaryPDC), arver
can bto appear as NT4-style domain controller. A major athisation is the aentralize user and machine credentials. Samba can also use multiple
backends to store the user.
5.1. coversas a (PDC) using the default
smbpasswd backend.
install Samba, andto syncaccounts,  in
a terminal prompsamba
2. Next,e st to
user should relate to your o:
  =3. In the commented “Domains” section add or uncomment the(the last line has been
split to fit the format of this document):
   domain logonslogon path = \\%N\%U\profile
   logon drive = H:homescript = logon.cmd
   adsudouseradd -N -g machines -c Machine -d
         samba -s /bin/false %uish to not use Roaming Profiles leave the logon home and options
.
•: the netlogon service cau to act as a
•: places the user'stheir home. to a [profiles] share placing all under a singldrive: specifies the local path.homtionscriptscript to be run locally once a user has logged in. The script needs
to be placed in the [netlogon] share8
•: a script that will Machine Trust Account needed
for a workstation to join the domain.example thecreatedaddgroup utility s for details.
4. [homto allowto be mapped:
[homes]
   comment = Homeies
   browsea   read ocreate mask = 0700
  valid users = %S
5. When a neeonfigured. To enable the
share,:
Network Logon Service
   path =netlogon
   yes
   share modes = no
The originalhare path is /home/samba/netlogon, but a
 20
 is the correct location for sit
provided by the system.
6. Now and an empty (for now) script file:
ssudo touch/lYou can enter any normallogon script commands into customize the
client's e
7. Rest new:
8. Lastly, there are a few adneeded to setup the appropriate rights.
With root being disabled , in order to joint, a s
mapped to theDomain Admins group.net utility, 
enter:
pat89
sudo net groupmap add ntgroup="" unixgroup=rid=512 type=d
Change to whichever group you prefer. user useda member of thgroup, as well as tem admin
group. The admin group allows sudo use.
does not have Samba credentials yet, you can add them 
changeusernamly:
sudo -a
Also, rights nto the  to 
script (and other admin functions) to work. This is achieved by executing:
net rpc rights grant -U"EXAMPLE\SeMachineAccountPrivilege \
SePrintOperatorSeAddUsersDisk\
SeRemoteShutdown
9. joinin the same manner as joining
them to an NT4 domain running on aserver.
5.2.
With aon the network it is best to have a
BDC) as well. This will allow e in case the PDC becomes
un.
ingBDC you need a way to sync account iPDC. There
are ways of aing this scp, rsync, or by using LDAP as the passdb Uis the most robust, because boths
can usein real time. se may be overly
complicated for a small number of user and computer accounts. See and
LDAsamba a. ap l
2. Now, esamband thein the [global]Domainsor add90
  domain master = no
4. Ma user has rights to read the files in.users in
the to scp, enter:adm
5. Next, using scp to copy the PDcp -r username@pdc:/var/libwith a name and pdchostname or 
your actual PDC.
6. sambYou can test that yourcontroller is working by stopping the Samba daemon on the
PDC, then trying to login to client joindomain.thing to keep in mind is if cohe loption as aand the , access to the user's Home drive will also be. For
this reason tto reside on a sile server and
BDC.
522223
 is a4
24
 explains .
• Chapter 5
25.26
 page.
2
amorsamba-pdc.html
us3samba-b691
6. Samba6ing a Samba Share
use for Samba is to integrate into an existingnetwork. Once part of an  domain, provide file and print services to AD users.
The simpleD domain is to use Likewise-open. For detailed instructions see the 
Likewise Open doc7
.
thedomain, enter thecommand in the tesmbfs smbclientchangingads
   realm .COM
   ...
   idmap backend = lwopenuid = 50-9gRestart samba for the naccess any Samba shares .be sure to give
the AD users or groups share. for more 6ing Sharethe Samba server isWindows server
shares:
• To mountfile sharein amount.cifs //fs01share mount_point access shares ons notDbut a and willprovided.
www.beyondtrust.com/-Support/Downloads/files/pbiso/Manuals/ubuntu-active-92the share during boot place an entry in /etc/fstab, for //1/share /mnt/windows cifs auto,username=steve,password=secret,rw 0
• Another way to copy filto use the utility. To list the files in
share:
-k -c "ls"
• To copy a file sharembclientget file.txt"
file.txt into the current
• Anda file to put /etc/hosts hoststo/hosts.
• The -c option used above allows you to ecommand all at once.useful
for scripting and minor file operations. Tosmb: \> prompt, a prompt where you
cannormal commands, simply executall instances of , ,
 and with your server's IP, hostname, share name,
file name, and an actual password with.
6opman page: man, also line
28
.
The man page
29useful ed i.
The Ubuntu 308
http://ma1/.1.html
quantal/en/man8/.8.html
3amba2939. Backupsmany ways to backup an Ubuntu installation. The most important thing about backups is to
develop a backup plan consisting of what, where to back it up to, and how to restore it.
The fsections discussese tasks.Backups
294
1. Shell Scripts system is using a shell script.a script can be used
to whichie, and pass thoseas arguments to the tar utility,
which creates an archive file. The can then be moved or copied to another. The
archive can also be created on a remote file system such as an onout of many files or. tarfililes
through compression utilities, thus reducing the size of t.
1.1. Simple uses tar to creately mounted NFS.
name is determined using a line.
#!/bin/sh
#
#
# Backup to script.
# W. 
backup_files="/home  /etc /root /boot /opt"
# Whup to.
dest="/mnt/backup"
#name.
day=$(date +%A)=$(-s)
archive_file="$hostname-$day.tgz"
# Print start status message.
echo "Backing up $ to $dest/$"
date
echohe files using tar.
tar czfendup finished"
date
# Long lfiles in $dest to check file sizes.
ls -lh $dest5
•: a variableyou would like to backup. The list should be
d to fit your needs.
• $dayholding the day of the week (Monday, Tuesday, Wednesday, etc).d to
for each, giving history of seven days. There are
s to a this including uste utility.
• :containing the short of the systethein thfilename gives you the option of placing daily as from systems in the
same: the fullname.
• $dest: destination Th nreated and in this case mounted
before  the backup script.2, “Network File ” [p. 225] for
details of using NFS.
•s: optional messages printed to the consoleecho: the tar command used tthe.
• c:.
• z: archive tgzip utilityng .
• f: output to. tar output will be sent to STDOUT.
• statement prints a -l lin -h human readable foeful for a qui checkis check should not replace
testi file.
This is a simple example of ; however there are many options that can be
incsuch a1.4, 97] for links to resources providing
more in-depth ing i1.2. ExecuScript
1.2.1from a Terminalofabove is to copy and paste the contents into a file.
backup.sh . Then :
sudo bash great way to test the script to meverything works as expected.
1.2with cron
The cronan beautomateexecutcron daemon allows the 
of scripts, os, at a specified time and date.
cron is corough entries in a crontab file.s are separated into fields:6
# m h dom mon dow   command
• m: minummand executes on, between 0 and 59.
• h: hour the co23.
• dom: day of month.
• mon: the1 and 12.
• dow: the 7. Sunday may beby
using 0 or 7, both vavalid.
• command:to execute.
To add or change the- used.contents
of can be viewedcrontab -l command.
T the script listed above using cron.e
Using sudo withedits the root user's crontabnecessary if
you are bdirectories only has access to.
Add the entry tofile:0 0 * * * bash /usr/local/bin/will now be executed every day at 12:00 am.
Tcthe in order for
this execute properly. The reside an system, simpltpath ly.
-depthSection .
1.3. Restoring Archive
Once an archive has been created it is archivcan be tested by
lifiles it contains, but the best test is toa filearchive.
• To see athecontents.prompt type:
tar -tzvf /host-Monday.tgz
• T to a differententer:
tar -x -C /tmp 7
The -C option to tar redirects the extracted files to the. The above example will
extract the file to /tmp. tar recreates thestructure that.
Also, notice the leading "/" is left off the path of the file .ll files in enter the:
cd /
sudo 
This will overwrites currently onsystem.
1.4.•see the Advanced Bash-Scripting Guide
1
• The book Teach Yourself Shell Programming in 24 Hours
2
 is  and a great
for .
• The CronHowto Wiki Page
3
 n aron options.
• See the GNU tar Manual
4
 for more tarThe Wikipedia Backup Rotation Scheme
5
 articleiother backup rotation
scheme uses tar to create re many other command  that can
be used.:
• cpio
6
:oto and from archives.
• dd
7
: pacoreutils package. A low levelthat can copy data from one format to
another.
• rsnapshot
8
: a file system snapshotcopies of an entire.
• rsync
9
: a flexibleincremental files.
tldp.org/LDP/abs/html/
fari.samspublishing.com/0672323583
3
www.gnu.org/software/tar/manuaenBackup_rotation_schemecpio/.org/ftp/rsync/rsync.html8
2. Archive
The in , “” [p. 294] only allows for seven For a
server whose data doesn't change often, this may be enough. If the server has a large amount of data, a
more complex scheme 
2.1. Rotating NFS Archivestlightly mimplement a grandfather-father-son (monthly-weekly-daily):
• Thewill do a daily backup Sunday through Friday.
• On Saturday a weekis done giving you fours a month.
• The monthon the first of the month rotating twos based on if the
month is odd or even.
Here is the new script:
 with
#.
Setups for the a# Find which weemonth 1-4 it is.
day_numd)
if (( $day_num <= 7 )); then
        weekweek1.tgz"
el> 7 &&1421421321 324.tgz"
fi9
# Find if the Mmonthm)
month=$(expr $ % 2)
if [ $month -eq 0 ]monthmonthse1.tgz"
fi
if [== 1archive_file=$
el != "Saturday"else 
 
fista/
usame methods as.2, “” [p. 295].
It is good practice to take backup media off-site in case of a disaster. In thee
is another server an . In all likelihood taking the NFS server  location woupractical. Depending upon connection speeds it may be an 
copy over a WAN link to a server inlocatiooption is to to an external hard drive which can then be taken.
price ofs continue to decrease,cost-effective to use two drives
for each archive leveould allow you to have onedrive attached to the backup server
and one2.2. Tape Drives
A tape server can be used instead ofUsing asimplifiesrotation, and makes easier as well300
When u, the filename portions of the script aren't needed because the data is sent
directly to the tape device. Some commands to manipulateare needed. This is aed
using mt, a magnetic tape contropiomusescripdev/st0is rewound.
mt -f $dest rewind
he files using ta
# Rewind and  tapeofflend staThe default device name for a SCSI is /dev/st0. Use the device path
for your system.
is basically the same as restoring from a file. Simply rewindnd
 file path. to restore the
hosts:
mt -f rewind
tar -xz301
3. Bacula
Bacula is a backup program enabling you to backup, restore, and verify data across your network.
There are Bacula clients for Linux, Windows, and Mac OS X - making it a cross-platform network
wide solution.
3.1. made up of several components and servicesmanage which files and
backups:
• Bacula: a service that controls allverify, and archive operations.Console: an application allowing communication with the. three versions
of the Console:
• Text based cversion.
• Gnome based GTK+ Graphical User Interface (GUI) interface.
• wxWidgets GUIBacula File: also the Bacula Client program. Thisis installed on machines to
be backed up, and is responsibledata requested byStorage: the programs that perform the storage and recovery of data to the pdiaatalog:maintfile indexes and volume databases for all files
quickand restoration of archived files. The Catalog supports three
and SQLiteMonitor: almonitoring of, File daemons, and aemons.
Cthe Monitor is only as a GTK+ GUI.
Theseands can be run on ervers and clients, or th
one machine if backing up a single disk or volume.
3.2. Installation
If using MySQL or  as your, you should ath
 Bacula will not install them for youpackages coBacula. ToBacula, from a
te entebaculainstalling the bacula pacuse a for t. If you want to
use SQLite,Catalog,bacula-sqlite3 or pgsql
respectively2
process you will be asked to supply credentialsbase aor and
database owner. Thewill need to have the rights tseeMySQ for more i3.3. Configuration
 files are formatted based on resources comprising of directives surrounded by
“{}” braces. Eachomponent has an individual file in the /etc/bacula directory.
The must authorize themselves to each other. using
the password., theresourc/baculadir.conf file must matcin/bacula-sd.conthe backup job named Client1 is coo archive theatalogplan on
using the server to backup more than one clientchange the name of this job to something
more descriptive. To editdir.conf:
#
# Define the main nightly save
#   is job will back up to disk in 
Job {
  Name = "BackupServer"
  JobDefs = "DefaultJob"
  Write Bootstrap = bacula/Client1.bsr"
}
The example above changes the to  matching the machine's host
name. Replace “” with yourhostname, or other name.
The Console to quer about jobs, but to use twith a non-root
user, the user neein the bacula group. To add a user to enter the following
:
sudo adduser $username baculaac. Also, if you are adding the current
grouplog out and back innew permissions to t.
3.4. Localhost Backup
This section descrd host to a local t.
• Firstdevice. acula add:
Device"
  Device Type = tapeBackups
303
  Media Type = DDS-4
 Device =
  end of medium = No;
  Mount = yes; # when device opened, read it
  AlwaysOpen = Yes;
  RemovableMedia = yes;
  RandomAccess = no;
  Alert Command = "sh -c 'tapeinfo -f %c | grep TapeAlert'is for a DDS-4 A“” and “Archive Device” to match
your hardware.
You could also uncomment one of the other examples in the file.
• bthe be restarte restart
• Now add ain new Device:
# Definition of " storage device
StorageTapeDrive
  # Do not use "localhost" here    
  Address = backupserver # N.B. Use a fully qualified name here
  SDPort = 9103
  = "Cv70F6pf1t6pBopT4vQOnigDrR0v3LT3Cgkiyjc=
 tape
}
Thedirectivethe of the server. Change
to the actual host name.
Also, mematches thestring • new FileSet, which will determine whaties , by adding:
#Bacup FileSet.
FileSetFiles"
  Include {
    Optionssignature = MD5
      compression=GZIP
    }
    File = /etchome
  }4
}
This FileSetup the /etc and /home. Theresources
theto create an MD5 for each file bactos using
GZIP.
• Next, new Schedulebackup jobkup-- Daily.
Daily"
  Run = Full daily at 00:01
}
Therun eve00:01 or 12:01 am. There are mascheduling options
• Finally crJ backup.BackupEnabled = yes
  Level = Full
 = "Storage = .bsr"
}  do a Full backupto the Each tape usedhave a Label. If thetape da labelsend
an email letting you know. To label a tape Console bconsole
• At theonsole prompt enter:
label
• You will then be promptedStorage:
selected Catalog: MyCatalog
Using""
The defineds are:
     1: File
     2:Select(1-2):25
•new Volume name:
Enter  Sunday
Defined PoolsDefaultScratchSunday desired label.
• Now, select the Pool:
S (1-2): 1
Co at:9103 ...
Sending label command for Volume "Sunday" Slot 0 ...
Congratulations, you have nowd Bacula  the  to an a3morcooptions refer toUser's Manual
10
• T11
 contains the latest Bacula news and developments.
• Also, see
bacula.org/en/rel-ma
Bacula30620. Virtualization
 is being adopted in many different e and situations. I developer,
v can provide you with a contained where you can safely do almost any
sort of safe from messing up your main workingsystems
,use to more easily separate your services and move them around
based on demand.
The defaultechnology supported ins KVM. KVM requires
extensions built into Intel and AMD Xen is alsoon Ubuntu. Xen can take
a, when , but can also be used on without. Qemu is another popular solution for.307
1. libvirt
The libvirt library is used to interface withec. Before getting started
withit is best to e necessaryfor
KV prompt:
kvm-ok
A message will be printed informing you if your CPU does or support.
On most computer whose processor, it isto activate an
option in the BIOS to enable it.
1.1 a fewways to allow a virtual machine anetwork. 
virtual networkation is usermode networkinuses the SLIR and traffic is
NATed thostto the outsi.
Thosts to directly accessons a bridge nd. This allows thes to cophysical
, mm appear as normal the rest of th. For i on setting
ups.4, “Bridging” [p. 39].
1thepackages, entekvm libvirt-bin
, the usermanagmachines added to the
libvirtd group. Doing so will grantadvanced options.
In a terminaldduser $USER libvirtdchosen is the , youlgroup
membership to tYou are now ready to install a Guest operating system. Installing fosame
process as itheon theYou either need a way to automate
the installation, or a keyboard and monitorachine8
In the case ofs analogous to using a use. Instead ofa GUI the virt-viewer aconnect
to's console using VNC. S6, “Virtual Machine Viewer” [p. 310] for
more.
several utomate the process, for eing preseeds,
kickstart, etc. RUbuntu for details.
Yet another wan Ubuntuis to use ubuntu-vm-builder.
allosetup partitions, execute custom post-install scripts, et see2, “” [p. 312]
Libvirtcowork with Xes, see the Xecommunity paged below.
1.3. vir
 is virtinst package. it,virtinstoptions when using. :
sudo -n web_devel -r 256 \
--disk pathlibvirt/images/.img,bus=virtio,size=4 -c \
jeos.iso --accelerate --network network=default,model=virtio \
--connect=qemu:///system --vnc --noautoconsole -v
•: the namewwill bein this example.
• -r 256: amount of memorywill use in megabytes.
• size=4: indicates the path todisk
be a file, , or logical volume. I a file named.img in
the  directory, with a size of 4 gigabytes, andio for the disk bus.
• -c jeos.iso: file toasCDROM. The file can be either an ISO file or
host's CDROM device.
•: enables the kernel's ion t
•provides details relat VM's network interface. Here the defaults used,
and the model ised for virtio.
• --vnc: exports the guest's
•: will not automaticallyvir.
• -v: creates a fulled guest.
112.10/i-guide/9
After launch using a GUI
or with-viewer utility.
1.4. virt-clone
The py oneto anotherclone -on database_devel -f .img
• -o: original.
• -n:.
• -f:file,, orby the ne.
• which hypervisor to.
Also, use -d or --debug option to help troubleshoot problems with.andwith appropriatnames.
1.5. Management
1.5.1. virshutilities to and libvirt. The virsh utility can be
used co. :
• To list runnings:
virsh -c list
• To startmachinestart
• Similarly, t at bootautoReboo withrebooThe state can be saved to a file in order to be restored later. The will
savestate innamed according to the datave-022708.state10
Onchewill no longer be running.
• A savedcanusingstor
• To shutdown dohutdownA can be mounted iby enterattach-disk/dev/cdrom /media/cdrom
In the as replacith the, and
 with a de.
1.5.2rmanager package contains a graphicallocal and remos.
virt-manager 
Since requires aeit is recommended to
be installed on a woror testinstead of a production server. Tolocal
libvirt service enter:
nect to theserviceon another host  tin a terminal
prompt+ssh://virtnode1.mydomain.com/system
T assumes that vity between the management system
and  has already been, and uses SSH keys for
authentication.are needed becausnds the password prompt to another
process. s oing SSH s, “OpenSSH Server” [p. 80]
1.6Viewevaa virdoes
requiretoviewer enter:1
sudo ap
Once  isandyou can by

,a remote host using SSH with key ,
as well:
-c qemu.
If to use a bridgedalso setup SSH avi.
 and Section 1 for more details.
1.7. Resources
• See the KVM
2
 home page• formation one
3
• Ther
4
 site has  ond.
• Also, stop by thevirt IRC channel on freenode
5
 to discuss virt technology in
Ubuntu.
• Another good resource is theKVM
•Xen, inXen with libvirt, please seeXenwww.linux-kvm.org/
3
http://libvirt.org/.etfreenode.net/
KVMXen2
2. 
2.1. Int
2.1.1. What is JeOS
Ubuntu JeOS (pronounced "Juice") is an efficient variant ofServer , specifically forappliances. Nas a CD-ROM ISO for download,
but only as an option either:
• While installing Server Edition ISO (pressing F4 on the first screen will allow you to pick
"Minimal iis theselection equivalent to JeOS).
• Or to be built using Ubuntu's vmbuilder, which is described here.
JeOS is a specialized of Ubuntu with a tuned kernel that onlythe
base elements needed to run within ized ehas been tuned to take key performance ies in the latesproducts from VMware. This combination of reduced size and optimized
ensures that Edition delivers a highlyuse of servers in large virtual
deployments.
Without unnecessary drivers, and only the minimal required packages, ISVs can their
supporting OS exactly as they require. They have the peace of mind that updates, whether for security
or e reasons, will be limited to the bare minimum of what isin their
 In turn, users deployin built on top of JeOS will have to go through
fewer updates and therefore less maintenance than they would have had to with a standard full
i of a server.
2.1.2
Withthere is no need to a JeOS ISO anymore. will fetch the various
package and build tailored for your needs in about a minutis a script
that automates the process of creating a ready to use Linux based VM. The currently 
s are KVM and Xen.pass  options to add extraremovechoose which version
, which mirror etc. On recent hardware with plenty of RAM, tmpdir in /dev/shm or using a
tmpfs, and a local mirror,ba VM in less than
First introduced as a shell script in Ubuntu 8.04 LTS,  started with little emphasis
as a hack to help developers test their new code in without having to restart from
scratch each time. As a few Ubuntu asto notice this script, a few of them went
on improving it and adapting it for so many use case that Soren Hansen (the author of the script and
ization specialist, not the golf player) decided to rewrite it from scratch for Intrepid as a
python script with a few new design goals3
• Develop it so that it can be reused by other distributions.
• Use a plugin mechanisms for allinteractionsothers can easily add logic for
others.
• Provide an easy to maintain web interface as an the.
But the general principles and commands remain the same.
2.2. Initial Setup
It is assumed that you have installed anddand KVM locally on theyou are
using.how to perform this, please refer to:
•, “libvirt” [p. 307]
• The KVM
8
 Wiki page.
We also assumeknow how to use a tetext editor such as nano or vi. Ifnot
used anybeforeget an overvi various s by reading the
PowerUsersTextEditors This tutorial has been done on KVM, b should
remain on tec
2.2.1. Install
The npackage that weinstall is pythonIn a terminal prompt ente
running Hardystillmost of this using the older version of thenamed, there are only a few changes to the synt tool.
2.3. Defining Your
 is quite simple, but a few thing to
consider:
• If you plan on shipping , do notthe end-user will 
extend disk size to fit their need, so either plan for a disk to allow  to
grow, or explain fairly well in your documentation how to allocate more space. It might actually be
a good idea to store data on some separate external storage.
• Given that RAM is much easierin a VM, RAM size should be set to whatever you think
is a safe minimum.
Thecommand has 2 main parameters: they () and the
targeted. Optional are quite numerous and can be foundfollowing
command:KVM4
 kvm ubuntu --help
2.3.1. Base P
As this example is KVM and Ubuntu 12.10 (), and we are likely to rebuild
the samtime, we'll invokewith the  first
sudosuite quantal --flavour virtual --arch i386  \
-o --libvirt
The --suite defines the Ubuntu release, theat we want to use kernel
(that's the one used to build a JeOS image), the --arch tells tha 32 bit machine, the -
o tellsto oveprevious VM and thetells to inform the localto add the resulting VM to the list of machines.
Notes:
• Because of the nature of operations performed by, it needs to have root privilege, hence
the use of sudo.machineuse more than 3Gb of ram, youuild a 64 (--
arch amd64).
• Until10, thekernel was only built for 32 bit architecture, so if youdefine
an amd64onshould useerver instead.
2.3.2. JeOS Installation2.3.2.1. JeOS2.3.2.1.1. Assigning a fixed 
As ahat may be deployed on various very dnetworks, it iicult
to the actwill look like. In order to simplifyation, it is 
to take an approach similar to what network hardware vendors usually do, namely an
initial to the in a private classthat you will provide in your
. An address in the range 0/255 ia good choice.
To do this we'll
• --ip ADDRESS: in dotted form (defaults to dhcp if not )
• --hostname NAME: Set NAME as the of the guest.
• --mask VALUE: IP mask: 255.255.255.0)
• --netnet(default: X.X.X.0)
• --bcasbroadcast: X.X.X.255)
• --gwGateway1)5
• --dnsName server
for now that default vagood enough, so theinvocation becomes: --ip100myvm 
2.3.2.1.2. ecause ourwill beneed to be accessed by rs, configureo thatuses tworking. add the --bridge br0
need to have previously setinterface, see
39] for . the  name ischange br0 to t
bridg.
2.3.2.2. ing
 of twill have to take into consideration what you are planning to do
with is.mostshave a separate storage for data, having/var
would make sense.
do thisprovides us with --part:
--part PATH
  Allopecify a partition table infile, located at PATH. Each
  line of thefile should specify (root first):
      mountpoint size
  where  size  is  in mhave up to 4disks, a new disk starts
  on a line with ’---’.  ie :
      root 1000
      /opswap 2---
      /var 2log 1500
In our case we will define a text file name.which will contain the:
root 8000
swap 4000
---
06
Note that as we are using images,  sizes that we pmaximum
sizes for these volumes.
Our now looks like--part
Using a "\" in awill allow longstrings to wrap to the next line.
2.3.2.3. User and
Again setting up aneed toauser and password that is
generic so that you can include it in. later on in this ow we
some security by defining a script that will be run the first time a user logs in the
, among other things, ask him to change his. In thisI will use
'user' as my user name, and 'default' as theo:
• --user USERs the name of the user to be added. Default: ubuntu.
• --name FULLfullUpass PASSWORD: Set forOur--part \--user user --name user --pass default
2.3.3. Installing Required Packages
weia package (Limesurvey) that accesses aand
has a wtherefore require our OS us with:
• Apache
• PHP
• MySQL
• 
•  (as anathat we have packaged)
This is done usingby speci--add s:
PKG7
 PKG into the guest (can be specfied)due to the wayoperates, packages thatask questions toduring
the post install phase are not supported and should instead be installed while interactivity can occur.the case of, which we winstall later, oncelogs in.
ask simple debconf, such as mysql-server asking to set a, thecanimmediately, butre it thethe user If someinstallin main, enable the additional repositories
using --comp and --ppa:
--components COMP1,COMP2,...,COMPN
 A comma separated list of distro to include (e.g. main,universe).This d"main"
--ppa=PPA  Add ppa belonging to PPA to the vm's sources.list.
not being part of the archive at the moment, we'll specify it's PPA (personal package
archive) address so that it is added to the VM /etc/apt/source.list, so we add the
theapache2 apache2-mpm-preforkutils \.dbconfig-commonlibod-php5mysql-clientphp5-cligdldapphp5-mysqlwww--ppa nijaba
2.3.4. Speed Cos
2.3.4.1. Package Caching
Whencreates builds your system, it has to go feocomposes
it over the network to offici, which, depending on your internet connection
speed and the load of the mirror, can have a big impact on the actual build timreduce
thireco either have a locy (which can be created using apt-mirror) or
using a caching proxyapt-proxy. The later option being much simpler to implement and
requiring less disk space, it is the onepick in this tutorial. simply type:
Once this is complete, your (empty) proxy is ready for use on http://mirroraddress:9999 and will find
ubuntuy under /ubuntu. Forto use ihave to use the --mirror option:
--mirror=URL  Use Ubuntu mirror at URL instedefault, which   is http://archiveubuntu for officialarches and http://ports-portsotherwis8
So themirror/ubuntu
T pecified here will also be used in thes.list of the
neguest, so it is useful tohere anthat can be resolved by the
guest or to plan on reseting thislater on.
2.3.4.2 a Local Mirror
If we are in a larger e, it may  to setup a l of the Ubuntuies. The package  you with a handle ting for you.plan on having about 20 gigabyte of free space per release and a.,uses the cofile inmirror.list. As it is set up, it will
replicate only the of the local machine. If you would like to support others on
yoursimply duplicate the lines starting with “deb”, replacing the deb keyword by /deb-{arch}
where ari386, amd64, etc..., on an a, to have the i386 archives
as well,have  of this document):
deb quantal main restricted universe multiverse 
/deb-i386-updates
deb/ quantal-backportsecurityquantal-securitymain/debiaerNotice that the sourceare not mirrored as they are seldom used compared to the binaries and
they do take a lot , but they can be easily list.
Once the mirror has finished replicating (and this can be quite long), you need toe Apache
so that  files (in if you did not change the default), are published
by your Apache server.eHTT
186]19
2.4the A
Two option are available to us:
• The rmethod to do so is to make a Debian package. Sioutside of the
scopetutorial,not pe here and invite the reader to read theation
on how to do this in the Ubuntu Packaging Guide
10
.case it is also aetup a for yourso that updateconveniently pulled from it. See the Debian
Aon
11
 article for a tutorial on this.
• Manually install the aunder /opt asby the FHS guidelines
12
.'ll useaswebfor sh to provide a virtual. As noted before, we've made a vein a PPA (Personal
Package Archive).
2.5. Useful Additions
2.5.1. Configuring  Updates
To have yo bed to update itself on a regular basisjustunattendedupgrades,  ouraddpkg -upgrades
As ut ourpackage in a PPA, the process will update not only the system, but
alsoeach time we update thein the PPA.
2.5.2. ACPI Event Handling
For yourmachine to be able to handle restart and shutdown events it is being sent, it is a good
idea tocpids well.we just a addpkg acpid
2.6. Final Commandcommand with all the options discussed abov-o \ l -part\ 
1wikiGuide
debian-a.org/articles/286
1pat20laddpkg php5-cpid 
2interested in learning more, haveor suggestioncontact tServer
Team at:
• IRC:on • Mailing list lis
13
• JeOSVMBuilder Ubuntu Wiki
14
 page.
1/mailman/listinfo/ubunt41
3. Ubuntu Cloud
Cloud computing is amodel that allows vast pools of resources to be allocated on-demand.
Thesesuch as storage,power,and software are abstracted and delivered
as a service Internet anywhere, anytime. These services are billed per time consumed
similar to the ones used by publicsuch as electricity, water and telephonyInfrastructure uses OpenStack open sourceto help build highly scalable, c
for both public and private clouds.This covers theinstallation CD,
and assumes a basicpologngle system serving as the "all-in-one cloud
i".Dtutorial's simplicity, the instructions as-is are not intended to set up
pros although iyou to have a POC (proof of concept)  Cloud
using.
3.2. Prerequisites
To deploy a minimal , you’ll need at least:
• One dedicated system.
• Twoddress ranges (privatepubl).
• host in supports VT (  Technology ) sincebe using
KVM as the virtualization t. Other also such as QEMU, UML,
Vmware ESX/ESXi and XEN. LXC (Linux Containers) is through libvirt.
Check ifkvm issuing sudo kvm-ok in a linux terminal.
The "Minimum Topology"for use is using three nodes - One master
server running novs (except compute) and two servers-compute. This setup is
not redundant and the master server is a SPoF (Single Point of Failure).
3.3. Precothe network
Before we start installi we need to mwe have bridging suppoed, a
, and a central time server (ntp). This will assure thatinstantiated machines
and hosts in sync.the “” will be in the 10.0.0.0/24 range on eth1. All the internal
communication between instances will happen there while the “
10.153.107.0/290.
3.3.2bridge-utils 
3.3nd configure NTPntp
Add these two lines at the end of the /etc/ntp.
server 127.127.1.0
fudge stratum 10
Restart ntp service
sudo service ntp restart
3 aMySQL
database and mysql user for
sudo mysql -uroot -ppassword -e "CREATE DATABASE nova;"GRANT ALL ON nova.* TO novause \
IDENTIFIED BY 'novapassword' ";
The line continuation character "\" implies that you must include the subsequent line as part of the
current command.
3.4.Compute (Nova)
 is a fabric controller (the mainan IaaS
system). It is written in Python,e Eventlet and Twisted frameworks, and relies on the standard
AMQP messaging protocol, and SQLAlchemy for data store access.
InstallNova componentsova-api novaova-volume nova-objectstore nova-scheduler \
nova-compute euca2ools unziplibvirt-bin just libvirtd is aware of ebtables.restartRabbitMQ – Message Queuing Protocol (AMQP23rabbitmq-servernova/nova.conf and :
# Nova config FlatDHCPManager
--sql=mysql://novauser:/nova
--flat_injected=true
--network_manager=nova.network.manager.fixed_range=
--floating153.107.72/29
--flat_network_dhcp_start=10.0.0.2bridge=br100terface=eth1
--public_inservices
for i in novnovcompute; \
do sudo stop $i; sleep 2; doneartMigrate Nova from sqlite db to MySQL db. It may take a while.
sudo nova-manage db sync
Define a specificnetwork where all your Irunbe used in the network
of fixed Ips set inside network create --_v4--label\
--bridge br100 and allocate 6 (usable) Floating Public es for use with the
istarting from 72floatingipuser (user1), a project (project1), download credentials and source its co.
cd ; mkdir nova ; cd novauser admin user1project create project1zipfilunzip nova.zip
source novarceCompute iby typing24service listversion list
If nova services don’t show up correctly restartas described previously.
information please refer to the troubleshooting section on this guide.
3.5Imaging Service (Glance)
Nova uses Glance service to manage Operating System images that it needs for bringing up instances.
Glance can use several types of storage backends such as filestore, s3 etc. Glance has two- glance-api and glance-registry. These can be dconcerned upstartjobs.
For this case weusing mysql as aGlanceglanceuser for gglanceglance.* TO glanceuseglance /etc/glance/edit the line which contains the option
" =" to this:
 mysql://:glance
Remove the sqlite
rm -rf .sqlite changes to. The MySQL
will be automatically populated.
sudo
If you find issues take a look at the log file in /var/log/glance/api.log andlog.
3.6. Running
Before you can i images, you first need to setup user . first step is
achieved you alsouploadyou want to run in the cloud. Once you have these
images uploaded to youable to run and connect to them. Here are the steps you
should follow to geNova running5
Download, register and publish an Ubuntu cloud image
distro=lucid
wget http://cloud-image$distro/current/$distro-server-cloudimg-amd64.tar.gz
cloud-publish-tarball "$distro"_amd64key pair and start ce
cd ~/novaeuca-add-keypair user1 > user1.priv
chmod 0600Allow icmp (ping) and ssh ainstances
euca-authorize default -P tcp -p 22 -s 0.0.0.0/0-P icmp -t -1:-1 default
Runami=`euca-describe-images |  awk {'print $2'} | grep -m1 ami`
euca-run- $ami -k user1 -t m1.tiny
Assign public address to the.
euca-allocate-address
euca-associ -i_id public_ip_You must enter above_id (ami)  shown above by and  commands.
Now you should be able to SSH
ssh -i ubuntu@ipaddress
To terminats
euca-instance_id
3.7the Storage (Swift)
Swift is a highly , distributed, eventually consistent object/blob store. It is used by theto provide S3 like cloudservices. S3 api compatible with
amazon26
s use Swift to store lots of data efficiently, safely, and cheaply where s use an
special api to interfacethand objects stored in Swift.
Althoughll Swift on a single server, a multiple-server iis required fore. If instalObject(Swift)node for
development or testing purposes, use the Swift All In One inston Ubuntu.see: http://swift.openstack.org/_saio.html 
15
 .
3.8. Support and Community Support
•
16
• TheWiki search
17
• bugs area
18
• Join the # on freenode.
3.9.Cloud Computing - Service models
19Compute
20Image Service
21 Guide
• 
22
•glossary.com/
3.10. Glossary
Thedouses terminology that might be unfamiliar to some readers. This
page is intended a glossary of such terms and acronyms.
• Cloud - A federated set of pachines that offer crehroughmachines, provisioned and recollected dynamically.
• IaaS -as a— Cloud iservices, whereby aed is delivered as a service over the by the provider. Thecan
include servers, network equipment, and software.

launc~
wiki
18bugs.nova
enCloud_#Service_Models
20
docstrunk/-compute/
diablostarter/content/GlanceMS-d2sobject-storage/admininstalling--on-ubuntu.html7
• EBS - Elastic Block Storage.
• EC2Compute Cloud. Amazon's pay-by-the-hour,public cloud
offering.
• Node - A node is a that's capable ofvirtual running a node
controller. Within Ubuntu, this generally means that the CPU has VT e, and can run the
KVM .
• S3 - SimpleServiceersistent storage solution for EC2.
•-. Ubuntu's cloudsolution, .
• VM - Virtual Machine.
• VTization . An optional feature of some modern CPUs, allowing for
adhosting8
4. LXC
 are a lightweightThey are more akin to an enhanced chroot than
to fulllike Qemu or VMware, both because they do not emulate hardware and because
containers share the same osystem as the host. Therefore are better compared to
Solaris zones or BSD jails. Linux-vserver and OpenVZ are two pre-existing, independently developed
implementations of-like functionality for Linux. In fact,came about as a
result of the work to upstream the . Som
is still missing in, howevern boot many Linuxions and
have the athat thused with an un-modifiedkernel.
Thereuser-space , each exploitingkernes.allows the use tLXC driver by connecting to 'lxc:///'. This can be very
convenient as it supportsusage as its other drivers. The other, called simply
'LXC', is not co libvirt, but is more with more userspace toolpossible to
switch between the two, though tpeculiarities which can cause confusion.document we will mainly describe the lxc package. Toward the end,how to
use the libvirt , a nameshown as CN, C1, or C2.
4ation
T can be installed usinglxc
This will pull in theand recommended dependencies, including cgroup-lite, lvm2, and
de. To us-lxc, install l. LXC andlxcand used at the
same time.
4.2. Host Setup
4.2.1. Basic layout of LXC files
Following is a description of the files and directorarby LXC.
• pstart jobs:
• /etc/init/lxc-net.conf: is an job which only runs if  /etc/default/lxc specifies
USE_LXC_BRIDGE (true by default). It sets up a NATed bridge foto use..conf:LXC_AUTO is set to true in.
It looks for entries under /etc/lxc/auto/ which are symbolic links to cos for thwhich started at boot9
•lxc.conf: There is a defaultcreation,
lxc.condirectss to use the LXC bridge created by the lxc-net u. If no
 isd when creating , then this oneused.
• Examples of othe s are found under lxc/
examples. These show how to createwithout a pr, or using macvlan, vlan,
or otherlayouts.
• The variou a toolbin.
• /usr/lib/lxc/lxc-init is a very minimal and linit binary which is used by lxcexecute. `booting' a full, it manually mounts a few filesystems, especially /
proc, and executes its arguments. t likely toris filetemplates/ cont`' be usednewof
various flavors. Not all  are currenapparmor.ds theApparmor MAC policy which works to
protect the host from. Section 4.2.6, “Apparmor” [p. 330usr.bin.lxc-stars a profile to while it
is seth-cocauses all the profiles defineetclxc to
be loadvarious man pages for the LXC s well as the lxc.con.
• xc is whers and their iare storedcache/laches of data  to speed up multipl
creations.
4.2.2. lxcbr0
When  (as it is, aalled lxcbr0
is created at startup. This bridge is given theaddress 10.0.3.1, andusing t
will have a 10.0.3.0/24 address. A dnsmasq instance is run listening on that bridge, so if another
dnsmasq has bound all interfaces before the runs,will fail to start and
lxcbr0 will not exist.
Ifanother bridge - libvirt'svirbr0, or a br0 yourNIC -use
 in place of lxcbr0 for your
4.2.3. Using a separate store
LXC stores nd backing store) root under /var/
lib/lxc. lso tend to store cached30
If you wish to use anotherthan /vamount awhich has more space
into those locations.  disk dedicated for this,simply mount it at.
If yolocation, like /srvbindor use a . For, if /srv is a large mounted, create and symlink two :
sudo mkdir /srv/lxclibcache
sudo lxc /var/
sudo ln -svacacheor, using ssed -i '$a \
    none defaults,bind 0 0' /etc/fstab
sudo mount -a
4.2.4s backed by lvm
It is  use LVM partitions as the s . Advantages of this include
flexibility in storage management and fastcloning. The toolsto using a VG (volume
group) named lxc, butused through command line options. When a LV is used as
a, the's till/CN/config, but the
root fs entry in that file (lxc.rootfs) will point to the lV block device name, i.e. /dev/lxc/CN.withy tree and LVMcan co-exist.
4.2.5. Btrfs
If your host has a btrfs /var, thewill detect this and automatically exploit it
by clonings using btrfs snapshots.
4.2.6. Apparmor
LXC ships with anintended toaccidental misuses of privilege
inside. For instancebe able to write to /proc/sys or
to most /sys files.
The uprofile is entered bylxc-start. Thismainly prevents lxcstart from mounting n outside of's. Before executing th's init, LXC requests a switch toprofile. the lxc-31-default is defined in //lxc-defaul
 from accessing many dangerous paths, andmostsfind that  is failing due to a legitimate access being denied by itspolicdisable theprofile by doing:
sudo apparmor_parser -Rdisabled/makrun unconfined, but continue to confine itself. If you also wish
to disable confinement, then in addition ing t,add:
lxc.aa_profile =
wish to run in a custom profile,create
a newunder. Its name must start with lxc- in order forto be
allowed to transthat The cludes the re-usable abstractions file /
/lxc/-base. An easy way to start therefore
is to do the same, then add extra permissions at the bottom of your policy.
After the policy, load it us
Thewill fter a reboot, because it is sourced by the file /etc/
. Finally, to make CN use this new lxc-CN-add the
fline to its
lxc-execute does not enter , but thit spawns will be confined.
4.2.7. Control Groups
Control groups (cgroups) are a  providing hierarchical task grouping and per-cgroup
resource accounting and limits. They are used into limit block and character device access
and to freeze (suspend). Thfurther used memory use and block i/o,
guarantee minimum cpu shares, and to lockpusLXC depends on
the  package to , which provides the proper cgroup initialization at boot. The
mounts each cgroup subsystem separately under /sys/fs/cgroup/SS, where
SS is thename. the freezeris mounted
freezer. LXC cgroup are kept/INIT/lxc, where INIT is the init task's
cgroup. This is / , so in the endcgroup  CN would be
cgroup/freezer/lxc/CN2
4.2.8. The must be run with root user privilege. A utility c-setup
was written with the intention ofthe toolsneeded file capabilities to allow nos to run suas root in cannot yet be reliablyd, this is not worthwhile. It is therefore recto not use lxc-setupprovide
theors the needed sudo
The user namespace, expected to be in the next Long Term Support (LTS) release,
will allo, as well as reduce the amount required
for ndering.
4.2.9. LXC Upstart Jobs
As listed above, the lx includes two u. The first, lxc-net, is always started when
the other, lxc, is about to begin, and stops when it stops. If thevariable is set to
false in s/lxc, then it will immediately exit. If it is true, and an error occurs bringing
up the , thennot start. lxc-net will bring down when
stopped, unless s runningusing t.job starts on runlevel 2-5 truelook under
/etc/lxcs which . Wis either
manually or by entering0, 1, or 6,stop thoseTo rto start , create a /lxc/name.conf
pointing to th fil, the  forCN is . To make thatuto-start, use the command: CN.conf
4.3.4.3.1. 
The easiest way to is using lxc-create. This script uses distribution-specific
templates under / to set up-friendly chrootvar/lib/
lxc/CN/rootfs, and initializein /CN/fstab and
config, where CN is name
The simplescommand would look like:
sudo -t ubuntu -n CN3
This tellstoubuntu template () and to callCN (-n CN). Since
nowas specified (which would have been done with `-f file')use the defaultunderlxc.conf. This givea single veth network interface
attached to the lxc.
can also accept aThese can be listed after --.oneiric1 -- -r oneiric
passes the '1' to the .
4.3.1.1. Help
Help o-mmand can be seen by -h. thes also take
their own If you doh
then the generalhelp will be followed by help output  If no i, then only help foritselfshown.
4.3.1.2. U
T can be used Ubuntu syste with any release at least as new
as 10.04 LTS. It uses da cached filesystem which gets copied into place
each time created. The cached image is saved and only re-generated when you create a using the -F (flush) option to , i.e. -- -F
The Ubuntuinstalled bythe same as that on the host, unless otherwise
-r option, i.e. -- -r lucidant32-bion a 64-bit host, pass -a i386 to the.the
qemu-user-statistalled, tanusing any architecture supported
by 4will have a user named ubuntu whose password is ubuntu and who is a member of
the sudo groupwish to inject a public ssh key for the ubuntu usedo so with -S
sshkey.pub.also bind user jdoe from inb jdoe optiocopy
jdoe'sand shadow entries, mhis default group and shell are
add him to , and bind-mount his home directorywhen theis started.
When , the releasearchive is added's sources.list,
and its package archiveupdated. Is older than 12.04 LTS, then the
lxcguestwill be . Alternatively, if the --trim option is , then
the not be , and many servicesremovedcontainer.
This will result in a faster-booting, but less upgrade-able
4.3.1.3. Ubuntu-cloud template creates Ubuntus by downloading and extracting the publishedloud images. It accepts some of the same optio, namely -r release,
-S , -a arch, and -F to flush the. It s a few extra The -C
option willloud, configured for use with a metadata service. The -u option accepts
a cloud-init user-data file to th on start. If -L is passno local
The -T option hoose a tarball location to extract in c tarball. Finally the -i option sets a host id for, which  is set to a
random string.
4.3.1.4.  Other templatesand us are well . are however.
The debiana Debian baseusingmuch as the 
doe it installs a debian squeeze image. An alternatecan be chosen by setting the
SUITE evariable, SUITE=sid-t debian -n d1
Sinccannot be safely booted inside adebianstrimmed as with the
to.
To purge image cache, call thedirectly and pass it the --clean option.
sudo lxc-debian --clea35
A fedoraexists, whichs fedora releases <= 14. F
15 and higher aresystemd, whichis not yet abvert intobootable setup. Bisrun, yo tothat yum and curl
are 12 can be created withfedora -n fedora12 -- -R 12
A OpenSuSEbut it requires the zypper program, which packaged. The
is therefore not
Two mors exist mainly for experimental purposes. The busyboxcreates a very
small  based entirely on busybox. The sshdn 
running sshd in a pr. The host's library and binaryies are bindmounted i, though not its /home or /root. To create, start, and ssh into an ssh, you mightsshd -n ssh1
ssh-keygen -f id
sudo xc/ssh1/rootfs/root/.ssh
sudo cp id.pub/authorized_keysstart -n ssh1 -d
ssh -i id root@ssh1.
4.3.1.5.  Backing Stores places  as atree atrootfs. Another to use LVM logical volumes. If a volume group named lxc exist
create an lvm-backedlled CN usingB lvmuseschroots, with a 5G xfs , then you would useB lvm --vgname schroots --fssize 5G --fstype xfs
4.3.2. Cloning
For rapid provisioning, you may wish to customize a canonicalaccording to your needs
and then make pies of it. This can be done lxc-clone program. Given an existingcalled C1, a n called C2 using6lone -o C1 -n C2
If is a btrC2' as a of C1's.
is lvm backespecify the -s option to create the new
rootfs as a lvmthe original as followslone -sBoth lvm and  will provide fast cloning with very small initial disk usage.
4.3.3. Starting and stopping
To start a, use lxc-CN.will execute /sbin/init in th.provide a different program to execute, plus arguments, as further to
loglevel=debug
 not d (daemon) optionill see a console (on the's /dev/
console, see 3.6, “Consoles” [p. 338) on the terminal. If you
option, you will not see that andi success - even
if a later part ofstartup has faileduse lxc-wait or lxc-monitor (5,
“Monitoringtus ) to check on theor failure of startup.
To obtain LXC debugging information, use -o filename -l debuglevel, for instancstart -o lxc.debug -l DEBUG -n
you canconfiguration parameters inline using -s.it is
recplace them ifile instead. Likewise, an
aconfig file can be fbut this is not .
Whileruns, lxuses a minimal inicalled lxcinit, which attempts to mount /proc, /dev/mqueue, and /dev/shm, executes the programson
the co, and waits for those to finish executing.is intended to be used for systems, wexecute for s (see  this article
23
 for more).
2www.ibm.com/developerworks/linux/library/l-lxc37stop  several waysshutdown, poweroff and reboot while logged
i. To cleanly shut downexternally (i.e. ), you can issuelxc-shutdown -n CN command. This takes an optional timeout value. Ified,issues a SIGPWR signal to and return
used, as in sudo -t 10, then will wait thnumber of
seconds fort. Then, iis still running, it will kill it
(and any runnings)alsokillany chance for
s ) usingtop -n CN.lxc-kill canmore
generally to send any signal number's init.
Whileis shutting downexpect to see some (harmless) error messages, as
$ sudo
buntu: =
$ =
message from ubuntu@cn1(console) at 18:17 ...
The system is going down for power off NOW!
 * Asking all remaining processes to terminate...
   ...done.
 * Allended within 1 seconds.Deconfiguring nsactivating swapfail!
umount: /run/lock: not mounteddev/shmmount: / is busy
 * Will now halt
A can be frozen withfreeze -n CN. This will block all itsuntil th is later unfrozenun
4.3.4. Lifecycle management hooks
Beginning with , it is possible to define hooks to be executed at points in 's lifetime:
• Pre-start hooks are run in the host's namespace bcontainer ttys, consoles, or mounts are
up. If any done in this hook, they should be cleaned up in the post-stop hook.
• Pre-mouns, butroot  has been
mounted. Mounts will be wntainer shuts
dow38
• Maftes hmounted
has called pivot_root to change its .
• Sbefore the's init. se aed
after pivoting into, the commandmust be co.
• Ps has been .
If any hook returns an error,runborted. Any will still be
execuoutput generated by the scriptlogged at the debug priority.4.4.5, “Other cooptions” [p. 344]file format with
which to specify hooks. Some sampleshipped with the lxto serve as an example
of how to write and use such hooks.
4.3.5. 
Two commands are to monitor state changes. monitors one or mors for anyIt takes name as usual-nin this case
 name can be a posix regular expression to allow monitoring desirable sets s.
continuess it printswait a state
change and then exits.monitor -n cont[0-5]*
would print all to anys matching the listed, whereawait -n cont1 -s 'STOPPED|FROZEN'
untilont1 enters state STOPPED or state FROZEN.
4.3.6. Consoleshave a ble  consoles. One always exists on . This is shown on the terminal from which you ran, unless the -d . The output on /dev/console can be redirected to a file using the -c console-file option t. Thextrs is by the lxc.tty and is usually set to 4.
Those are/dev/ttyN (for 1 <= N <= 4). To log into console 3 , useonsole -t 39
or if the -t N an unusedhosen. To exit theuse the escape sequence Ctrl-a q. Note thatdoes not work isole
resulting from without .
Eachsole is actually a Unix98 pty in the host's guest's) pty mount, over the guest's and. Therefore, if unmounts those or
otherwise tries to access the actual character device 4:N, it will not be serving getty to the LXC
(With the default settingsableatand
getty will therefore fail.) easily happen when a boot script blindly new /dev.
4.3.7.  Inspection
Several gather i on existings. lxc-ls will report all
 in its first line of output, and allcontainers in the second line. lxc-list
prsamein a more verbose format, listingfirst and stopped next. lxc-ps will provide lists of inTops arguments to lxcps, prepend them with -, forof all plain,ps -n plain -- -ef
lxc-infs the state of and the pid of its init process. lxc-cgroup 
to query or set the values's control group limits and.bevenient than interacting cgroup .o query the list of devices
which a is allowed, you cogroup -n CN devices.list
or to add mknod, read, and write access to /dev/sdacallow "b 8:* rwm"
and, to limit it to 300M of RAM,
-n CN memory.limit_in_bytes 300000000
lxc-netstat executes netstat in the, giving you a glimpse of its network state.
lxc-backup will create backups of the rs of all (except lvm-based
ones), using rsync to back the contents up under rootfs.backup.1. Thes40
stored using lxc-restore.and are fragile with respect to
customizations and therir use is not recommended.
4.3.8. Destroyi
Use lxc-destroy to destroy an.destroy -n CN is will exit with a message informing you thatforce
stopdthe wit -f
4.3.9. usage
One of the Linuxs used by LXC to creats is private s.
Namespaces allow a set of tasks to havemappings of names to resources for things
like pathnames and process IDs. (S10, 349] for a link to more). Unlikes and other mount features which are also used,
 cannot be manipulata interface.the lxcunshare prmainly for testing. It abilitynew tasks in privateunshare -s 'MOUNT|PID' /bin/bash
bash shell withpid and mount In this shell,do
root@ubuntu:~# mount -t proc proc /procps -ef
UID        PID  PPID  C STIME TTY TIME CMD
root1     0  6 10:20 pts/9    00:00:00110     1  0ps -ef
so that ps shows only theyour new.
4.3.10. Ephemeral
 are one-time.CNrun a
command in an e created based on CN,host's jdoe user bound into th, usin41--b jdoe -o CN -- /home/jdoe/run_my_job
job is finished, tll be discar11.Commandstable of al commands:
Table 20.1. commands
Command Synopsis
lxc-attach (NOT SUPPORTED) Run a Back up thefor all sView and setsettings
lxc-checkconfig Verify host support forpointCheckpoint 
lxc-clone Clone a nfrom aone
lxc-console Open a console inreate container
De
lxc(not running) lxc-freeze Freezeinfo Print ithe
lxc-kill Send a sa's init
lxc-list List s
lxc-ls with shorter output than lxc-list
lxcMonitor state changes of one or morenetstat Executeps ViewinforestarRestart a ced
lxc-restore Rest frommade by lxc-backup
lxc-setcap (NOT RECOMMENDED) Set file capabilities on LXC tools
lxc-setuidor remove setuid bithutdown Safe
lxc-start Start a stopp2startStart (one-time)stop Istopunfreeze Unfreeze a frozenunshare Testing tool to manually unshare
lxc-version Print the version of thewait Wait for  to reach a particular state
4.4. CoFile
LXC are very flexible. The Ubuntu lxsets defaults to make creation of Ubuntu
as simple as possible. If you need more , this chapter will show how to
fine-tune you as.
Detailedis lxc.conf(5) man page.default cs
y the s are reasonable for a and usually do not need.
4.4.1. Choosing files and options
Tsetup is controlled by options. Options can be at
several points:
• Durin, a.templates often
insert their ownoptions, so wespecify only network at
this point. For other, it isbetter to edit theafte
creation.
• The fileconfig is used at  startup .
• accepts an auration file-f filename option.
• Specificvariableoverridden atusing -s key=value. It istain file.
4.4.2. Network networking in LXC isIt is triggerlxctyp
file entries. If no such entries exist, then twill share the host'sstack.
Services and connections started ibe using. If at least
one entry is presenhave a private (layer 2) network
stack. It will have its owninterfaces and firewall rules. There are several options for
:
•=empty: noother than loopback.veth: This is thewhenubuntu or , andvethtunnel. One end of this tunnel becomes the inside th43. The other end is attached to a bridged on. Any such tunnels can beadding morevetfile. The
bridge to whiche tunnel will beiswithlink =
lxcbr0phys A ne (i.e. eth2) is passed into the.
Two otherare to use vlan or macvlan, however themore complicated and is not
described here. A few otheroptions existflags can only be set to up and ensures that thes uphwaddrs a mac adassign the the nicipv4 andipv6 set the respective , if those should be staticnamename to assign If this is not, a good
default0 for the first nic) is chosenlxcscript.upscript to be called host side ofing has
been set up. See the ual page for details.
4.4.3. 
Cgroupusing lxc.cgroup.subsystem.item = value
instructs LXC to set cgroup 's item tot is perhaps simpler to realize that this will
simply write value to the file itemfor. to set the memory limit to 320M,add
m= 320000000
which will cause to be writtenmemory/lxc/CN/
l.
4.4.4. Rootfs, mounts and fstab
An important etup is the mounting of various filesystems into place. The following
is an example file excerpt demonstrating the commonly usedoptions:
lxc.rootfs =
lxc.mount.entry=proc/nodev,noexec,nosuid 0 0fstab
Tline says that the's is already mounted at
Ifa block device (such as an )path to the
must be given instead44
Each  line should contain anmount in valid fstab format. The target 
prefixed by, even if points to . file, in, containing further items to mount.all of
these entriesmounted by the host b init is started.way it is possible
to bind mountdirectories  into.
4.4.5. 
• lxc.cap.drop can be used to preven from having or ever othe listed
.including
= sys_admin
will, as well as all other actions which require
cap_(7) mana list of  and their meanings.
• lxclxc specifies a custom profile in tart th. 2 i.
• lxc.console=consolefileconsole messages filerchthe afor, for instance x86, or x86_64.
• lxc.tty=5at 5 consoles (in addition to ) created. That is,
vailable on /dev/tty1 through5. The set this
pts=1024theshould Unix98) devpts mount.
then /dev/pts wit, which is rarely desired.
The number 1024 means that 1024 ptysallowed i,is number is
currently ignored. Before starntainer init, LXC will do (essentially) a
sudo mount -t devpts -o newdevpts /dev/ptsIt is tonot moun
of its own. It may safely do bind or move mounts of its mounted. But if it doest will remount the host's devpts instance. If it adds themount option, then it will
mount a new empty)n neither case will itwhich was set
up by LXC. reason, anptys, the default5
olicy will not allows to 's inittarted.
• lxc.devttydir under /dev in whichcreate its console devices. If
this option isptys will be bind-mounted over and /dev/
ttyN.rare package uy try to blindly rm -f and then mknod thos
They will fail (because the file has been), ca to fail. When
is set to LXC, then theptys onto /dev/
lxclxc/ttyN, and subsequently symbolically link them 
ttyN. This allows thto succeed, at the risk of making future gettys
on thoss fail until the next reboot. This problemideally solved with device
• The lxc.hook. options specify programs to run atp's life cycle. See
4, “” [p. 337 on these hooks. To
have hooks called at any point, list them inentries. The values, whose
precise meanings are described in , are
•pre-startmounost-stopinclude optionnother cofile to be loadedcommon
sections to be defined once and included by seve, simplifying updates
of the common sectiolxc.seccomp option (introduced with) file containing a seccomp
policy to load.9, “Security” [p. 34 on seccomp in lxc.
4.5. Updates in
some limitatare placed on,grades at times can fail.ainstall or upgrade might fail if it ised to create or open This often blocks all future upgradesissue is resolved. In some cases,work around
this by chrooting into ther, to avoid restrictions, and completing th in
the chroot.
Some of the specific things known to occasionally impedeinclude:
• T modifications performed when creating with the .
• Acby lxcguest.because /lib/init/fstab isfrom
another file, mountallwhich insist on replacing that file
• The over-mounting of  with ptys can cause trouble with udev
upgrades6
•olicy and devices cgroup can preventfrom performing
certain actions.
• Cdropped by use of lxlikewise stop4.6. Liis a powerful management solution with whichadminister Qemu, Xen and
LXC virtual machines, both locally and remote. The l driver is a separate implementation
from what we normally call LXC. A few differences is stored in xml format
• There no tools to facilitate creation
•there is noonis no support (yet) forreboot or full shutdown
4.6.1. Converting a  to libvirt-lxc1, ” [p. 332] showed how . If you'va validin this wamanage it with libvirt. Fetch a sample xml file
frompeople.canonical.com/~serge/o1.xml
Edit this file to replace tname and root filesystem locations. Thenefine th witlxc:/// define o1.xml
4.6.2. container from cloud image
If you prefera pristine njust for LXCdownload an ubuntu cloud
image, extract it, and point axmlifind the url for a root tarball for
the latest daily04 LTS using
url1=`img-query precise daily $arch --format "%{url}\n"`
url=`echo $url1 | sed -e 's/.tar.gz/-root\0/'`
wget $url
filename=`basename $url`
Extract the downloaded tarbal7
mkdir $HOME/c1
cdsudo tar zxf $filename the xml templateIn,name o1 with c1 and the source o1/rootfs
with. Then dusing
virsh3. Interactings
As we've seecreate-lxc-c .xml
 called, uselxc:/// start
To stop a runnidestroywhereas the lxccommand deletes thethe virsh mmand stops
. To delete definitionundefin
To get a console to8consolExit theby simultaneously pressing control and ].
4.7. The lx
In the 11.04 (Natty) and 11.10  releases of Ubuntu, awas incalled.
An unmodified root image could not be sbut an image with the
 installed could be booted as aon bare hardware, or in a Xen, kvm, or
VMware.
As of the  release, the work previously done by t was pushed into the
core packages, andremoved. As a result, aimage
can  To use
an oldershould still be used.
4.8. Python api
As of 12.10 (Quantal) a python3-lxis which provides module, called
lxc, for managing s. Anpython session and start an
called C1, then wait until itshut down, would look like:
# sudo python3
Python 3.2.3 (default, Aug 28 2012, 08:26:03)
[GCC 4.7.1 20120814 (prerelease)] on linux2
Type "help", "copyright", "credits" or "license" for more i>>> import lxc
__main__:1: Warning: The python-lxc API isn't yet stable and may change at any p
oint in the future.
>>> c=lxc.("C1")
>>> c.create("ubuntu")
True
>>> c.start(wait("STOPPED")
True
Debug s started python API will be placed in 
lxclog.
4.9. Security
A namespace maps ids to resources. By not providing  any id to reference a, the can be protected. This is the basis of security afforded to9
users.IPCs are completely isolated. Other, however, haveleaks which allow privilege to be inappropriately exerted frominto another
 or to the host. areunder ato restrict some actions.
while stronger security is a goal for future, inthe goal of theis
not to stop malicious actions but ratheraccidental harm of by the guest. The details of
AppArmor integratlxc are in section
4.9.1. Exploitable system calls
It is a core feature thats share a kernelhost. Therefore if the kernel
contains any e thcan exploit these as well. 
controls it can fully control anySincecan also be constrained by a seccomp filter. Seccomp is
a newwhich filters th which may be used by a task and its children.
While improved and simplified policy mais expected in the near future, the current policy
consists of a simple whitelist of numberlicy file begins with a version number
(which must be 1) on the first line and a policy type ''second line. It is
followed by a list of numbers, one per line.
In general to run a full distributiona large needed
for applicas it may be possible to re to only
a few. Even forontainers runninggains may be had, for instance
by removing the mpatibility in a 64.4optiononfigure ato use seccomp. nopolicy is loaded.
4.10.The DeveloperWorks article LXC: Linuxols
24
 was an early introduction to the use ofs.
• The  Secure  Cookbook
25
 demonstrated modules to ms
more secure.
• Masd above can be found at:
c
26
lxc.conf
27
• The upstream LXC project is hosted at Sourceforge
28
.
2
2security/index.html
maen/man7/.7.html
5/lxc.conf.5.html
28xc.sf.ne50
• LXCissues are listed and discussed at the LXC wiki page
29
• For more onin Linux, see: S. Bhattiprolu, E. W. Biederman, S. E. Hallyn, and D.
Lezcano.Servers and Check- point/Restart in Mainstream Linux. SIGOPS Op- erating
Systems Review, 42(5), 2008.
wikLxcSecurity321. Clustering
352
1. DRBD
Distributed Replicated Block Device (DRBD) mirrors s between sts. The
reis transparent to othes on the host systems. Any hard disks,
partitions, RAID devices, lo, etc can be mirrored.
To get started using drbd, first install the necessary packages. drbd8-utils
If you are using thekernel as part of a you will need to manually
compile the drbd module. Ieasier tolinux-server package inside the
v.
This section covers setting up a drbd to replicate a separate /srv , with an ext
between two hosts. The size is not particularly relevant, but bothsbe the
same size.
1.1.The in thiswill be called drbd01 and drbd02. Theyhave name
reconfigured either through DNS or the /etc/hosts file. See Chapter 
Service  for details.
• To  drbd,host edit /etc/drbd.conf:
global { usage-count no; }
common { syncer { rate 100M; } } r0  protocol C;startup        wfc-timeout  15        degr-60}netcram-hmac-alg sha1shared-secret "secreton drbd01device /dev/drbdisk /dev/sdbaddress 1:778     meta-disk internalon drbd022:7788;3   } 
There are many other options in, but fortheir default
values are fine.
• Now copy to the second host:
scpdrbd02:~
• And, move the file to /etc:
sudo mv  /etc/
• Nowdrbdadm utility initialize the meta data storage. On each server execute:
sudo drbdadm create-md r0
• Next, on both hosts, start the drbd ddrbd start
• On01, or whichever host you wish to be the primary, enter the following-- --overwrite-data-of-peer primary all
• Afting the above command, the data will start syncing with ary host. To watch
the progresswatch -drbdwaoutput press Ctrl+c.
• add a filesystem to and mount it:
sudo mkfs.ext3 /srv
1.2. Testing
To test thatis actuallyhe hosts copy some files o
to /srext, unmountu4
Demot server ary rolsecondary r0
Now onserver promote it to primary r0
Lastly, mount the:Using ls you should see /srv/default copied formhost drbd01.
1.3. Referencesi on DRBD see the DRBD web site
1man page
2
 contains detailoptions not coveredguide.
• drbdadm 3DRBD Ubuntu Wiki
4
 page also has more .
1
http://www.drbd.org/
ma.5.html
3
htt8/drbdadm.8.html
DRBD355
Chapter 22. VPN
OpenVPN is aPrivate  (VPN) provided in the Ubuntu Repositories. It is
flexible, relisecure. It belongs to the family of SSL/TLS VPN stacks (different from IPSec
VPNs). This chapter will cover installing anding OpenVPN to VPN.VPN
356
1. OpenVPN
If you want more than just pre-shared keysmakes it easy to setup and use a Public Key
Infrastructure (PKI) to usecertificates for authentication and key exchange between
the  and clients can be used in a routed or bridged VPN mode and can beed to use either UDP or TCP. The port number can beed as well, but port 1194 is the
official one. And it is onlyat single port for all communication. VPN client implementations
are for athing including all , OS X, Windows and OpenWRT
based WLAN routers.
1.1. Server Installation
To install openvpn in a terminal enteopenvpn
1.2. Setup
The first step in building ancois to establish a PKI (public key i).
The PKI consists of:
•  (also a ) and private key for the server and each client,
and
• a master  and key which is used to sign each of
clients.supports bidirectional , meaning that the client must
emustebefore mutual
trust ised.
Bota wile the other by first verifypresented
was signed by the masteruthority (CA), and then by testing iin the now header, such as thecommon name otype (client or
server).
1.2.1.Setup
To setup your ownand generating and keys for 
clients first copy the easy-rsa directory to /etc/openvpn. This will ensure that
any changes to the scripts will not be lost when the s updated.change to
user root and:
mopenvpn/easy-rsa/
cp -r xamples2.0/*VPN
357vars adjusting the  to your e:
export KEY_COUNTRY="US"PROVINCE="NCCITY="Winston-SalemORG="Example CompanyEMAIL="steve
to generate :
cd
source vars
./clean-all
./build-ca
1.2.2Next, we willa:key-server myservername
As in the previous step, most parameters can be defaulted. queries require positive
responses, "Sign ? [y/n]" and "1 out of 1requests certified, commit? [y/n]".
Diffie Hellmanmust bedOpendh
Allhave beenin the subkeys/. Common practice is to copy
them /:
cd keys/
cp.crtkey ca.crt dh1024.pem
1.2.3. Clients
Thewill also need toitself to the server. Usually you create a
for. To create, enter in while
being build-key client1
Copyfilclient using a secure method:VPN
358
•ca.crtkeys/client1key
As the  and keys are only required onmachine,remove them
server.
1.3. Simple Server 
Along with youri you got these sample config files (and many more if if you
check):
root@server:/# ls -lsample-config-files/
total 68
-rw-r--r-- 1 root root 3427 2011-07-04 15:09 client.conf4141server.conf.gz
Start with copying and unpacking 
sudo cp/
sudo gzip -openvpn/ to mlines are pointing tos and
keysd in the section above.
ca ca.crt
cecrt
key
dh
That is the minimum you have to configure to get a workingserver.all thesettingsample file. Now start tfind logging and error
messages in your syslog.# service openvpn start
 * virtualnetwork daemon(s)...
   *   Autostarting VPN 'server' [ OK ]
Now check ifreated a tun0 interfaceifconfig tun0
tun0      Link encap:UNSPEC  -00  inet addr:10.8.0.1  P-t-P:10.8.0.2  Mas255UP POINTOPOINT RUNNING NOARP [...]VPN
359
1.4Clientvarious Open with and without GUIs
read more about clients in a later section. For now we use thelient for Ubuntu which
is the same executable asSoinstall thpackage again
machine:
sudo apt-get i
This time  .client keys and the of the CA to e.g. /etc/
openvpn/ and eopenvpn/ose
files. Ifhe files in you can omit the path.key
Andat least specifyserveraddress. keyword client
iconfig. That's what enables client mode.
client
remote vpnserver 1194
:
root@client:   client     [ OK ] 
it c65 can pingping 10.8.0.1
PING (10.8.0.1) 50.8.0.1: icmp_re920 msVPN
360
Tserver always uses the first usable  inetwork and only
that IP is pingable. E.g. if youd a /24client network mask, the .1 address
will be used. The P-t-P address you see in the output above is usually not answering
ping requests.
Check out your routesnetstat -rn  MSS Window  irtt Iface
10.8.0.5        0.0.0.0         255 UH        0  0 tun0
      GH         0   U        et1   UG1.5. First trouble shooting
If the above didn't work for you, check this:
• Check, e.g. grep -i vpn syslog
• Caconnect  machine? Maybe a firewall is blocking access? Check syslog
on server.
• Client and server must use same protocol and port, e.g. UDP , see port and pro
optionconfig regarding compression, see comp-lzo config bridged vs routed mode, see server vs serverbridge1.6. Advanvedation
1.6.1. routed VPN 
Tis a very simpleVPN. The client can access services on themachine
through an encrypted tunne want to reach more servers or anything in other networks,
push some routes to tsr company can be summarized to the network
16, you could push this routeBut you hange the routing
for the way back - yourneed to know a-network.
Or you might push a default gateway to all to send all their internet traffic to the VPN
gateway first and from there via the companynto the. This section shows you some
possible options.
Push to allow iother private subnets behind the server. Remember that
theseto know to route theaddress pool0/24)
back toserver.VPN
361
push "route 10.0.0.0 255.0.0.0"
If enabled, this directive wille all clients to redirect thhrough
the VPN, causing all IP traffic such as web browsing and and DNS lookups to go through the VPN
(server machine or your centralmay need to NAT the TUN/TAP interface to
t in othis to work properly).
push "redirect-gateway def1 bypass-dhcp"
Configu mode and supply a VPN subnet forto draw client addresses from. The
server will takefor itself, the rest will be made to clients. Each clienable to
reach t on. Comment this line out if you are ethernet bridging.
server 10.8255.255.0
Maintain a record of client toassociations in this file. Igoes down or
is restarted, reconnectingcan be assigned the samepool that was
previously.
ifconfig-pool-persist ipp.txt
Push DNS servers to the client.
push "dhcp-option DNS 10.0.0.2"1.0.2"
Allo co
client-to-client
Enable link.
comp-lzo
The keepalivecauses ping-like to be sent back and forth over the link so that each
side knows other side has gone down. Ping every 1 second, assume that remote peer is down
if no ping received during a 3 second time period.
1 3
It's a good idea to reOpenVPN daemon's privileges after initialization.
user nobody
group nogroupVPN
3622.0 includes a allows the to securely obtain a username and
password , and to use that information as a basis for ngTo use thison methoadd the auth-user-pass configuration. It
will touser for/password, passing it on to t
secure TLS channel.
# client config!

This will tellvalidate the entered byusing the
login PAM module. Useful icentralizedwith e.g. Kerberos.
plugin openvpn/openvpn-auth-pam.so loginadhardening security guide
1
 for furtheradvice.
1.6.2. on servercan be setup for either a routed or a . Sometimes this is also referred
to as OSI layer-2 versus layer-3 VPN. Inallframes - e.g. allframes
- are sent to the VPN partners and inVPN onlypackets.
Inmode all traffic itraffic which was traditionally LAN-local like localbroadcasts, DHCP requests, AR etc. whereas in routed mode this
would be filtered.
1.6.2.1. Prepare interface config foryou have the bridge-utils package installedsetupiyouchange yourLet's
assume has aneth0 connected to the internet and1
the LAN you want to bridge. Your /etc/networ would like this:
auto eth0
iface eth0 inet static
  address 1.2.3.4
  netmask48
  default 1.2.3.111openvpn.net/index.php/open-source/documentation/howto.html#securityVPN
3630.0.00
This straight forwardneeds to be changed into mode like where the config
of1 moves to the new br0. Plus wee that br0 should bridge
eth1. We ato matis always in promiscuous mode - this tells the
to to the IP stack.manual
  up ip link set $IFACE up promisc on
auto br0
iface br  bridge_ports eth1
At this point restart networking. Be prepared that this might not work as expected and that
you will lose remote connectivity.you can solve problems having local access.
sudo service network restart
1.6.2.2serveropechanging the following options to:
;dev tun
dev tap
up "up.sh br0 eth1"
;seserver-bridge 10.0.0.40 10.0.0.12854
helper add the tapto the bridge and to ensure that eth1 is
. Createup.sh:
BR=$1
ETHDEV=$2
TAPDEV=$3
/sbin/"$TAPDEV" upVPN
364ETHDEV"/sbin/brctl addif $BR $TAPDEV
Then make it :
sudo chmod 755
Afturing the server, restart openvpn by entering:openvpno
First, i on the clientopenvpn
Then witconfigure client certificates copi directory,
create a file by copexample. In a terminal machine enter:
Now e:You should now be able to coremote LAN t.
1.7. Client software 1.7.1. Linux Network-Manager GUI for OpenVPN
Many iUbuntu desktop variants come withManager, a nice
GUI to  yoursettings. It also can manage your VPN connectionyou
havenetwork-manager-openvpn installed. Here you see that the installatios all other
required packages as well:~# 
Readinglists... Done
Building dependency tree       state i... DoneVPN
365
Textrawill bed:
  liblzo2-2 libpkcs11-helper1 -gnome openvpn
Suggest:
  resolvconfNEW
 0 upgraded, 5 newly, 0 to remove and 631 not.
Need to get 700 kB of archives.
After this operation, 3,031 kB of additional disk space will be used.
Docontinue [Y/n]? 
To inform about the newhave toitr-manager 
 start/running, process 3078
Open the GUI, select the VPN tab and then the 'Add' button. Selectas
ype in the opening requester and press 'Create'. In the next window add the OpenVPN's
server name as the 'Gateway', set 'Type' to ' (TLS)', point 'User ' to your user
, 'CACA and 'Private Keyprile. Use the
advanced button to enr other special settings you set on the server. Now try to
establish.
1.7.2.withMac OS X: Tunnelblick
 is an excellent free, open source of a for OS X. The
project's homepage is at http://code.google.com/p/t/. Download the latest OS Xrre and install it. Then put your client.ovpn config file togetherand keys
in /Users/username/Library/ Support//s/ and lauchfrom your folder.
# sampleforclienblue

proto udp
-type tun
ns-cert-type server
reneg-sec 86400auth-nocache
auth-retry interact yes
verb 3client.crt
key client.keyVPN
366
1.7.3Win 7
First dopenVPNInstaller
2
2.2.1 was
when this was written. Aly alternative Open GUI. TheMI GUI from http:/mi-gui.inside-security.de seems to be a nice one for Windows
7version. 20110624 version 
Yostart theservice. Goto Start > Computer > Manage > Services and
s. Fin service and start it. Set it's startup type to automatic.
When you MI GUI the first time yrun it as an aor. You have
to right click on it and see that option.have to write yourconfig in a textfile and place it in C:\Program Files\OpenVPN
\config\along. You could put the userin's home
 like in the follwing example.
#serve"C:\\Users\\username\\My Documents\\openvpn\\"
key key"
management 127.0.0.1 1194-holdquery-passwords1.7.4for OpenWRT
OpenWRT is described as a for embedded devices like. There are
certain types of who can be flashed to run OpenWRT. Depending on the 
memory onWRT router you can run likeand yfor example
build a small inexpensive branch office router withvity to the central office. More
info ono is here
3
. And here is the OpenWRT : http://
openwrt.orgwww.opewnloadswiki./doc/howto/vpn.overviewVPN
367
Log intoand install OpenVPN:
opkg update
opkgopenvpn/etc/config/openvpn and put you  in there. Copyd and keys to
config openvpn client1
        option enable 1 client#dev tapoption dev tun  caca.crtert keykeyomp_lzo 1  servicerestartsee ifadjust your router's routing and firewall rules.
1.8.SeeVPN
4
 website for i
•ha5Pakt's and Integrating Virtual s
6
 is a good resource.
4
.net/pacopenvpn/book3683. Other Usefuls
 many very useful as developed by the Ubuntu Server Team, and others that are
well integrated withEdition, thatbe well known. This chshowcase
somethat can make aing an Ubuntu server, or manys, that
much easier.369
1. pam_motd
When logging into you may have noticed the ve Message Of The Day
(MOTD). Thison is obtained and displayed using a couple of:
• landscape-common: provides the core libraries oflient, which can be used to manage
systems using the web based Landscape. The cludes the /usr/bin/sysinfo utility which isgatheronin the MOTD.
• update-notifierally uMOTD via module.
pam_motd executes the scripts in /etc/update-motd.d in order the number prepended to
. The output ofs /var/run/motd, keenumerical order, then
concaten/etc/motd.tail.dd your own dynamicto F, to add local weather
on:
• the weather-util packag
• Tuses METAR data National Oceanic and Atmospheric and forecastsWeather Service. In order to find localneed
the 4-character ICAO location indicator. This can be determined by browsing to the National

1
 site.
  is a United States government agency there ar
stations world wide.for alls outside the U.S.
may not be.
•usr/local/bin/local-weather, a simple shell us with your local ICAO
:#
#
# Prints thethe MOTD.
#
#
# Replace KINTweather station.
# Local can be found herewww.weather.gov/tg/siteloc.shtml
echo
weather -i KINT
echo
70
• Make 
• symlink to/98-:
sudo ln -s /
•exit the server and re-login to view the new MOTD.now be greeted with , and somelocalthat quite so useful. Hopefully-weather example demonstrates the
of71
2. etckeeper
 allows the contents of /etc be easily stored in  (VCS) repository.
It hooks into apt to commit changes to /etc when are installed or upgraded.
Placing /etc undercontrol is considered an industry best practice, and the goal of is
to make this process as painless as possible.
Install the fin a terminal:
sThe main configuration file, /etc/.conf, is fairly simple. option is
which VCS to use.ised to use bzr fo. The is
initialized (and committed for the f) duringstallation. It i to
undo this command:
sudouninitwill commit unchanges madedailyisabled
using the AVOID_DAILY_AUTOCOMMITSopwill als
before and afterFor a more precise tracking of changes, it is
recommended to commit yourmanually, ta commit message, usingcommit "..Reason forchange.."
UVCS commandsview log i about files in /etc:
sudo bzr log /etc/passwd
To the intthemasystem, install postfixpostfixin is finished, all the postfixfiles should beto the
:
Committing to: /etc/
added aliases.db
modified groupshadowshadowpasswdpasswdadded postfix2
added readded rsyslog.shadowadded init.d/postfix
added network/if-downuppostfix/dynamicmaps.cf
/mainsterpost-installpostfix-filesscriptsaspp/ip-down.d
added pppp/ip-rc0.d/K20rc12.d/S3456/update-libc/postfix.conf
added ufCrevision 2.
For anof howtracks manualadd new a host to /etc/hosts. Using bzrsee which files have been modifiedstatus /etc/:
  hosts
Now commit the changesnew host"on bzr see Section 1, “Bazaar” [p. 266]3
3. Byobumost usfor any system a is screen. It aexecution of
shells in one terminal. To make some of the advanced screen features more user friendly, and
provide  system, the byobuwas created.
When executing byobu presF9 key will bring up the  menu. This menu will
allow you to:
• View the Help menu
• Change Byobu's background colorforeToggle status notificationsthe key binding setescape sequencenew windows
• Manage the defaultByobu currently does not launch at login (toggle on)
Ts such things as the , , change window, etc.twos to choose from f-keys and screen-escape-keys. If you wish to use the
originals choose the none set.
byobu a menu which displays the Ubuntu release, processor, memory, and the time and date. The effect is similar to a desktop menu."" option will cause byobu to be any time  is opened. Cbyobu are on a per user basis, and will not
affect other users on the system.
One difference when usis the scrollback mode. Press the F7 key to enter
S allows you to navigate past output using vi like commands. Here is a quick list of
movement:
• h - Move the cursor left by one character
• jdown by one line
• kuplrigh0o the beginning of the current line
• $endG - Mspecified line the buffer)
• / - Search forward4
• ?backward
• nnext match, either forward or backwo5
4. man page
2
 for more optto 
• The Debian Package of the Day weather
3
 article has more details abothe weatherutility.
• See the
4
 sitedetails on using.
• T 5
 page.
• For the latest news and about bzr see the bzr
6
 web sitmoreon screenscreen
7
.
• And the screen
8ject page11debaday.debian.net/2007/10/04/weather-check-onditions-and-forecasts-on-the-command-line/kitenet.net/~joey/code
5etckeeperbazwwscreen/Screenlauncbyobu376
Appendix Appendix
377
1. Reporting Bugs inUbuntu Project attempts to release software with as few bugs as possible, they do occur.help fix these bugs by rones that you find to the project. TProject uses
1
 to track its bug reports.le a bug abouton , you
will need to create an account
2
.
1.With ubuntu-bug
The preferred way to report a bug is with the command. Ttool gathers  useful to developers in diagnoreported problem that will then
be included in the filed . Bneed to be filed against a
specificpackage, thus the napackage thatoccurs in neegiven to
: PACKAGENAME
figainst the openssh, you would dopecify binary package or the sourcefor. Again using opensshserver as an example, you could also generate the, openssh
See Chapter 3,Ma[p. 2packages incommand will gatherthe system in, possibly includingto the and then ask you whatlike to do with
collectedpostgresql
*** Collectingi
The  can be sent to theto improve the
. This might take a few minutes.
.
1
2YourAccount/NewAccount8
*** Senrepor?ereport has been sent, please fill out the form in the
opened web browser.
What would you ? Yourre:
  S: Send report (1.7 KiB)
  V: View report
  K: Keep report file for sending later or copying to somewhere else
  C: Cancel
Please choose (S/V/K/C):
Thevailable are:
• Send Report Selectingsubmits tto as part of the
the process of filing a.be given the opportunity to describe the situation that
led up to the occurrence of the bug.
*** Uploadis beingbug system.
91%
*** To continue, you must visit the fs://bugsubunt-8.4/kc6eSnTLnLxF8u0t3e56EukFeqJ?launch a browser now, or copy this URL intoon another
computer.
Choices:
  1: L1/C):
If you choose to start, by default the text bas w3m will be used to finish
filing theAlternatelcopy the given URL to a running• Viewcausebe displayed to the
terminal for review.
Package:  8.4.2-2
PackageArchitecture: all
Tags: lucid
ProblemType: Bug
ProcEnviron:
  LANG=en_US.UTF-8
  SHELL=Uname: Linux 2.6.32-16-server x86_64
Dependencies:9
  adduser 3.112ubuntu1
  base-files 5.0.0ubuntu10
  base-passwd 3.5.22
  coreutils 7.4-2ubuntu2
...
After viewing the report, youbrought back to the same menu asking
do report.
• Keep Report Filegather to be a
file. This file can thenlater report or transferred to a different Ubuntu system
for. To submit file, simply give it as an argument to the: k
Problem: /tmp/apport..v4MQas.apport...
• CancelCancel carded.
1.2.Crashes
The utility, apport, can be configured to trigger
when s crash. This is disabled, as capturing a crash can be resource intensive
depending on how much memory the that crashed was using as apport captures and
procesre dump.ing apport to capturecrashingrequires a couple of steps.
First, gdbinstalled; it is not  in.gdbmanaging ensured that gdb is, open the file /etc/default/apport in your text editor,
and change the enabled setting to be 1 like so:
# set this to 0 to disable apport, or to 1 to enable it
# you can temporarily override this with
# sapport start force_start=180
enabled=1
# set maximum core dump file size: 209715200 bytes == 200 MB)
maxsize=
completed editing, start the apport service:
sudo start apport
After a crashes, use-cli command to s the existing saved crash reportapport-cli
*** dash closed unexpectedly on 2010-03-11 at 21:40:59.ere not doing anything confidential (entering passwords or other
privatehelp to  by
reporting
the problem.R: Report Problem...
  I: Cancel and ignore future crashes of this program versionR/I/C):
 will walk you through similar steps as . One
importantce is that amarked as private when filed ,
meaning that itvisible to only a limited set of bug triagers. These will review the
data foribefore making the b publicly visible.
1.3. Resources
3
 Ubuntu wiki page.
• Also, the Apporthas some useful. Though some of it pertains to using a GUI.
3BugswikApport